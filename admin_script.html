<script>
    console.log("Admin HTML Script loaded (v13.7 - Teams Management Added).");
    
    // --- Global Variables ---
    let currentPageRecords = []; 
    let unassignedQueueData = [];
    let currentPage = 1; 
    let allHeaders = [];
    let statusChartInstance = null;
    let typeChartInstance = null; 
    let chartData = null;
    let summaryData = null;
    
    // ===== Lightbox Global Variables =====
    let currentLightboxImages = []; 
    let currentLightboxIndex = 0;      

    // ===== History Filter Variables =====
    let currentHistoryComments = ''; 
    let activeHistoryFilter = 'all'; 

    // ===== SLA Toggle Variable =====
    let showSlaWarnings = true; 
    
    // ===== Admin Upload Variables =====
    let adminFileObjects = []; 

    // ===== Translation Variables =====
    let translationHeaders = []; // Store headers to reuse during save

    // ===== NEW: Template Variables =====
    let allTemplates = []; // Store loaded templates
    let currentTargetInputId = null; // To track where to insert text
    let editingTemplateOriginalTitle = null; // Store original title for editing

    // --- Helper to safely add event listeners ---
    function safeListen(id, event, handler) {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener(event, handler);
        }
    }

    // --- 1. Main Layout Elements ---
    const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
    const menuTicketsBtn = document.getElementById('menu-tickets-btn');
    const settingsBtn = document.getElementById('settingsBtn');
    const auditLogBtn = document.getElementById('auditLogBtn'); 
    const toggleChartBtn = document.getElementById('toggleChartBtn');

    // --- 2. Views ---
    const viewDashboard = document.getElementById('view-dashboard');
    const viewTickets = document.getElementById('view-tickets');
    const settingsView = document.getElementById('settings-modal'); 
    const summarySection = document.getElementById('summarySection');

    // --- 3. UI Elements ---
    const pageLoader = document.getElementById('page-loader'); 
    const loginModal = document.getElementById('login-modal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refresh-icon');
    const refreshSpinner = document.getElementById('refresh-spinner');
    const topFilterBar = document.getElementById('top-filter-bar');
    const ticketTableBody = document.getElementById('ticket-table-body');
    const sessionExpiredModal = document.getElementById('session-expired-modal');
    const changeSelfPassBtn = document.getElementById('changeSelfPassBtn'); 

    // --- 3.1 Export Elements ---
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportIcon = document.getElementById('export-icon');
    const exportCsvSpinner = document.getElementById('export-csv-spinner');

    // --- 4. Settings Menu Elements ---
    const settingsMenuView = document.getElementById('settings-menu-view');
    const userManagementView = document.getElementById('user-management-view');
    const logoSettingsView = document.getElementById('logo-settings-view');
    const translationSettingsView = document.getElementById('translation-settings-view');
    const profanitySettingsView = document.getElementById('profanity-settings-view');
    const coreSettingsView = document.getElementById('core-settings-view');
    
    // NEW: Template & Form Config Settings Views
    const templateSettingsView = document.getElementById('template-settings-view');
    const formConfigView = document.getElementById('form-config-view');

    const menuUserBtn = document.getElementById('menu-user-management-btn');
    const menuLogoBtn = document.getElementById('menu-logo-settings-btn');
    const menuTranslationBtn = document.getElementById('menu-translation-settings-btn');
    const menuProfanityBtn = document.getElementById('menu-profanity-settings-btn');
    const menuCoreSettingsBtn = document.getElementById('menu-core-settings-btn'); 
    
    // NEW: Template & Form Config Menu Buttons
    const menuTemplateSettingsBtn = document.getElementById('menu-template-settings-btn');
    const menuFormConfigBtn = document.getElementById('menu-form-config-btn');

    // NEW: User/Teams Tabs Elements
    const tabBtnUsers = document.getElementById('tab-btn-users');
    const tabBtnTeams = document.getElementById('tab-btn-teams');
    const tabContentUsers = document.getElementById('tab-content-users');
    const tabContentTeams = document.getElementById('tab-content-teams');
    
    // NEW: Team Management Form
    const addTeamForm = document.getElementById('addTeamForm');
    const teamListDisplay = document.getElementById('team-list-display');


    // --- 5. Modal Elements ---
    const publicCommentModal = document.getElementById('public-comment-modal');
    const publicCommentForm = document.getElementById('publicCommentForm');
    const publicCommentTextarea = document.getElementById('public-comment-textarea');
    const publicCommentError = document.getElementById('public-comment-error');
    const publicCommentStatus = document.getElementById('public-comment-status');
    const publicCommentCancelBtn = document.getElementById('public-comment-cancel-btn');
    const publicCommentSubmitBtn = document.getElementById('public-comment-submit-btn');

    const detailsModal = document.getElementById('details-modal');
    const saveAllDetailsBtn = document.getElementById('save-all-details-btn');
    const detailsModalStatusSelect = document.getElementById('details-modal-status-select');
    const detailsModalNewComment = document.getElementById('details-modal-new-comment');
    const detailsModalAssignSelect = document.getElementById('details-modal-assign-select');
    // Admin File Input
    const detailsModalAdminFileInput = document.getElementById('details-modal-admin-file-input');
    const detailsModalAdminAttachmentDisplay = document.getElementById('details-modal-admin-attachment');
    const adminAttachmentWrapper = document.getElementById('admin-attachment-wrapper');
    
    // NEW: Template Picker Modal
    const templatePickerModal = document.getElementById('template-picker-modal');
    const templatePickerList = document.getElementById('template-picker-list');
    const closeTemplatePickerBtn = document.getElementById('closeTemplatePickerBtn');

    // Variables for logic
    let originalStatusOnOpen = ''; 
    let originalAssigneeOnOpen = ''; 
    let assignableUserList = []; 
    
    // User Edit Variables
    let currentUserInEditMode = '';
    let userEditModal = document.getElementById('user-edit-modal'); 
    let userEditUsernameSpan = document.getElementById('user-edit-username');
    let userEditRoleSelect = document.getElementById('user-edit-role-select');
    let userEditSaveRoleBtn = document.getElementById('user-edit-save-role-btn');
    let userEditNewPass = document.getElementById('user-edit-new-pass');
    let userEditConfirmPass = document.getElementById('user-edit-confirm-pass');
    let userEditSavePassBtn = document.getElementById('user-edit-save-pass-btn');
    let userEditDeleteBtn = document.getElementById('user-edit-delete-btn');
    
    // User Status Toggle
    const userEditStatusToggle = document.getElementById('user-edit-status-toggle');
    const userStatusLabel = document.getElementById('user-status-label');
    
    // User Team Edit
    const userEditTeamInput = document.getElementById('user-edit-team-input');
    const userEditSaveTeamBtn = document.getElementById('user-edit-save-team-btn');

    // User Data Access Edit
    const userEditSaveAccessBtn = document.getElementById('user-edit-save-access-btn');

    // Forms
    const addUserForm = document.getElementById('addUserForm');
    const userListContainer = document.getElementById('user-list-container');
    const userError = document.getElementById('user-error');
    const logoForm = document.getElementById('logoForm');
    const logoUrlInput = document.getElementById('logoUrl');
    
    const logoPreview = document.getElementById('logo-preview');
    const logoPlaceholder = document.getElementById('logo-placeholder');
    
    const logoSuccess = document.getElementById('logo-success');
    const changePasswordModal = document.getElementById('change-password-modal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const changePassSuccess = document.getElementById('change-pass-success');
    const changePassError = document.getElementById('change-pass-error');
    const translationForm = document.getElementById('translationForm');
    const translationSuccess = document.getElementById('translation-success');
    const translationContainer = document.getElementById('translation-table-container');
    const profanityForm = document.getElementById('profanityForm');
    const profanityListDisplay = document.getElementById('profanity-list-display');
    const newProfanityWordInput = document.getElementById('newProfanityWord');
    const profanitySuccess = document.getElementById('profanity-success');
    const profanityError = document.getElementById('profanity-error');
    const coreSettingsForm = document.getElementById('coreSettingsForm');
    const coreEmailInput = document.getElementById('coreEmailInput');
    const coreSettingsSuccess = document.getElementById('core-settings-success');
    
    // NEW: Template Settings Form
    const addTemplateForm = document.getElementById('addTemplateForm');
    const templateListDisplay = document.getElementById('template-list-display');
    const cancelTemplateEditBtn = document.getElementById('cancelTemplateEditBtn');

    // Audit Log & Delete
    const auditLogModal = document.getElementById('audit-log-modal');
    const auditLogDisplayContainer = document.getElementById('audit-log-display-container');
    const auditLogLoading = document.getElementById('audit-log-loading');
    const auditLogTable = document.getElementById('audit-log-table');
    const auditLogTableBody = document.getElementById('audit-log-table-body');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const userToDeleteSpan = document.getElementById('user-to-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    // Toast
    const toastNotification = document.getElementById('toast-notification');
    const toastMessage = document.getElementById('toast-message');
    let toastTimer = null;

    // ===== LIGHTBOX COMPONENT =====
    const lightboxHtml = `
        <div id="lightbox-modal" class="hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-md flex items-center justify-center transition-opacity duration-300 select-none">
            <button id="lightbox-close" class="absolute top-4 right-4 text-white/70 hover:text-white z-[80] transition-colors p-2 rounded-full hover:bg-white/10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-[80] p-4 rounded-full hover:bg-white/10 transition-all hidden">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-[80] p-4 rounded-full hover:bg-white/10 transition-all hidden">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
            <div class="relative w-full h-full flex items-center justify-center p-4">
                <img id="lightbox-image" src="" alt="Full Preview" class="max-w-full max-h-full object-contain rounded shadow-2xl transition-transform duration-300 scale-95 opacity-0">
            </div>
            <div class="absolute bottom-6 left-0 right-0 flex flex-col items-center gap-3 z-[80] pointer-events-none">
                <span id="lightbox-counter" class="text-white/80 text-sm font-medium bg-black/50 px-3 py-1 rounded-full backdrop-blur-sm"></span>
                <a id="lightbox-download" href="#" target="_blank" class="pointer-events-auto bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-full backdrop-blur-md border border-white/20 flex items-center gap-2 transition-all font-medium text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ดาวน์โหลดไฟล์ต้นฉบับ
                </a>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', lightboxHtml);
    
    const lightboxModal = document.getElementById('lightbox-modal');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxPrev = document.getElementById('lightbox-prev');
    const lightboxNext = document.getElementById('lightbox-next');
    const lightboxCounter = document.getElementById('lightbox-counter');
    const lightboxDownload = document.getElementById('lightbox-download');

    // --- Helper Functions ---
    function showPageLoader(isLoading) {
        if (pageLoader) pageLoader.classList.toggle('hidden', !isLoading);
    }

    function getSessionToken() {
      return sessionStorage.getItem('sessionToken');
    }
    
    // ... (resizeImage, linkify, updateSidebarProfile functions remain unchanged) ...
    // --- Image Resize Function (Client-Side Compression) ---
    function resizeImage(file, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve({
                        base64: dataUrl.split(',')[1],
                        mimeType: 'image/jpeg',
                        fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg"
                    });
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // ===== LINKIFY HELPER FUNCTION =====
    function linkify(text) {
        if (!text) return '';
        // 1. Escape HTML first to prevent XSS (Security)
        let escapedText = escapeHtml(text);
        
        // 2. Regex to find URLs (starting with http://, https://, or ftp://)
        // Matches typical URL characters. 
        const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
        
        // 3. Replace with <a> tags
        return escapedText.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 underline decoration-indigo-300 break-all transition-colors">${url}</a>`;
        });
    }
    
    // ===== DYNAMIC USER AVATAR LOGIC =====
    function updateSidebarProfile(username, role) {
        const usernameEl = document.getElementById('logged-in-username');
        const roleEl = document.getElementById('logged-in-role');
        const avatarContainer = document.getElementById('sidebar-user-avatar');

        if (usernameEl) usernameEl.textContent = username;
        if (roleEl) roleEl.textContent = role || 'User';

        if (avatarContainer && username) {
            const icons = [
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>`
            ];

            const colors = [
                { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-100' },
                { bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-100' },
                { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100' },
                { bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-100' },
                { bg: 'bg-cyan-50', text: 'text-cyan-600', border: 'border-cyan-100' },
                { bg: 'bg-fuchsia-50', text: 'text-fuchsia-600', border: 'border-fuchsia-100' }
            ];

            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const iconIndex = Math.abs(hash) % icons.length;
            const colorIndex = Math.abs(hash) % colors.length;
            
            const selectedIcon = icons[iconIndex];
            const selectedColor = colors[colorIndex];

            avatarContainer.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-sm text-sm transition-transform hover:scale-110 duration-200 border-2 ${selectedColor.bg} ${selectedColor.text} ${selectedColor.border}`;
            avatarContainer.innerHTML = selectedIcon;
        }
    }


    function loadSettingsData() {
        const userRole = sessionStorage.getItem('userRole');
        const token = getSessionToken();

        if (userRole === 'Admin') {
            if(menuUserBtn) menuUserBtn.classList.remove('hidden');
            if(menuCoreSettingsBtn) menuCoreSettingsBtn.classList.remove('hidden');
            google.script.run.withSuccessHandler(onUserLoadSuccess).getUsers(token); 
            google.script.run.withSuccessHandler(displayCoreSettings).getCoreSettings(token);
        } else {
            if(menuUserBtn) menuUserBtn.classList.add('hidden');
            if(menuCoreSettingsBtn) menuCoreSettingsBtn.classList.add('hidden');
        }

        google.script.run.withSuccessHandler(displayLogoUrl).getLogo(); 
        google.script.run.withSuccessHandler(displayTranslations).getAllTranslationsForAdmin(token);
        google.script.run.withSuccessHandler(displayProfanityList).getProfanityList(); 
        
        // Load Team List for Datalist
        loadTeamList();

        // NEW: Load Templates for Picker
        loadTemplateSettings();
        
        // NEW: Load Form Config (if Admin)
        if (userRole === 'Admin') {
            loadFormConfig();
        }
    }
    
    // ===== START: FORM CONFIG FUNCTIONS =====
    function loadFormConfig() {
        const token = getSessionToken();
        if(!token) return;

        // Lock inputs while loading
        const toggles = ['toggle-complaint', 'toggle-suggestion', 'toggle-report'];
        toggles.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = true;
        });
        
        google.script.run
            .withSuccessHandler(config => {
                if(config) {
                    const complaintToggle = document.getElementById('toggle-complaint');
                    const suggestionToggle = document.getElementById('toggle-suggestion');
                    const reportToggle = document.getElementById('toggle-report');
                    
                    if(complaintToggle) {
                        complaintToggle.checked = config.enableComplaint !== false; 
                        complaintToggle.disabled = false; // Unlock
                    }
                    if(suggestionToggle) {
                        suggestionToggle.checked = config.enableSuggestion !== false; 
                        suggestionToggle.disabled = false; // Unlock
                    }
                    if(reportToggle) {
                        reportToggle.checked = config.enableReport !== false; 
                        reportToggle.disabled = false; // Unlock
                    }
                }
            })
            .withFailureHandler(err => console.error("Failed to load form config:", err))
            .getFormConfig(); // Server function (Publicly accessible but read-only is fine, save requires admin)
    }

    function handleSaveFormConfig() {
        const complaintToggle = document.getElementById('toggle-complaint');
        const suggestionToggle = document.getElementById('toggle-suggestion');
        const reportToggle = document.getElementById('toggle-report');
        const successMsg = document.getElementById('form-config-success');
        
        const config = {
            enableComplaint: complaintToggle ? complaintToggle.checked : true,
            enableSuggestion: suggestionToggle ? suggestionToggle.checked : true,
            enableReport: reportToggle ? reportToggle.checked : true
        };
        
        setSaveLoading('saveFormConfigBtn', true);
        if(successMsg) successMsg.classList.add('hidden');
        
        google.script.run
            .withSuccessHandler(res => {
                setSaveLoading('saveFormConfigBtn', false);
                if(checkAuth(res)) {
                    if(res.success) {
                        if(successMsg) {
                            successMsg.classList.remove('hidden');
                            setTimeout(() => successMsg.classList.add('hidden'), 3000);
                        }
                    } else {
                        alert("Error saving config: " + res.error);
                    }
                }
            })
            .withFailureHandler(err => {
                setSaveLoading('saveFormConfigBtn', false);
                alert("Error: " + err);
            })
            .saveFormConfig(getSessionToken(), config);
    }
    // ===== END: FORM CONFIG FUNCTIONS =====
    
    // ===== START: NEW FUNCTIONS FOR DYNAMIC TEAM LIST =====
    function loadTeamList() {
         const token = getSessionToken();
         if(token) {
             google.script.run.withSuccessHandler(updateTeamDatalist).getAllUniqueTeams(token);
         }
    }

    function updateTeamDatalist(teams) {
        const datalist = document.getElementById('teamList');
        if (!datalist) return;
        datalist.innerHTML = ''; // Clear existing
        if (teams && Array.isArray(teams)) {
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                datalist.appendChild(option);
            });
        }
    }
    // ===== END: NEW FUNCTIONS FOR DYNAMIC TEAM LIST =====

    // ===== START: NEW FUNCTIONS FOR TEMPLATES =====
    function loadTemplateSettings() {
        const token = getSessionToken();
        if (token) {
            google.script.run
                .withSuccessHandler(onTemplatesLoad)
                .withFailureHandler(err => console.error("Template load error:", err))
                .getTemplates(token);
        }
    }

    function onTemplatesLoad(response) {
        if (checkAuth(response)) {
             allTemplates = response.data || [];
             renderTemplateList(allTemplates);
        }
    }

    function renderTemplateList(templates) {
        if (!templateListDisplay) return;
        templateListDisplay.innerHTML = '';

        if (!templates || templates.length === 0) {
            templateListDisplay.innerHTML = '<div class="text-center py-6 text-slate-400 italic text-sm">ยังไม่มีข้อความตอบกลับสำเร็จรูป</div>';
            return;
        }

        templates.forEach(t => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg hover:border-pink-200 transition-colors shadow-sm group';
            div.innerHTML = `
                <div class="flex-1 min-w-0 pr-3">
                    <p class="font-bold text-slate-700 text-base leading-normal mb-1">${escapeHtml(t.title)}</p>
                    <p class="text-sm text-slate-500 leading-relaxed break-words">${escapeHtml(t.message)}</p>
                </div>
                <div class="flex items-center gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                    <button class="p-1.5 text-slate-400 hover:text-indigo-500 rounded hover:bg-indigo-50" onclick="fillTemplateForm('${escapeHtml(t.title)}', '${escapeHtml(t.message)}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                    <button class="p-1.5 text-slate-400 hover:text-rose-500 rounded hover:bg-rose-50" onclick="handleDeleteTemplate('${escapeHtml(t.title)}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            templateListDisplay.appendChild(div);
        });
    }

    // ===== UPDATED: Fill Template Form logic =====
    function fillTemplateForm(title, message) {
        document.getElementById('newTemplateTitle').value = title;
        document.getElementById('newTemplateMessage').value = message;
        editingTemplateOriginalTitle = title; // Track original title
        
        // Show cancel button
        if(cancelTemplateEditBtn) cancelTemplateEditBtn.classList.remove('hidden');

        // Change submit button text
        const submitBtnContent = document.querySelector('#templateSaveBtn .btn-content');
        if(submitBtnContent) submitBtnContent.textContent = 'บันทึกแก้ไข';
        
        // Change submit button style
        const submitBtn = document.getElementById('templateSaveBtn');
        if(submitBtn) {
            submitBtn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
            submitBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
        }
    }
    
    // ===== UPDATED: Reset Template Form logic =====
    function resetTemplateForm() {
        document.getElementById('newTemplateTitle').value = '';
        document.getElementById('newTemplateMessage').value = '';
        editingTemplateOriginalTitle = null;
        
        // Hide cancel button
        if(cancelTemplateEditBtn) cancelTemplateEditBtn.classList.add('hidden');

        // Reset submit button text
        const submitBtnContent = document.querySelector('#templateSaveBtn .btn-content');
        if(submitBtnContent) submitBtnContent.textContent = 'เพิ่มรายการ';
        
        // Reset submit button style
        const submitBtn = document.getElementById('templateSaveBtn');
        if(submitBtn) {
            submitBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            submitBtn.classList.add('bg-pink-500', 'hover:bg-pink-600');
        }
    }

    function handleDeleteTemplate(title) {
        if (!confirm(`ต้องการลบข้อความ "${title}" ใช่หรือไม่?`)) return;
        
        google.script.run
            .withSuccessHandler(res => {
                 if (res.success) {
                     showToast('ลบเรียบร้อย');
                     // Reset form if we deleted the item being edited
                     if (editingTemplateOriginalTitle === title) {
                         resetTemplateForm();
                     }
                     loadTemplateSettings();
                 } else {
                     alert("Error: " + res.error);
                 }
            })
            .withFailureHandler(err => alert("Error: " + err))
            .deleteTemplate(getSessionToken(), title);
    }
    
    // --- Picker Logic ---
    function openTemplatePicker(targetId) {
        if (allTemplates.length === 0) {
            // Try fetch if empty (lazy load attempt)
             google.script.run.withSuccessHandler(res => {
                 if(res.success) allTemplates = res.data;
                 renderTemplatePickerItems();
             }).getTemplates(getSessionToken());
        }
        
        renderTemplatePickerItems();
        currentTargetInputId = targetId;
        templatePickerModal.classList.remove('hidden');
    }

    function renderTemplatePickerItems() {
        if (!templatePickerList) return;
        templatePickerList.innerHTML = '';
        
        if (allTemplates.length === 0) {
            templatePickerList.innerHTML = '<div class="text-center p-4 text-slate-400 text-sm">ไม่มีข้อมูล (ไปที่ Settings > Templates เพื่อเพิ่ม)</div>';
            return;
        }

        allTemplates.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left p-3 hover:bg-pink-50 rounded-lg group transition-colors border border-transparent hover:border-pink-100 mb-1';
            btn.innerHTML = `
                <p class="font-bold text-slate-700 text-base group-hover:text-pink-600 leading-normal">${escapeHtml(t.title)}</p>
                <p class="text-sm text-slate-500 leading-relaxed mt-1 break-words">${escapeHtml(t.message)}</p>
            `;
            btn.onclick = () => insertTemplate(t.message);
            templatePickerList.appendChild(btn);
        });
    }

    function insertTemplate(text) {
        if (!currentTargetInputId) return;
        const input = document.getElementById(currentTargetInputId);
        if (input) {
            // Insert at cursor position or append
            const startPos = input.selectionStart;
            const endPos = input.selectionEnd;
            const currentValue = input.value;
            
            if (startPos || startPos == '0') {
                 input.value = currentValue.substring(0, startPos) + text + currentValue.substring(endPos, currentValue.length);
                 // Move cursor to end of inserted text
                 input.selectionStart = startPos + text.length;
                 input.selectionEnd = startPos + text.length;
            } else {
                 input.value += text;
            }
            
            // Trigger input event to enable save buttons if needed
            input.dispatchEvent(new Event('input'));
        }
        templatePickerModal.classList.add('hidden');
        currentTargetInputId = null;
    }
    // ===== END: NEW FUNCTIONS FOR TEMPLATES =====

    function updateStatusLabelUI(isActive) {
        if (!userStatusLabel) return;
        if(isActive) {
            userStatusLabel.textContent = 'Active';
            userStatusLabel.className = 'font-bold text-green-600';
        } else {
            userStatusLabel.textContent = 'Inactive';
            userStatusLabel.className = 'font-bold text-slate-400';
        }
    }

    function closeSessionExpiredModal() {
        if(sessionExpiredModal) sessionExpiredModal.classList.add('hidden');
        sessionStorage.removeItem('sessionToken');
        sessionStorage.removeItem('userRole');
        sessionStorage.removeItem('admin_session_username');
        if(document.getElementById('username')) document.getElementById('username').value = '';
        if(document.getElementById('password')) document.getElementById('password').value = '';
        if(loginForm) loginForm.reset();
        showLogin();
    }

    function checkAuth(response, errorElement) {
      if (response && response.error && response.error.includes("Authentication failed")) {
          if(sessionExpiredModal) sessionExpiredModal.classList.remove('hidden');
          return false; 
      }
      if (response && response.error) {
           const errorMsg = 'Server Error: ' + response.error;
           console.error(errorMsg); 
           if(errorElement) {
              errorElement.textContent = errorMsg;
              errorElement.classList.remove('hidden');
           } else {
              alert(errorMsg);
           }
           return false; 
      }
      if (response && typeof response.success !== 'undefined' && !response.success) {
           const infoMsg = response.message || 'An unknown operation failed.';
           console.warn("Operation failed:", infoMsg); 
           if(errorElement) {
              errorElement.textContent = infoMsg;
              errorElement.classList.remove('hidden');
           } else {
              alert('Info: ' + infoMsg); 
           }
           return false; 
      }
      return true;
    }

    function onUserLoadSuccess(data) {
       if(checkAuth(data, userError)) { 
        displayUsers(data); 
       }
    }

    function setRefreshLoading(isLoading) {
        if(refreshBtn) refreshBtn.disabled = isLoading;
        if(refreshIcon) refreshIcon.classList.toggle('hidden', isLoading);
        if(refreshSpinner) refreshSpinner.classList.toggle('hidden', !isLoading);
    }

    // --- DOM CONTENT LOADED ---
    document.addEventListener('DOMContentLoaded', () => {
        if (getSessionToken()) {
            showDashboard(); 
        } else {
            showLogin();
        }
        
        // ===== NEW: AUTO-REFRESH LOGIC (Every 60 Seconds) =====
        setInterval(() => {
             const isAnyModalOpen = !loginModal.classList.contains('hidden') || 
                                    (detailsModal && !detailsModal.classList.contains('hidden')) || 
                                    (userEditModal && !userEditModal.classList.contains('hidden')) ||
                                    (settingsView && !settingsView.classList.contains('hidden')) || 
                                    (publicCommentModal && !publicCommentModal.classList.contains('hidden')) ||
                                    (changePasswordModal && !changePasswordModal.classList.contains('hidden'));

             const token = getSessionToken();
             
             if (token && !isAnyModalOpen) {
                 console.log("Auto-refreshing data...");
                 fetchAdminData(true); 
             }
        }, 600000); 

        // ===== ADMIN FILE UPLOAD HANDLER =====
        if (detailsModalAdminFileInput) {
            detailsModalAdminFileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                const filePromises = Array.from(files).map(file => {
                     if (file.type.startsWith('image/')) {
                         return resizeImage(file, 0.90);
                     } else {
                         // PDF or others
                         return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (ev) => resolve({
                                base64: ev.target.result.split(',')[1],
                                mimeType: file.type,
                                fileName: file.name
                            });
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                     }
                });
                
                try {
                    const processedFiles = await Promise.all(filePromises);
                    // Append to global array (allow multiple batches)
                    adminFileObjects = adminFileObjects.concat(processedFiles);
                } catch (err) {
                    alert("Error processing admin files: " + err);
                }
            });
        }

        safeListen('close-user-edit-modal', 'click', () => { if(userEditModal) userEditModal.classList.add('hidden'); });
        if (userEditModal) {
            userEditModal.addEventListener('click', (e) => {
                if (e.target === userEditModal) {
                    userEditModal.classList.add('hidden');
                }
            });
        }
        
        safeListen('user-edit-save-role-btn', 'click', handleUserEditSaveRole);
        safeListen('user-edit-save-pass-btn', 'click', handleUserEditSavePass);
        safeListen('user-edit-delete-btn', 'click', handleDeleteUserClick);
        safeListen('user-edit-save-team-btn', 'click', handleUserEditSaveTeam);
        safeListen('user-edit-save-access-btn', 'click', handleUserEditSaveAccess); 
        
        if (userEditStatusToggle) {
            userEditStatusToggle.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                const newStatus = isChecked ? 'Active' : 'Inactive';
                updateStatusLabelUI(isChecked);
                google.script.run
                    .withSuccessHandler((res) => {
                        if (res.success) {
                            showToast(`สถานะของ ${currentUserInEditMode} เปลี่ยนเป็น ${newStatus}`);
                            loadSettingsData(); 
                        } else {
                            alert('Failed to update status: ' + res.error);
                            e.target.checked = !isChecked;
                            updateStatusLabelUI(!isChecked);
                        }
                    })
                    .withFailureHandler((err) => {
                        alert('Error: ' + err.message);
                        e.target.checked = !isChecked;
                        updateStatusLabelUI(!isChecked);
                    })
                    .updateUserStatus(getSessionToken(), currentUserInEditMode, newStatus);
            });
        }

        if (lightboxClose) {
            lightboxClose.addEventListener('click', () => {
                lightboxModal.classList.add('hidden');
                lightboxImage.classList.remove('scale-100', 'opacity-100');
                lightboxImage.classList.add('scale-95', 'opacity-0');
            });
        }
        if (lightboxModal) {
            lightboxModal.addEventListener('click', (e) => {
                if (e.target === lightboxModal) {
                    lightboxClose.click();
                }
            });
        }
        if (lightboxPrev) lightboxPrev.addEventListener('click', (e) => { e.stopPropagation(); navigateLightbox(-1); });
        if (lightboxNext) lightboxNext.addEventListener('click', (e) => { e.stopPropagation(); navigateLightbox(1); });
        
        document.addEventListener('keydown', (e) => {
            if (lightboxModal && !lightboxModal.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
                if (e.key === 'Escape') lightboxClose.click();
            }
        });

        const slaToggle = document.getElementById('slaToggleInput');
        const savedSlaPref = localStorage.getItem('admin_show_sla');
        if (savedSlaPref !== null) showSlaWarnings = (savedSlaPref === 'true');
        
        if (slaToggle) {
            slaToggle.checked = showSlaWarnings;
            slaToggle.addEventListener('change', (e) => {
                showSlaWarnings = e.target.checked;
                localStorage.setItem('admin_show_sla', showSlaWarnings);
                if (currentPageRecords && currentPageRecords.length > 0) renderTicketTable(currentPageRecords);
                fetchAdminData(true);
                showToast(showSlaWarnings ? 'เปิดการแจ้งเตือน SLA แล้ว' : 'ปิดการแจ้งเตือน SLA แล้ว');
            });
        }

        safeListen('menu-dashboard-btn', 'click', () => setActiveView('dashboard'));
        safeListen('menu-tickets-btn', 'click', () => setActiveView('tickets'));
        safeListen('settingsBtn', 'click', () => {
            setActiveView('settings');
            loadSettingsData();
        });

        safeListen('session-expired-ok-btn', 'click', closeSessionExpiredModal);
        // ADDED: Modified logic to split input
        safeListen('addProfanityWordBtn', 'click', addProfanityWordTag);
        
        if(newProfanityWordInput) {
            newProfanityWordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addProfanityWordTag();
                }
            });
        }

        safeListen('save-all-details-btn', 'click', handleSaveAllDetails);
        
        if (publicCommentForm) publicCommentForm.addEventListener('submit', handleSubmitPublicComment);
        
        safeListen('public-comment-cancel-btn', 'click', () => {
            if(publicCommentModal) publicCommentModal.classList.add('hidden');
            if(saveAllDetailsBtn) saveAllDetailsBtn.disabled = false;
            
            // Clear Admin Uploads on cancel
            adminFileObjects = [];
            if(detailsModalAdminFileInput) detailsModalAdminFileInput.value = '';
        });

        safeListen('auditLogBtn', 'click', handleOpenAuditLog);
        safeListen('close-audit-log-modal-btn', 'click', () => {
            if(auditLogModal) auditLogModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        if (auditLogModal) {
            auditLogModal.addEventListener('click', (e) => {
                if (e.target === auditLogModal) {
                    auditLogModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }
            });
        }

        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.classList.remove('bg-slate-50', 'border-none', 'text-slate-600', 'placeholder-slate-400');
            searchInput.classList.add('bg-white', 'border', 'border-indigo-200', 'text-indigo-700', 'placeholder-indigo-300', 'focus:border-indigo-500', 'focus:ring-1', 'focus:ring-indigo-500', 'shadow-sm');
            
            let searchDebounceTimer; 
            searchInput.addEventListener('input', () => {
                if(searchInput.value.length > 0) setActiveView('tickets');
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => { applyFilters(); }, 500); 
            });
        }

        safeListen('typeFilter', 'change', applyFilters);
        safeListen('statusFilter', 'change', applyFilters);
        safeListen('teamFilter', 'change', applyFilters); 

        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateRangeDisplay = document.getElementById('date-range-display');
        const dateRangeModal = document.getElementById('date-range-modal');
        
        if (dateRangeFilter) {
            dateRangeFilter.addEventListener('change', () => {
                if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
                if (dateRangeFilter.value === 'custom') {
                    if (dateRangeModal) dateRangeModal.classList.remove('hidden');
                } else {
                    applyFilters();
                }
            });
        }

        safeListen('date-range-apply-btn', 'click', () => {
            if (dateRangeModal) dateRangeModal.classList.add('hidden');
            const dateStartInput = document.getElementById('dateStartInput');
            const dateEndInput = document.getElementById('dateEndInput');
            
            if (dateRangeDisplay && dateStartInput && dateEndInput) {
                const start = formatDateForDisplay(dateStartInput.value);
                const end = formatDateForDisplay(dateEndInput.value);
                if (start && end) {
                    dateRangeDisplay.textContent = `(${start} - ${end})`;
                    dateRangeDisplay.classList.remove('hidden');
                } else {
                    dateRangeDisplay.classList.add('hidden');
                }
            }
            applyFilters();
        });

        safeListen('date-range-cancel-btn', 'click', () => {
            if (dateRangeModal) dateRangeModal.classList.add('hidden');
            if (dateRangeFilter) dateRangeFilter.value = 'all';
            if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
            applyFilters();
        });
        
        safeListen('date-range-close-btn', 'click', () => {
            if (dateRangeModal) dateRangeModal.classList.add('hidden');
            if (dateRangeFilter) dateRangeFilter.value = 'all'; 
            if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
            applyFilters();
        });
        
        if (dateRangeModal) {
            dateRangeModal.addEventListener('click', (e) => {
                if (e.target === dateRangeModal) { 
                    dateRangeModal.classList.add('hidden');
                    if (dateRangeFilter) dateRangeFilter.value = 'all';
                    if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
                    applyFilters();
                }
            });
        }
        
        safeListen('clearDateFilterBtn', 'click', () => {
            if (dateRangeFilter) dateRangeFilter.value = 'all';
            const dateStartInput = document.getElementById('dateStartInput');
            const dateEndInput = document.getElementById('dateEndInput');
            if (dateStartInput) dateStartInput.value = '';
            if (dateEndInput) dateEndInput.value = '';
            if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
            applyFilters();
        });

        safeListen('print-details-btn', 'click', handlePrintTicket);
        // FIX: Remove checking "if (exportCsvBtn)" and use direct ID since we declared it globally
        if (exportCsvBtn) {
             exportCsvBtn.addEventListener('click', handleExportCSV);
        }
        
        safeListen('refreshBtn', 'click', () => fetchAdminData(true));
        safeListen('toggleChartBtn', 'click', () => {
             if (!viewDashboard.classList.contains('hidden')) {
                 fetchAdminData(true);
            } else {
                setActiveView('dashboard');
            }
        });
        
        safeListen('close-settings-modal-btn', 'click', () => setActiveView('dashboard'));
        
        // NEW: Self Change Password Listener
        if(changeSelfPassBtn) {
            changeSelfPassBtn.addEventListener('click', () => {
                const currentUser = sessionStorage.getItem('admin_session_username');
                if (currentUser) {
                    openChangePasswordModal(currentUser);
                }
            });
        }
        
        if(addUserForm) {
            addUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if(userError) userError.classList.add('hidden');
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const role = document.getElementById('newRole').value;
                const team = document.getElementById('newTeam').value; 
                
                if (username && password && role) {
                    google.script.run.withSuccessHandler(onUserAddSuccess).addUser(getSessionToken(), {username, password, role, team}); 
                    addUserForm.reset();
                } else if (!role) {
                    if(userError) {
                        userError.textContent = 'กรุณาเลือก Role';
                        userError.classList.remove('hidden');
                    }
                }
            });
        }

        if(logoForm) {
            logoForm.addEventListener('submit', e => {
                e.preventDefault();
                setSaveLoading('logoSaveBtn', true);
                if(logoSuccess) logoSuccess.classList.add('hidden');
                google.script.run
                    .withSuccessHandler(onDataSaveSuccess('logoSaveBtn', logoSuccess))
                    .withFailureHandler(onDataSaveFailure('logoSaveBtn'))
                    .saveLogo(getSessionToken(), logoUrlInput.value);
            });
        }
        
        // NEW: Template Form Listener
        if(addTemplateForm) {
             addTemplateForm.addEventListener('submit', e => {
                 e.preventDefault();
                 const title = document.getElementById('newTemplateTitle').value.trim();
                 const message = document.getElementById('newTemplateMessage').value.trim();
                 
                 if (!title || !message) return;
                 
                 // Show loading state
                 setSaveLoading('templateSaveBtn', true);
                 
                 google.script.run
                     .withSuccessHandler(res => {
                         // Reset loading state
                         setSaveLoading('templateSaveBtn', false);
                         
                         if (res.success) {
                             showToast(editingTemplateOriginalTitle ? 'บันทึกแก้ไขเรียบร้อย' : 'เพิ่ม Template เรียบร้อย');
                             resetTemplateForm();
                             loadTemplateSettings();
                         } else {
                             alert("Error: " + res.error);
                         }
                     })
                     .withFailureHandler(err => {
                         // Reset loading state on error
                         setSaveLoading('templateSaveBtn', false);
                         alert("Error: " + err);
                     })
                     .saveTemplate(getSessionToken(), { 
                         originalTitle: editingTemplateOriginalTitle,
                         title: title, 
                         message: message 
                     });
             });
        }
        
        // NEW: Cancel Template Edit Listener
        if(cancelTemplateEditBtn) {
             cancelTemplateEditBtn.addEventListener('click', resetTemplateForm);
        }
        
        // NEW: Form Config Button Listener
        safeListen('menu-form-config-btn', 'click', () => {
            showSettingsView(formConfigView);
            loadFormConfig();
        });
        // NEW: Save Form Config Button Listener
        safeListen('saveFormConfigBtn', 'click', handleSaveFormConfig);

        // ===== UPDATED: TRANSLATION FORM SUBMIT LOGIC =====
        if(translationForm) {
            translationForm.addEventListener('submit', e => {
                e.preventDefault();
                setSaveLoading('translationSaveBtn', true);
                if(translationSuccess) translationSuccess.classList.add('hidden');
                
                const tableContainer = document.getElementById('translation-table-container');
                if (!tableContainer) {
                    setSaveLoading('translationSaveBtn', false);
                    return;
                }
                
                const data = [];
                // Push Headers (stored globally)
                data.push(translationHeaders);
                
                // Collect data from all groups
                const allRows = tableContainer.querySelectorAll('tbody tr');
                
                allRows.forEach(row => {
                    const keyInput = row.querySelector('input[name="key"]');
                    const descInput = row.querySelector('input[name="desc"]');
                    
                    if (!keyInput) return;
                    
                    const rowData = [keyInput.value, descInput ? descInput.value : ''];
                    
                    const textareas = row.querySelectorAll('textarea');
                    textareas.forEach(input => {
                        rowData.push(input.value);
                    });
                    
                    data.push(rowData);
                });

                google.script.run
                    .withSuccessHandler(onDataSaveSuccess('translationSaveBtn', translationSuccess))
                    .withFailureHandler(onDataSaveFailure('translationSaveBtn'))
                    .saveAllTranslations(getSessionToken(), data);
            });
        }
        // ===== END UPDATED TRANSLATION FORM SUBMIT LOGIC =====

        if(profanityForm) {
            profanityForm.addEventListener('submit', e => {
                e.preventDefault();
                setSaveLoading('profanitySaveBtn', true);
                if(profanitySuccess) profanitySuccess.classList.add('hidden');
                if(profanityError) profanityError.classList.add('hidden');
                const words = Array.from(profanityListDisplay.querySelectorAll('.profanity-tag span'))
                                     .map(span => span.textContent.trim())
                                     .filter(word => word); 
                google.script.run
                    .withSuccessHandler(onDataSaveSuccess('profanitySaveBtn', profanitySuccess, profanityError))
                    .withFailureHandler(onDataSaveFailure('profanitySaveBtn', profanityError))
                    .saveProfanityList(getSessionToken(), words);
            });
        }

        if(coreSettingsForm) {
            coreSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                setSaveLoading('coreSettingsSaveBtn', true);
                if(coreSettingsSuccess) coreSettingsSuccess.classList.add('hidden');
                const settings = { email: coreEmailInput.value };
                google.script.run
                    .withSuccessHandler(onDataSaveSuccess('coreSettingsSaveBtn', coreSettingsSuccess, document.getElementById('core-settings-error')))
                    .withFailureHandler(onDataSaveFailure('coreSettingsSaveBtn', document.getElementById('core-settings-error')))
                    .saveCoreSettings(getSessionToken(), settings);
            });
        }

        if (logoUrlInput) logoUrlInput.addEventListener('input', updateLogoPreview);

        safeListen('menu-user-management-btn', 'click', () => showSettingsView(userManagementView));
        safeListen('menu-logo-settings-btn', 'click', () => showSettingsView(logoSettingsView));
        safeListen('menu-translation-settings-btn', 'click', () => showSettingsView(translationSettingsView));
        safeListen('menu-profanity-settings-btn', 'click', () => showSettingsView(profanitySettingsView));
        safeListen('menu-core-settings-btn', 'click', () => showSettingsView(coreSettingsView));
        // safeListen('menu-display-settings-btn', 'click', () => showSettingsView(displaySettingsView)); // Removed
        
        safeListen('menu-template-settings-btn', 'click', () => {
             showSettingsView(templateSettingsView);
             loadTemplateSettings();
        });

        const backButtons = document.querySelectorAll('.back-to-menu');
        backButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                showSettingsView(settingsMenuView);
            });
        });

        safeListen('closeChangePassModal', 'click', () => { if(changePasswordModal) changePasswordModal.classList.add('hidden'); });
        if(changePasswordModal) {
            changePasswordModal.addEventListener('click', (e) => {
                if(e.target.id === 'change-password-modal') changePasswordModal.classList.add('hidden');
            });
        }

        if(changePasswordForm) {
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                setChangePassLoading(true);
                changePassSuccess.classList.add('hidden');
                changePassError.classList.add('hidden');

                const username = document.getElementById('usernameToChange').value;
                const newPassword = document.getElementById('changePassNewPassword').value;
                const confirmPassword = document.getElementById('changePassConfirmPassword').value;

                if (newPassword !== confirmPassword) {
                    changePassError.textContent = 'รหัสผ่านใหม่ไม่ตรงกัน';
                    changePassError.classList.remove('hidden');
                    setChangePassLoading(false);
                    return;
                }
                 if (newPassword.length < 6) {
                     changePassError.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                     changePassError.classList.remove('hidden');
                     setChangePassLoading(false);
                     return;
                 }

                google.script.run
                    .withSuccessHandler((response) => {
                        setChangePassLoading(false);
                        if(checkAuth(response, changePassError)) {
                            if (response.success) {
                                changePassSuccess.textContent = 'เปลี่ยนรหัสผ่านสำเร็จ!';
                                changePassSuccess.classList.remove('hidden');
                                changePasswordForm.reset();
                                setTimeout(() => {
                                    changePassSuccess.classList.add('hidden');
                                    changePasswordModal.classList.add('hidden');
                                }, 2000);
                            }
                        }
                    })
                    .withFailureHandler((error) => {
                        setChangePassLoading(false);
                        changePassError.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
                        changePassError.classList.remove('hidden');
                    })
                    .changePassword(getSessionToken(), username, newPassword);
            });
        }

        if(loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                setLoginLoading(true);
                loginError.classList.add('hidden');
                const credentials = {
                    username: loginForm.username.value,
                    password: loginForm.password.value,
                };
                try {
                    google.script.run
                        .withSuccessHandler(onLoginSuccess)
                        .withFailureHandler(onLoginFailure)
                        .checkLogin(credentials);
                } catch (runError) {
                    onLoginFailure({ message: "Client-side error calling server: " + runError.message });
                }
            });
        }

        safeListen('logoutBtn', 'click', () => {
            const token = getSessionToken();
            if (token) {
                google.script.run.logout(token); 
            }
            sessionStorage.removeItem('sessionToken');
            sessionStorage.removeItem('userRole'); 
            sessionStorage.removeItem('admin_session_username');
            if(loginForm) loginForm.reset();
            showLogin(); 
        });

        safeListen('close-details-modal', 'click', () => {
            try { document.getElementById('modal-content-scroller').scrollTop = 0; } catch(e) {}
            if(detailsModal) detailsModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            // Clear Admin Uploads
            adminFileObjects = [];
            if(detailsModalAdminFileInput) detailsModalAdminFileInput.value = '';
        });
        
        if (detailsModal) {
            detailsModal.addEventListener('click', (e) => {
                if (e.target === detailsModal) {
                    try { document.getElementById('modal-content-scroller').scrollTop = 0; } catch(e) {}
                    detailsModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    
                    // Clear Admin Uploads
                    adminFileObjects = [];
                    if(detailsModalAdminFileInput) detailsModalAdminFileInput.value = '';
                }
            });
        }

        safeListen('confirm-delete-btn', 'click', confirmDeleteUserAction);
        safeListen('cancel-delete-btn', 'click', () => { if(deleteConfirmModal) deleteConfirmModal.classList.add('hidden'); });
        if(deleteConfirmModal) {
            deleteConfirmModal.addEventListener('click', (e) => {
                if (e.target.id === 'delete-confirm-modal') deleteConfirmModal.classList.add('hidden');
            });
        }

        // Card Clicks
        const totalCard = document.getElementById('total-card');
        if(totalCard) {
            totalCard.addEventListener('click', () => {
                if(document.getElementById('typeFilter')) document.getElementById('typeFilter').value = 'ทั้งหมด';
                setActiveView('tickets');
                applyFilters();
            });
        }
        
        const complaintCard = document.getElementById('complaint-card');
        if(complaintCard) {
            complaintCard.addEventListener('click', () => {
                if(document.getElementById('typeFilter')) document.getElementById('typeFilter').value = 'คำร้องเรียน';
                setActiveView('tickets');
                applyFilters();
            });
        }
        
        const suggestionCard = document.getElementById('suggestion-card');
        if(suggestionCard) {
            suggestionCard.addEventListener('click', () => {
                if(document.getElementById('typeFilter')) document.getElementById('typeFilter').value = 'ข้อเสนอแนะ';
                setActiveView('tickets');
                applyFilters();
            });
        }
        // ADDED: Click listener for Report Issue card (hidden element but good for consistency)
        const reportIssueCard = document.getElementById('report-issue-card');
        if(reportIssueCard) {
            reportIssueCard.addEventListener('click', () => {
                 if(document.getElementById('typeFilter')) document.getElementById('typeFilter').value = 'แจ้งปัญหา';
                setActiveView('tickets');
                applyFilters();
            });
        }
        
        const newCard = document.getElementById('new-card');
        if(newCard) {
            newCard.addEventListener('click', () => {
                const statusFilter = document.getElementById('statusFilter');
                if(statusFilter) {
                    statusFilter.value = (statusFilter.value === 'ยังไม่ดำเนินการ') ? 'ทั้งหมด' : 'ยังไม่ดำเนินการ';
                    setActiveView('tickets');
                    applyFilters();
                }
            });
        }
        
        const inprogressCard = document.getElementById('inprogress-card');
        if(inprogressCard) {
            inprogressCard.addEventListener('click', () => {
                const statusFilter = document.getElementById('statusFilter');
                if(statusFilter) {
                    statusFilter.value = (statusFilter.value === 'กำลังดำเนินการ') ? 'ทั้งหมด' : 'กำลังดำเนินการ';
                    setActiveView('tickets');
                    applyFilters();
                }
            });
        }
        
        const completedCard = document.getElementById('completed-card');
        if(completedCard) {
            completedCard.addEventListener('click', () => {
                const statusFilter = document.getElementById('statusFilter');
                if(statusFilter) {
                    statusFilter.value = (statusFilter.value === 'เสร็จสิ้น') ? 'ทั้งหมด' : 'เสร็จสิ้น';
                    setActiveView('tickets');
                    applyFilters();
                }
            });
        }
        
        const cancelledCard = document.getElementById('cancelled-card');
        if(cancelledCard) {
            cancelledCard.addEventListener('click', () => {
                const statusFilter = document.getElementById('statusFilter');
                if(statusFilter) {
                    statusFilter.value = (statusFilter.value === 'ยกเลิก') ? 'ทั้งหมด' : 'ยกเลิก';
                    setActiveView('tickets');
                    applyFilters();
                }
            });
        }

        // ===== NEW: Toggle Password Visibility Logic =====
        const togglePasswordBtn = document.getElementById('togglePasswordBtn');
        const passwordInput = document.getElementById('password');
        const eyeOpenIcon = document.getElementById('eyeOpenIcon');
        const eyeClosedIcon = document.getElementById('eyeClosedIcon');

        if (togglePasswordBtn && passwordInput && eyeOpenIcon && eyeClosedIcon) {
            togglePasswordBtn.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                // Toggle Icons
                if (type === 'text') {
                    eyeOpenIcon.classList.add('hidden');
                    eyeClosedIcon.classList.remove('hidden');
                } else {
                    eyeOpenIcon.classList.remove('hidden');
                    eyeClosedIcon.classList.add('hidden');
                }
            });
        }
        
        // ===== NEW: Template Picker Listeners =====
        if(closeTemplatePickerBtn) {
            closeTemplatePickerBtn.addEventListener('click', () => {
                templatePickerModal.classList.add('hidden');
            });
        }
        
        // Use ID selectors for buttons directly instead of class querySelector to be safe
        const btnInsertAdmin = document.getElementById('btn-insert-template-admin');
        if (btnInsertAdmin) {
            btnInsertAdmin.addEventListener('click', () => {
                openTemplatePicker('details-modal-new-comment');
            });
        }
        
        const btnInsertPublic = document.getElementById('btn-insert-template-public');
        if (btnInsertPublic) {
            btnInsertPublic.addEventListener('click', () => {
                openTemplatePicker('public-comment-textarea');
            });
        }
        
        // Close picker when clicking outside
        if (templatePickerModal) {
            templatePickerModal.addEventListener('click', (e) => {
                if (e.target === templatePickerModal) {
                    templatePickerModal.classList.add('hidden');
                }
            });
        }
        
        // ===== NEW: User/Team Tab Listeners =====
        if (tabBtnUsers) {
            tabBtnUsers.addEventListener('click', () => switchUserTab('users'));
        }
        if (tabBtnTeams) {
            tabBtnTeams.addEventListener('click', () => {
                switchUserTab('teams');
                loadTeamSettings();
            });
        }
        
        // ===== NEW: Add Team Form Listener =====
        if (addTeamForm) {
            addTeamForm.addEventListener('submit', handleSaveTeam);
        }
    });

    // --- MASTER FUNCTION to Switch Views ---
    function setActiveView(viewName) {
        if (viewDashboard) viewDashboard.classList.add('hidden');
        if (viewTickets) viewTickets.classList.add('hidden');
        if (settingsView) settingsView.classList.add('hidden');
        
        // Remove active class safely
        if(menuDashboardBtn) menuDashboardBtn.classList.remove('active');
        if(menuTicketsBtn) menuTicketsBtn.classList.remove('active');
        if(settingsBtn) settingsBtn.classList.remove('active');

        if (viewName === 'dashboard') {
            if(viewDashboard) viewDashboard.classList.remove('hidden');
            if(menuDashboardBtn) menuDashboardBtn.classList.add('active');
            if (topFilterBar) topFilterBar.classList.add('hidden');

            // NEW: Reset filters and refresh data when entering dashboard
            resetFilters();
            fetchAdminData(); 

            if (summarySection && !summarySection.classList.contains('hidden')) {
                setTimeout(() => {
                       if (chartData) renderStatusChart(chartData);
                       if (summaryData) renderTypeChart(summaryData);
                }, 50);
            }

        } else if (viewName === 'tickets') {
            if(viewTickets) viewTickets.classList.remove('hidden');
            if(menuTicketsBtn) menuTicketsBtn.classList.add('active');
            if (topFilterBar) topFilterBar.classList.remove('hidden');

        } else if (viewName === 'settings') {
            if(settingsView) settingsView.classList.remove('hidden');
            if(settingsBtn) settingsBtn.classList.add('active');
            if (topFilterBar) topFilterBar.classList.add('hidden');
            
            showSettingsView(settingsMenuView);
        }
    }
    
    function showSettingsView(viewToShow) {
        if(settingsMenuView) settingsMenuView.classList.add('hidden');
        if(userManagementView) userManagementView.classList.add('hidden');
        if(logoSettingsView) logoSettingsView.classList.add('hidden');
        if(translationSettingsView) translationSettingsView.classList.add('hidden');
        if(profanitySettingsView) profanitySettingsView.classList.add('hidden');
        if(coreSettingsView) coreSettingsView.classList.add('hidden'); 
        // if(displaySettingsView) displaySettingsView.classList.add('hidden'); // Removed
        if(templateSettingsView) templateSettingsView.classList.add('hidden');
        if(formConfigView) formConfigView.classList.add('hidden'); // NEW: Added
        
        if (viewToShow) {
            viewToShow.classList.remove('hidden');
            
            // If opening User Management, reset to Users tab by default
            if (viewToShow === userManagementView) {
                switchUserTab('users');
            }
        }
    }
    
    // ===== NEW: USER MANAGEMENT TABS LOGIC =====
    function switchUserTab(tabName) {
        if (!tabBtnUsers || !tabBtnTeams || !tabContentUsers || !tabContentTeams) return;
        
        if (tabName === 'users') {
            // Active User Tab
            tabBtnUsers.className = "px-6 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-all hover:bg-indigo-50/50 rounded-t-lg";
            tabBtnTeams.className = "px-6 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-indigo-500 hover:bg-slate-50 transition-all rounded-t-lg";
            
            tabContentUsers.classList.remove('hidden');
            tabContentTeams.classList.add('hidden');
        } else {
            // Active Team Tab
            tabBtnTeams.className = "px-6 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-all hover:bg-indigo-50/50 rounded-t-lg";
            tabBtnUsers.className = "px-6 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-indigo-500 hover:bg-slate-50 transition-all rounded-t-lg";
            
            tabContentTeams.classList.remove('hidden');
            tabContentUsers.classList.add('hidden');
        }
    }
    
    // ===== NEW: TEAM MANAGEMENT FUNCTIONS =====
    function loadTeamSettings() {
        const token = getSessionToken();
        if (!token) return;
        
        // Show loading state
        if (teamListDisplay) teamListDisplay.innerHTML = '<div class="text-center text-slate-400 py-10 italic">กำลังโหลดข้อมูล...</div>';
        
        google.script.run
            .withSuccessHandler(res => {
                if (checkAuth(res)) {
                    renderTeamSettingsList(res.data);
                }
            })
            .withFailureHandler(err => {
                if (teamListDisplay) teamListDisplay.innerHTML = `<div class="text-center text-red-500 py-10">Error: ${err}</div>`;
            })
            .getTeams(token);
    }
    
    function renderTeamSettingsList(teams) {
        if (!teamListDisplay) return;
        teamListDisplay.innerHTML = '';
        
        if (!teams || teams.length === 0) {
            teamListDisplay.innerHTML = '<div class="text-center text-slate-400 py-10 italic">ยังไม่มีข้อมูลหน่วยงาน</div>';
            return;
        }
        
        teams.forEach(team => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg hover:border-indigo-200 transition-colors shadow-sm group';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    </div>
                    <span class="font-bold text-slate-700 text-sm">${escapeHtml(team)}</span>
                </div>
                <button class="p-1.5 text-slate-300 hover:text-red-500 rounded hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100" onclick="handleDeleteTeam('${escapeHtml(team)}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            `;
            teamListDisplay.appendChild(item);
        });
    }
    
    function handleSaveTeam(e) {
        e.preventDefault();
        const input = document.getElementById('newTeamName');
        const teamName = input.value.trim();
        if (!teamName) return;
        
        // Disable button
        const btn = addTeamForm.querySelector('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner w-4 h-4 border-white border-t-transparent"></div>';
        
        google.script.run
            .withSuccessHandler(res => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (checkAuth(res)) {
                    if (res.success) {
                        showToast(`เพิ่มหน่วยงาน "${teamName}" เรียบร้อย`);
                        input.value = '';
                        loadTeamSettings();
                        loadTeamList(); // Refresh datalist for dropdowns
                    } else {
                        alert("Error: " + res.error);
                    }
                }
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert("Error: " + err);
            })
            .saveTeam(getSessionToken(), teamName);
    }
    
    function handleDeleteTeam(teamName) {
        if (!confirm(`ต้องการลบหน่วยงาน "${teamName}" ใช่หรือไม่? (ผู้ใช้ที่สังกัดหน่วยงานนี้จะไม่ถูกลบ แต่ชื่อหน่วยงานจะหายไป)`)) return;
        
        google.script.run
            .withSuccessHandler(res => {
                if (checkAuth(res)) {
                    if (res.success) {
                        showToast(`ลบหน่วยงานเรียบร้อย`);
                        loadTeamSettings();
                        loadTeamList(); // Refresh datalist
                    } else {
                        alert("Error: " + res.error);
                    }
                }
            })
            .withFailureHandler(err => alert("Error: " + err))
            .deleteTeam(getSessionToken(), teamName);
    }

    
    // ===== NEW: RESET FILTERS FUNCTION =====
    function resetFilters() {
        const typeFilter = document.getElementById('typeFilter');
        const statusFilter = document.getElementById('statusFilter');
        const teamFilter = document.getElementById('teamFilter');
        const searchInput = document.getElementById('searchInput');
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateRangeDisplay = document.getElementById('date-range-display');
        const dateStartInput = document.getElementById('dateStartInput');
        const dateEndInput = document.getElementById('dateEndInput');

        if (typeFilter) typeFilter.value = 'ทั้งหมด';
        if (statusFilter) statusFilter.value = 'ทั้งหมด';
        if (teamFilter) teamFilter.value = 'ทั้งหมด';
        if (searchInput) searchInput.value = '';
        
        if (dateRangeFilter) dateRangeFilter.value = 'all';
        if (dateStartInput) dateStartInput.value = '';
        if (dateEndInput) dateEndInput.value = '';
        if (dateRangeDisplay) dateRangeDisplay.classList.add('hidden');
        
        currentPage = 1;
    }

    function onLoginSuccess(response) {
        setLoginLoading(false);
        if (response && response.role && response.token) {
            sessionStorage.setItem('sessionToken', response.token);
            sessionStorage.setItem('userRole', response.role); 
            if (response.username) {
                sessionStorage.setItem('admin_session_username', response.username); 
            }
            showDashboard(); 
        } else if (response && response.error === 'ACCOUNT_INACTIVE') {
            // NEW: Specific error for inactive users
            loginError.textContent = 'บัญชีนี้ถูกระงับการใช้งาน กรุณาติดต่อผู้ดูแลระบบ'; 
            loginError.classList.remove('hidden');
        } else {
            loginError.textContent = 'Username หรือ Password ไม่ถูกต้อง'; 
            loginError.classList.remove('hidden');
        }
    }

    function onLoginFailure(error) {
        setLoginLoading(false);
        loginError.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message; 
        loginError.classList.remove('hidden');
    }

    function showLogin() {
        if(viewDashboard) viewDashboard.classList.add('hidden');
        if(viewTickets) viewTickets.classList.add('hidden');
        if(settingsView) settingsView.classList.add('hidden');
        if(loginModal) loginModal.classList.remove('hidden');
    }

    function showDashboard() {
        if(loginModal) loginModal.classList.add('hidden');
        setActiveView('dashboard');

        const userRole = sessionStorage.getItem('userRole');
        if (userRole === 'Admin') {
            if(settingsBtn) settingsBtn.classList.remove('hidden');
        } else {
            if(settingsBtn) settingsBtn.classList.add('hidden');
        }

        if (userRole === 'Admin' && auditLogBtn) {
            auditLogBtn.classList.remove('hidden');
        } else {
            if(auditLogBtn) auditLogBtn.classList.add('hidden');
        }

        const username = sessionStorage.getItem('admin_session_username');
        
        // --- CALL NEW FUNCTION HERE ---
        updateSidebarProfile(username, userRole);
        // -----------------------------

        fetchAdminData(); 

        google.script.run
            .withSuccessHandler(onUserListLoad)
            .withFailureHandler(onUserListLoadFailure)
            .getAssignableUsers(getSessionToken());
    }

    function onUserListLoad(activeTeams) {
        if (checkAuth(activeTeams)) { 
            // Update Global Assignable User List (Now it's TEAMS)
            assignableUserList = activeTeams; 
            
            // Populate Modal Dropdown
            const assignSelect = document.getElementById('details-modal-assign-select');
            if (assignSelect) {
                const currentVal = assignSelect.value;
                assignSelect.innerHTML = '';
                
                const unassignedOption = document.createElement('option');
                unassignedOption.value = "";
                unassignedOption.textContent = "(ยังไม่ระบุหน่วยงาน)";
                assignSelect.appendChild(unassignedOption);

                if (activeTeams && activeTeams.length > 0) {
                    activeTeams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team;
                        option.textContent = team;
                        assignSelect.appendChild(option);
                    });
                }
                assignSelect.value = currentVal;
            }

            // Populate Filter Dropdown (Team Filter - same data but semantically separated)
            const teamFilter = document.getElementById('teamFilter');
            if(teamFilter) {
                 const currentFilterValue = teamFilter.value; 
                 teamFilter.innerHTML = '';
                 const allOption = document.createElement('option');
                 allOption.value = 'ทั้งหมด';
                 allOption.textContent = 'ทุกแผนก (All Teams)';
                 teamFilter.appendChild(allOption);
                 
                 // INSERT: Unassigned Option
                 const unassignedFilterOption = document.createElement('option');
                 unassignedFilterOption.value = ''; // Empty string matches unassigned rows
                 unassignedFilterOption.textContent = '(ยังไม่ระบุหน่วยงาน)';
                 teamFilter.appendChild(unassignedFilterOption);
                 
                 if (activeTeams && activeTeams.length > 0) {
                    activeTeams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team;
                        option.textContent = team;
                        teamFilter.appendChild(option);
                    });
                }
                teamFilter.value = currentFilterValue || 'ทั้งหมด';
            }

        } else {
            assignableUserList = [];
        }
    }
    function onUserListLoadFailure(error) {
        assignableUserList = [];
    }

    // --- MAIN DATA FETCHING ---
    function fetchAdminData(isRefresh = false) {
        setRefreshLoading(true); 
        showPageLoader(true);    

        const typeFilter = document.getElementById('typeFilter');
        const statusFilter = document.getElementById('statusFilter');
        // REMOVED: assignFilter constant declaration
        const teamFilter = document.getElementById('teamFilter'); 
        const searchInput = document.getElementById('searchInput');
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateStartInput = document.getElementById('dateStartInput');
        const dateEndInput = document.getElementById('dateEndInput');

        const dateRangeKey = dateRangeFilter ? dateRangeFilter.value : 'all';
        let dateStart = null;
        let dateEnd = null;

        if (dateRangeKey === 'custom') {
            dateStart = dateStartInput ? dateStartInput.value : null;
            dateEnd = dateEndInput ? dateEndInput.value : null;
        }

        // Logic: Use teamFilter value directly as assignee value
        let assigneeValue = teamFilter && teamFilter.value !== 'ทั้งหมด' ? teamFilter.value : 'ทั้งหมด';

        const options = {
            page: currentPage,
            filters: {
                type: typeFilter ? typeFilter.value : 'ทั้งหมด',
                status: statusFilter ? statusFilter.value : 'ทั้งหมด',
                assignee: assigneeValue, 
                dateRangeKey: dateRangeKey,
                dateStart: dateStart,                 
                dateEnd: dateEnd                  
            },
            searchTerm: searchInput ? searchInput.value : '',
            forceRefresh: isRefresh 
        };

        const token = getSessionToken();
        if (!token) {
            onDataLoadSuccess({ error: "Authentication failed. Please log in again." });
            return;
        }

        google.script.run
            .withSuccessHandler(onDataLoadSuccess) 
            .withFailureHandler(onDataLoadFailure) 
            .getPaginatedData(token, options); 
    }

    function onDataLoadFailure(error) {
        setRefreshLoading(false);
        showPageLoader(false); 
        console.error("Failed to load admin data:", error);
        if(ticketTableBody) {
             ticketTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500 font-bold">Error loading data: ' + error.message + '. Please try refreshing.</td></tr>';
        }
    }

    function onDataLoadSuccess(data) { 
        setRefreshLoading(false);
        showPageLoader(false); 
        
        // ===== FIX: Add check for null data =====
        if (!data) {
             console.error("Server returned null data (Serialization Error).");
             if(ticketTableBody) {
                 ticketTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500 font-bold">เกิดข้อผิดพลาดในการโหลดข้อมูล (Data Serialization Error) กรุณารีเฟรชหน้าจอ</td></tr>';
             }
             return;
        }
        // ========================================
        
        if (!checkAuth(data)) {
            if(ticketTableBody) {
                 ticketTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500 font-bold">Failed to load data. Please try refreshing.</td></tr>';
            }
            return; 
        }

         const summary = data.summary || { total: 0, complaints: 0, suggestions: 0, reportIssues: 0, statusCounts: {} }; // Added reportIssues

        document.getElementById('total-count').textContent = summary.total || 0;
        // The hidden counters are updated if needed by charts or logic
        if(document.getElementById('report-issue-count')) document.getElementById('report-issue-count').textContent = summary.reportIssues || 0;
        
        const counts = data.filteredStatusCounts || {'ยังไม่ดำเนินการ': 0, 'กำลังดำเนินการ': 0, 'เสร็จสิ้น': 0, 'ยกเลิก': 0};
        document.getElementById('pending-count').textContent = counts['ยังไม่ดำเนินการ'] || 0;
        document.getElementById('inprogress-count').textContent = counts['กำลังดำเนินการ'] || 0;
        document.getElementById('completed-count').textContent = counts['เสร็จสิ้น'] || 0;
        document.getElementById('cancelled-count').textContent = counts['ยกเลิก'] || 0;

        chartData = counts; 
        summaryData = summary; 

        if(document.getElementById('summarySection')){
           renderStatusChart(chartData);
           if (summaryData) { 
                renderTypeChart(summaryData);
           }
        }

        allHeaders = Array.isArray(data.headers) ? data.headers : [];
        const receivedRecords = Array.isArray(data.records) ? data.records : [];

        currentPageRecords = receivedRecords.map((record, index) => { 
            const ticketIdIndex = allHeaders.indexOf('เลขที่');
            return {
                originalData: record,
                ticketId: (ticketIdIndex !== -1 && record[ticketIdIndex]) ? record[ticketIdIndex] : 'row-' + index
            };
        });

        // Render Recent Activity
        const rawRecent = data.recentRecords || [];
        const recentActivityObjects = rawRecent.map((record, index) => {
             const ticketIdIndex = allHeaders.indexOf('เลขที่');
             return {
                 originalData: record,
                 ticketId: (ticketIdIndex !== -1 && record[ticketIdIndex]) ? record[ticketIdIndex] : 'recent-' + index
             };
        });
        renderRecentActivity(recentActivityObjects);

        renderTicketTable(currentPageRecords); 
        renderPagination(data.pagination); 
        
        if (data.slaSummary) {
            renderSlaWidget(data.slaSummary);
        }
        if (data.assigneePerformance) {
            renderAssigneeTable(data.assigneePerformance);
        }
        
        unassignedQueueData = data.unassignedQueue || []; 
        renderUnassignedQueue(unassignedQueueData, data.assigneePerformance);
    }
    
    function renderSlaWidget(summary) {
        const container = document.getElementById('sla-widget-container');
        const critAlert = document.getElementById('sla-critical-alert');
        const warnAlert = document.getElementById('sla-warning-alert');
        const critCount = document.getElementById('sla-critical-count');
        const warnCount = document.getElementById('sla-warning-count');

        if(!container) return;

        if (!showSlaWarnings) {
            container.classList.add('hidden');
            return;
        }

        let showWidget = false;

        if (summary.critical > 0) {
            critCount.textContent = summary.critical;
            critAlert.classList.remove('hidden');
            showWidget = true;
        } else {
            critAlert.classList.add('hidden');
        }

        if (summary.warning > 0) {
            warnCount.textContent = summary.warning;
            warnAlert.classList.remove('hidden');
            showWidget = true;
        } else {
            warnAlert.classList.add('hidden');
        }

        if (showWidget) {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    function renderAssigneeTable(list) {
        const tbody = document.getElementById('assignee-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-slate-400 italic">ไม่มีข้อมูล</td></tr>';
            return;
        }

        list.forEach(item => {
            let activeClass = 'bg-slate-50 text-slate-500';
            if (item.active > 0) activeClass = 'bg-indigo-50 text-indigo-700 font-bold'; 
            
            let completedClass = 'text-slate-500';
            if (item.completed > 0) completedClass = 'text-green-600 font-bold';
            
            let cancelledClass = 'text-slate-300';
            if (item.cancelled > 0) cancelledClass = 'text-red-500 font-bold';

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0';
            
            tr.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                        ${getAvatarHtml(item.name)}
                        <span class="font-bold text-slate-700 text-sm">${escapeHtml(item.name)}</span>
                    </div>
                </td>
                <td class="px-6 py-4 text-center text-slate-600 font-bold">
                    ${item.total || 0}
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-block px-3 py-1 rounded-lg text-xs ${activeClass}">${item.active}</span>
                </td>
                <td class="px-6 py-4 text-center text-xs">
                    <span class="${completedClass}">${item.completed}</span>
                </td>
                <td class="px-6 py-4 text-center text-xs">
                    <span class="${cancelledClass}">${item.cancelled || 0}</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderUnassignedQueue(queue, assigneePerf) {
        const container = document.getElementById('unassigned-list-container');
        const badge = document.getElementById('unassigned-count-badge');
        
        if (!container) return;
        container.innerHTML = ''; 

        let totalUnassigned = 0;
        if (assigneePerf) {
            const unassignedStats = assigneePerf.find(a => a.name === 'Unassigned');
            if (unassignedStats) totalUnassigned = unassignedStats.active;
        } else {
            totalUnassigned = queue.length; 
        }

        if (badge) {
            badge.textContent = totalUnassigned;
            if(totalUnassigned > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        if (!queue || queue.length === 0) {
            container.innerHTML = '<div class="text-center py-10 text-slate-400 italic text-sm flex flex-col items-center"><svg class="w-8 h-8 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>ไม่มีงานค้างจ่าย</div>';
            return;
        }

        const ticketIdIndex = allHeaders.indexOf('เลขที่');
        const topicIndex = allHeaders.indexOf('หัวข้อ');
        const dateIndex = allHeaders.indexOf('วันที่');
        const typeIndex = allHeaders.indexOf('ประเภท');

        queue.forEach(row => {
            const ticketId = ticketIdIndex !== -1 ? row[ticketIdIndex] : 'N/A';
            const topic = topicIndex !== -1 ? row[topicIndex] : 'No Topic';
            const dateStr = dateIndex !== -1 ? row[dateIndex] : '-';
            const type = typeIndex !== -1 ? row[typeIndex] : '';

            // Default Style
            let borderColor = 'border-l-4 border-l-slate-400';
            let iconBg = 'bg-slate-100 text-slate-500';
            let typeBadgeClass = 'bg-slate-100 text-slate-500';
            let iconSvg = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>';
            
            // Custom Styles for Each Type
            if (type === 'คำร้องเรียน') {
                borderColor = 'border-l-4 border-l-rose-500';
                iconBg = 'bg-rose-50 text-rose-500';
                typeBadgeClass = 'text-rose-600 font-bold bg-rose-50 px-2 py-0.5 rounded text-[10px]';
                iconSvg = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
            } else if (type === 'ข้อเสนอแนะ') {
                borderColor = 'border-l-4 border-l-blue-500';
                iconBg = 'bg-blue-50 text-blue-500';
                typeBadgeClass = 'text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded text-[10px]';
                iconSvg = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>';
            } else if (type === 'แจ้งปัญหา') { // ADDED: Report Issue Style (Amber)
                borderColor = 'border-l-4 border-l-amber-500';
                iconBg = 'bg-amber-50 text-amber-500';
                typeBadgeClass = 'text-amber-600 font-bold bg-amber-50 px-2 py-0.5 rounded text-[10px]';
                // NEW ICON (Small version w-4 h-4)
                iconSvg = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>';
            }

            const item = document.createElement('div');
            item.className = `w-full bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer group relative overflow-hidden mb-3 ${borderColor}`;
            
            item.onclick = () => showDetailsModal(ticketId);

            item.innerHTML = `
                <div class="p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-700 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200 tracking-wide">${escapeHtml(ticketId)}</span>
                            <span class="${typeBadgeClass}">${escapeHtml(type)}</span>
                        </div>
                        <span class="text-[10px] text-slate-400 font-mono">${escapeHtml(dateStr.split(' ')[0])}</span>
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-lg ${iconBg} flex items-center justify-center mt-0.5 pointer-events-none">
                            ${iconSvg}
                        </div>
                        <div class="flex-1 min-w-0">
                             <p class="text-sm font-semibold text-slate-700 line-clamp-2 leading-snug group-hover:text-indigo-600 transition-colors mb-2" title="${escapeHtml(topic)}">
                                ${escapeHtml(topic)}
                            </p>
                            
                            <div class="flex items-center justify-end pt-2 border-t border-slate-50">
                                <button class="assign-trigger-btn text-xs font-bold text-white bg-indigo-500 hover:bg-indigo-600 px-3 py-1.5 rounded-lg shadow-sm transition-colors flex items-center gap-1.5 z-10 relative">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                    มอบหมายงาน
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const btn = item.querySelector('.assign-trigger-btn');
            if(btn) {
                btn.onclick = (e) => {
                    e.stopPropagation(); 
                    e.preventDefault(); 
                    showDetailsModal(ticketId);
                    setTimeout(() => {
                        const select = document.getElementById('details-modal-assign-select');
                        if(select) {
                            select.focus();
                            select.click(); 
                            select.classList.add('ring-2', 'ring-indigo-300'); 
                            setTimeout(() => select.classList.remove('ring-2', 'ring-indigo-300'), 1500);
                        }
                    }, 500); 
                };
            }

            container.appendChild(item);
        });
    }

    function getAvatarHtml(username) {
        if (!username || username === 'Unassigned') {
            return `<div class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-200 text-slate-400 shadow-sm border border-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>`;
        }
        const firstChar = username.charAt(0).toUpperCase();
        const colorClass = getAvatarColorClass(username);
        return `<div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm border border-white ${colorClass}">${firstChar}</div>`;
    }

    function applyFilters() {
        currentPage = 1; 
        fetchAdminData(); 
    }

    function getTypeClasses(type) {
        // ADDED: Amber class for Report Issue
        if (type === 'แจ้งปัญหา') return 'bg-amber-100 text-amber-700'; 
        return type === 'คำร้องเรียน' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700';
    }

    function getStatusClasses(status) {
        switch (status) {
            case 'กำลังดำเนินการ': return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
            case 'เสร็จสิ้น': return 'bg-green-100 text-green-800 border border-green-300';
            case 'ยกเลิก': return 'bg-red-100 text-red-800 border border-red-300';
            default: return 'bg-slate-100 text-slate-800 border border-slate-300'; 
        }
    }

    function renderRecentActivity(records) {
        const tbody = document.getElementById('recent-activity-tbody');
        if (!tbody) return;

        const table = tbody.closest('table');
        if (table) {
            table.classList.add('table-fixed'); 
            const thead = table.querySelector('thead tr');
            if (thead) {
                 thead.innerHTML = `
                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">ประเภท</th>
                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">ID</th>
                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">วันที่</th>
                    <th class="px-4 py-4 text-left w-[24%]">หัวข้อ</th>                                                                <!-- เพิ่มจาก 22% เป็น 24% -->
                    <th class="px-4 py-4 text-left w-[34%]">รายละเอียด</th>                                                                 <!-- เพิ่มจาก 33% เป็น 34% -->
                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">สถานะ</th>
                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">หน่วยงาน</th>
                `;
            }
        }

        tbody.innerHTML = '';
        const recentItems = records.slice(0, 5);

        if (recentItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 italic">ไม่มีรายการล่าสุด</td></tr>`; 
            return;
        }

        const ticketIdIndex = allHeaders.indexOf('เลขที่');
        const dateIndex = allHeaders.indexOf('วันที่');
        const topicIndex = allHeaders.indexOf('หัวข้อ');
        const statusIndex = allHeaders.indexOf('สถานะ');
        const detailsIndex = allHeaders.indexOf('รายละเอียด');
        const typeIndex = allHeaders.indexOf('ประเภท'); 
        const assignIndex = allHeaders.indexOf('Assigned To'); // เพิ่ม: หา index ของคอลัมน์ผู้รับผิดชอบ

        recentItems.forEach(recordObj => {
            const record = recordObj.originalData;
            const ticketId = ticketIdIndex !== -1 ? record[ticketIdIndex] : 'N/A';
            const topic = topicIndex !== -1 ? record[topicIndex] : '-';
            const status = statusIndex !== -1 ? record[statusIndex] : 'N/A';
            const details = detailsIndex !== -1 ? (record[detailsIndex] || '-') : '-';
            const type = typeIndex !== -1 ? (record[typeIndex] || '-') : '-'; 
            const assignedTo = assignIndex !== -1 ? (record[assignIndex] || '') : ''; // เพิ่ม: ดึงค่าผู้รับผิดชอบ
            
            let formattedDate = '-';
            if (dateIndex !== -1 && record[dateIndex]) {
                 const fullDateTime = parseThaiDate(record[dateIndex]);
                 if (fullDateTime) {
                    const parts = fullDateTime.split(' ');
                    if (parts.length > 3) {
                        formattedDate = parts.slice(0, 3).join(' ');
                    } else {
                        formattedDate = fullDateTime;
                    }
                 }
            }

            let badgeClass = 'bg-slate-100 text-slate-600';
            let statusLabel = 'New';
            if (status === 'กำลังดำเนินการ') { badgeClass = 'bg-yellow-100 text-yellow-700 border border-yellow-200'; statusLabel = 'In Progress'; }
            else if (status === 'เสร็จสิ้น') { badgeClass = 'bg-green-100 text-green-700 border border-green-200'; statusLabel = 'Completed'; }
            else if (status === 'ยกเลิก') { badgeClass = 'bg-red-100 text-red-700 border border-red-200'; statusLabel = 'Cancelled'; }

            let typeBadgeClass = 'bg-slate-50 text-slate-500 border-slate-100'; 
            if (type === 'คำร้องเรียน') {
                typeBadgeClass = 'bg-red-50 text-red-600 border-red-100';
            } else if (type === 'ข้อเสนอแนะ') {
                typeBadgeClass = 'bg-blue-50 text-blue-600 border-blue-100';
            } else if (type === 'แจ้งปัญหา') { // ADDED
                typeBadgeClass = 'bg-amber-50 text-amber-600 border-amber-100';
            }

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors cursor-pointer'; 
            tr.onclick = () => showDetailsModal(recordObj.ticketId); 
            
            tr.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <span class="px-2.5 py-1 rounded-full text-[10px] font-bold border ${typeBadgeClass}">
                        ${escapeHtml(type)}
                    </span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap font-bold text-indigo-600 text-xs text-center">${escapeHtml(ticketId)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-slate-500 text-xs text-center">${escapeHtml(formattedDate)}</td>
                <td class="px-4 py-4 font-medium text-slate-800 text-sm truncate text-left">${escapeHtml(topic)}</td>
                <td class="px-4 py-4 text-slate-600 text-sm truncate text-left" title="${escapeHtml(details)}">${escapeHtml(details)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <span class="px-2 py-1 rounded-md text-xs font-bold ${badgeClass}">${statusLabel}</span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <div class="flex justify-center">
                        ${getAvatarHtml(assignedTo)}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function parseThaiDate(dateStringOrObj) {
        if (!dateStringOrObj) return '-';
        
        const options = { day: 'numeric', month: 'short', year: '2-digit' };
        
        if (dateStringOrObj instanceof Date) {
            return dateStringOrObj.toLocaleDateString('th-TH', options);
        }
        const str = String(dateStringOrObj).trim();
        if (str.includes('/')) {
            const parts = str.split(/[/\s:]/); 
            if (parts.length >= 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; 
                const year = parseInt(parts[2], 10);
                const dateObj = new Date(year, month, day);
                if (!isNaN(dateObj.getTime())) {
                    return dateObj.toLocaleDateString('th-TH', options);
                }
            }
        }
        const date = new Date(str);
        if (!isNaN(date.getTime())) {
             return date.toLocaleDateString('th-TH', options);
        }
        return str;
    }

    function getAvatarColorClass(username) {
        if (!username) return 'avatar-gray';
        const colors = ['avatar-indigo', 'avatar-pink', 'avatar-teal', 'avatar-orange'];
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }

    function parseRawDateForCalc(str) {
        if(!str) return null;
        const parts = String(str).split(/[/\s:]/);
        if(parts.length >= 5) {
            return new Date(parts[2], parts[1]-1, parts[0], parts[3], parts[4]);
        }
        return null;
    }

    function getSLAStatus(dateObj, status) {
        if (!dateObj) return { level: 'normal' };
        
        const now = new Date();
        const diffMs = now - dateObj;
        const diffHours = diffMs / (1000 * 60 * 60);

        if (status === 'ยังไม่ดำเนินการ' && diffHours > 24) {
            return { level: 'critical' };
        }
        if (status === 'กำลังดำเนินการ' && diffHours > 72) { 
            return { level: 'warning' };
        }
        return { level: 'normal' };
    }

    function renderTicketTable(records) {
        const tbody = document.getElementById('ticket-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 italic">ไม่พบข้อมูลที่ตรงกัน</td></tr>';
            return;
        }

        if (!allHeaders || allHeaders.length === 0) {
             tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500">Error: Could not load data headers.</td></tr>';
             return;
        }

        const ticketIdIndex = allHeaders.indexOf('เลขที่');
        const dateIndex = allHeaders.indexOf('วันที่');
        const typeIndex = allHeaders.indexOf('ประเภท');
        const topicIndex = allHeaders.indexOf('หัวข้อ');
        const detailsIndex = allHeaders.indexOf('รายละเอียด'); 
        const statusIndex = allHeaders.indexOf('สถานะ');
        const assignIndex = allHeaders.indexOf('Assigned To');

        records.forEach(recordObj => {
            const record = recordObj.originalData;
            if (!record) return;

            const ticketId = ticketIdIndex !== -1 ? record[ticketIdIndex] : 'N/A';
            const type = typeIndex !== -1 ? record[typeIndex] : 'N/A';
            const status = statusIndex !== -1 ? record[statusIndex] : 'N/A';
            const topic = topicIndex !== -1 ? record[topicIndex] : 'N/A';
            const details = detailsIndex !== -1 ? (record[detailsIndex] || '-') : '-'; 
            const assignedTo = assignIndex !== -1 ? (record[assignIndex] || '') : ''; 

            let formattedDate = '-';
            if (dateIndex !== -1 && record[dateIndex]) {
                 formattedDate = parseThaiDate(record[dateIndex]);
            }

            let badgeClass = 'bg-slate-100 text-slate-600';
            let statusLabel = 'New';
            if (status === 'กำลังดำเนินการ') { badgeClass = 'bg-yellow-100 text-yellow-700 border border-yellow-200'; statusLabel = 'In Progress'; }
            else if (status === 'เสร็จสิ้น') { badgeClass = 'bg-green-100 text-green-700 border border-green-200'; statusLabel = 'Completed'; }
            else if (status === 'ยกเลิก') { badgeClass = 'bg-red-100 text-red-700 border border-red-200'; statusLabel = 'Cancelled'; }

            let typeBadgeClass = 'bg-slate-50 text-slate-500 border-slate-100'; 
            if (type === 'คำร้องเรียน') {
                typeBadgeClass = 'bg-red-50 text-red-600 border-red-100';
            } else if (type === 'ข้อเสนอแนะ') {
                typeBadgeClass = 'bg-blue-50 text-blue-600 border-blue-100';
            } else if (type === 'แจ้งปัญหา') { // ADDED
                typeBadgeClass = 'bg-amber-50 text-amber-600 border-amber-100';
            }

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors cursor-pointer border-b border-slate-100 last:border-0';
            tr.onclick = () => showDetailsModal(recordObj.ticketId);

            tr.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold border ${typeBadgeClass}">
                        ${escapeHtml(type)}
                    </span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap font-bold text-indigo-600 text-xs text-center">${escapeHtml(ticketId)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-slate-500 text-xs text-center">${escapeHtml(formattedDate)}</td>
                <td class="px-4 py-4 font-medium text-slate-800 text-sm truncate text-left max-w-xs" title="${escapeHtml(topic)}">${escapeHtml(topic)}</td>
                <td class="px-4 py-4 text-slate-600 text-sm truncate text-left max-w-xs" title="${escapeHtml(details)}">${escapeHtml(details)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <span class="px-2 py-0.5 rounded-md text-[10px] font-bold border ${badgeClass}">${statusLabel}</span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-center">
                    <div class="flex justify-center">
                        ${getAvatarHtml(assignedTo)}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ===== HELPER: Extract ID from Drive URL =====
    function getDriveId(url) {
        if (!url) return null;
        // Matches typical ID patterns in Drive URLs
        const match = url.match(/\/d\/(.+?)(\/|$)/) || url.match(/id=([^&]+)/);
        return match ? match[1] : null;
    }

    // ===== HELPER: Check if URL looks like an image =====
    function isImageUrl(url) {
        if (!url) return false;
        // Simple check: Drive ID usually implies we can try to render it, 
        // but robustly, we check common extensions if available in URL or just assume Drive thumbnail works
        return true; // We will assume it is renderable via Google Drive Thumbnail API
    }

    // ===== NEW LIGHTBOX LOGIC =====
    function openLightbox(index) {
        if (!lightboxModal || !lightboxImage || !lightboxDownload || currentLightboxImages.length === 0) return;
        
        currentLightboxIndex = index;
        updateLightboxView();
        
        lightboxModal.classList.remove('hidden');
        // Small delay for transition
        requestAnimationFrame(() => {
            lightboxImage.classList.remove('scale-95', 'opacity-0');
            lightboxImage.classList.add('scale-100', 'opacity-100');
        });
    }

    function updateLightboxView() {
        const currentImg = currentLightboxImages[currentLightboxIndex];
        if(!currentImg) return;
        
        lightboxImage.src = currentImg.src;
        lightboxDownload.href = currentImg.download;
        
        if (lightboxCounter) {
            lightboxCounter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;
        }

        // Show/Hide Nav Buttons based on index
        if(currentLightboxImages.length > 1) {
            lightboxPrev.classList.remove('hidden');
            lightboxNext.classList.remove('hidden');
        } else {
             lightboxPrev.classList.add('hidden');
             lightboxNext.classList.add('hidden');
        }
    }

    function navigateLightbox(step) {
        if (currentLightboxImages.length <= 1) return;
        
        let newIndex = currentLightboxIndex + step;
        
        // Loop logic
        if (newIndex < 0) newIndex = currentLightboxImages.length - 1;
        if (newIndex >= currentLightboxImages.length) newIndex = 0;
        
        currentLightboxIndex = newIndex;
        
        // Add fade out/in effect for smoother transition
        lightboxImage.classList.add('opacity-50');
        setTimeout(() => {
            updateLightboxView();
            lightboxImage.classList.remove('opacity-50');
        }, 150);
    }
    // ===== END NEW LIGHTBOX LOGIC =====

    function showDetailsModal(ticketId) {
        let recordObj = currentPageRecords.find(r => r.ticketId === ticketId);
        
        if (!recordObj && unassignedQueueData.length > 0) {
             const ticketIdIndex = allHeaders.indexOf('เลขที่');
             if (ticketIdIndex !== -1) {
                 const foundRow = unassignedQueueData.find(row => row[ticketIdIndex] === ticketId);
                 if (foundRow) {
                     recordObj = {
                         originalData: foundRow,
                         ticketId: ticketId
                     };
                 }
             }
        }

        if (!recordObj) return;

        document.getElementById('details-modal-card').dataset.currentTicketId = ticketId;

        const record = recordObj.originalData;
        const ticketIdIndex = allHeaders.indexOf('เลขที่');
        const dateIndex = allHeaders.indexOf('วันที่');
        const typeIndex = allHeaders.indexOf('ประเภท');
        const topicIndex = allHeaders.indexOf('หัวข้อ');
        const detailsIndex = allHeaders.indexOf('รายละเอียด');
        const locationIndex = allHeaders.indexOf('สถานที่');
        const statusIndex = allHeaders.indexOf('สถานะ');
        const fileIndex = allHeaders.findIndex(h => h.toLowerCase() === 'ไฟล์แนบ' || h.toLowerCase() === 'attachment');
        const commentIndex = allHeaders.indexOf('Admin Comments');
        const assignIndex = allHeaders.indexOf('Assigned To');
        
        // NEW: Phone index lookup
        const phoneIndex = allHeaders.findIndex(h => h === 'Phone' || h === 'เบอร์โทรศัพท์'); 
        // NEW: Employee ID index lookup
        const employeeIdIndex = allHeaders.findIndex(h => h === 'Employee ID' || h === 'รหัสพนักงาน'); 
        
        // NEW: Check for Admin Attachments Column (Assumed Col 13 / Index 12 based on previous discussion)
        // Better: look for header
        let adminFileIndex = allHeaders.findIndex(h => h.toLowerCase().includes('admin attachment') || h.includes('รูปปิดงาน'));
        if (adminFileIndex === -1 && allHeaders.length >= 13) {
             adminFileIndex = 12; // Fallback to 13th column (index 12) if header not found but data exists
        }

        const type = typeIndex !== -1 ? record[typeIndex] : 'N/A';
        const status = statusIndex !== -1 ? record[statusIndex] : 'N/A';
        const currentAssignee = assignIndex !== -1 ? (record[assignIndex] || '') : '';
        
        originalStatusOnOpen = status;
        originalAssigneeOnOpen = currentAssignee; 
        
        updateModalStatusStrips(status);

        const modalIcon = document.getElementById('details-modal-icon');
        const modalHeader = document.getElementById('details-modal-header');
        modalHeader.classList.remove('header-default', 'header-complaint', 'header-suggestion', 'header-report');
        
        // ADDED: Logic for new Report Issue type
        if (type === 'คำร้องเรียน') {
            modalHeader.classList.add('header-complaint'); 
            modalIcon.innerHTML = '<svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
        } else if (type === 'ข้อเสนอแนะ') { 
            modalHeader.classList.add('header-suggestion');
            modalIcon.innerHTML = '<svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
        } else if (type === 'แจ้งปัญหา') { 
            modalHeader.classList.add('header-report');
            // NEW ICON: Gear (Consistent with list view)
             modalIcon.innerHTML = '<svg class="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>';
        } else {
            modalHeader.classList.add('header-default');
             modalIcon.innerHTML = '<svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
        }

        document.getElementById('details-modal-type-header').textContent = type;
        document.getElementById('details-modal-ticket-id').textContent = ticketIdIndex !== -1 ? record[ticketIdIndex] : 'N/A';
        document.getElementById('details-modal-topic').textContent = topicIndex !== -1 ? (record[topicIndex] || '-') : '-';
        document.getElementById('details-modal-details').textContent = detailsIndex !== -1 ? (record[detailsIndex] || '-') : '-';
        
        const locationText = locationIndex !== -1 ? (record[locationIndex] || '-') : '-';
        
        // ===== START: MODIFICATION (Display Dynamic Badges) =====
        const phoneVal = phoneIndex !== -1 ? (record[phoneIndex] || '') : '';
        const employeeIdVal = employeeIdIndex !== -1 ? (record[employeeIdIndex] || '') : '';
        
        // 1. Change Label Text Dynamically
        const locationEl = document.getElementById('details-modal-location');
        if(locationEl && locationEl.previousElementSibling) {
            locationEl.previousElementSibling.textContent = 'สถานที่ & ข้อมูลติดต่อ';
        }

        // 2. Build Content
        let locationHtmlContent = `<div class="mb-2 text-slate-700">${escapeHtml(locationText)}</div>`;
        let badgesHtml = '<div class="flex flex-wrap gap-2">';
        
        // Phone Badge (Blue)
        if (phoneVal) {
             badgesHtml += `
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-100 text-xs font-bold shadow-sm">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    <a href="tel:${escapeHtml(phoneVal)}" class="hover:underline" title="กดเพื่อโทร">${escapeHtml(phoneVal)}</a>
                </span>
             `;
        }
        
        // Employee ID Badge (Purple)
        if (employeeIdVal) {
             badgesHtml += `
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-purple-50 text-purple-700 border border-purple-100 text-xs font-bold shadow-sm">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/></svg>
                    <span>Employee ID: ${escapeHtml(employeeIdVal)}</span>
                </span>
             `;
        }
        badgesHtml += '</div>';

        if (phoneVal || employeeIdVal) {
            document.getElementById('details-modal-location').innerHTML = locationHtmlContent + badgesHtml;
        } else {
            document.getElementById('details-modal-location').textContent = locationText;
        }
        // ===== END: MODIFICATION =====

        const dateValue = dateIndex !== -1 ? record[dateIndex] : null;
        let formattedDate = '-';
         try {
             if (dateValue) {
                 formattedDate = parseThaiDate(dateValue);
             }
         } catch(e){}
         
        document.getElementById('details-modal-date').textContent = formattedDate;

        const statusSelect = detailsModalStatusSelect; 
        statusSelect.innerHTML = `
            <option value="ยังไม่ดำเนินการ">New</option>
            <option value="กำลังดำเนินการ">In Progress</option>
            <option value="เสร็จสิ้น">Completed</option>
            <option value="ยกเลิก">Cancelled</option>
        `;
        statusSelect.value = status; 
        
        statusSelect.removeEventListener('change', validateModalChanges);
        statusSelect.addEventListener('change', validateModalChanges);

        const assignSelect = detailsModalAssignSelect;
        assignSelect.innerHTML = ''; 
        
        const unassignedOption = document.createElement('option');
        unassignedOption.value = "";
        unassignedOption.textContent = "(ยังไม่ระบุหน่วยงาน)";
        assignSelect.appendChild(unassignedOption);

        if (assignableUserList && assignableUserList.length > 0) {
            assignableUserList.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                assignSelect.appendChild(option);
            });
        }
        assignSelect.value = currentAssignee;
        assignSelect.removeEventListener('change', validateModalChanges);
        assignSelect.addEventListener('change', validateModalChanges);

        document.getElementById('save-all-success').classList.add('hidden'); 
        document.getElementById('save-all-error').classList.add('hidden'); 

        // ===== NEW THUMBNAIL LOGIC (MULTIPLE FILES + SLIDESHOW) =====
        const rawFileUrls = fileIndex !== -1 ? record[fileIndex] : null;
        const attachmentDiv = document.getElementById('details-modal-attachment');
        attachmentDiv.innerHTML = ''; 
        
        currentLightboxImages = []; // Reset lightbox images

        if (rawFileUrls) {
            const urls = rawFileUrls.toString().split(',').map(u => u.trim()).filter(u => u);

            if (urls.length > 0) {
                urls.forEach((fileUrl, i) => {
                    if (fileUrl && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {
                        const fileId = getDriveId(fileUrl);
                        let html = '';

                        if (fileId) {
                            // Drive Image Logic
                            const thumbnailSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                            const largeImageSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200`;
                            
                            // Add to lightbox collection
                            currentLightboxImages.push({
                                src: largeImageSrc,
                                download: fileUrl
                            });
                            
                            const lightboxIndex = currentLightboxImages.length - 1;

                            html = `
                                <div class="group relative inline-block">
                                    <div class="relative overflow-hidden rounded-lg border border-slate-200 shadow-sm cursor-pointer bg-slate-50 transition-all hover:shadow-md" 
                                         onclick="openLightbox(${lightboxIndex})"
                                         style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center;">
                                    
                                        <img src="${thumbnailSrc}" 
                                             alt="Attachment" 
                                             class="max-w-full max-h-full object-cover"
                                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'flex flex-col items-center gap-2 p-4 text-slate-500 transition-colors w-[120px] h-[120px] justify-center border border-slate-200 rounded-lg\\'><svg class=\\'w-8 h-8\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\\'></path></svg><span class=\\'text-xs font-bold truncate w-full text-center\\'>เปิดไฟล์</span></div>'">
                                    </div>
                                    <a href="${escapeHtml(fileUrl)}" target="_blank" class="block mt-1 text-center text-xs font-bold text-indigo-500 hover:text-indigo-700 hover:underline truncate w-[120px]" title="เปิดไฟล์">
                                        เปิดไฟล์
                                    </a>
                                </div>
                            `;
                        } else {
                            // Non-Drive Link Fallback (Button style)
                            html = `
                                <a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener noreferrer" class="inline-flex flex-col items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-50 hover:border-indigo-300 shadow-sm transition-all" style="width: 120px; height: 120px;">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                    <span class="text-xs">เปิดไฟล์แนบ</span>
                                </a>
                            `;
                        }
                        attachmentDiv.insertAdjacentHTML('beforeend', html);
                    }
                });
            } else {
                 attachmentDiv.innerHTML = '<span class="text-slate-400 text-sm italic">ไม่มีไฟล์แนบ</span>';
            }
        } else {
            attachmentDiv.innerHTML = '<span class="text-slate-400 text-sm italic">ไม่มีไฟล์แนบ</span>';
        }
        
        // ===== ADMIN ATTACHMENTS DISPLAY LOGIC =====
        const adminRawFileUrls = adminFileIndex !== -1 ? record[adminFileIndex] : null;
        
        if (adminAttachmentWrapper) {
            if (adminRawFileUrls) {
                adminAttachmentWrapper.classList.remove('hidden');
                detailsModalAdminAttachmentDisplay.innerHTML = '';
                
                const adminUrls = adminRawFileUrls.toString().split(',').map(u => u.trim()).filter(u => u);
                
                if (adminUrls.length > 0) {
                     adminUrls.forEach((fileUrl, i) => {
                         if (fileUrl && (fileUrl.startsWith('http://') || fileUrl.startsWith('https://'))) {
                            const fileId = getDriveId(fileUrl);
                            let html = '';
                            if (fileId) {
                                // Drive Image
                                const thumbnailSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                                const largeImageSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200`;
                                
                                // Add to lightbox (continue indexing)
                                currentLightboxImages.push({
                                    src: largeImageSrc,
                                    download: fileUrl
                                });
                                const lightboxIndex = currentLightboxImages.length - 1;

                                html = `
                                    <div class="group relative inline-block">
                                        <div class="relative overflow-hidden rounded-lg border-2 border-indigo-100 shadow-sm cursor-pointer bg-slate-50 transition-all hover:shadow-md" 
                                             onclick="openLightbox(${lightboxIndex})"
                                             style="width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;">
                                        
                                            <img src="${thumbnailSrc}" 
                                                 alt="Admin Attachment" 
                                                 class="max-w-full max-h-full object-cover"
                                                 onerror="this.onerror=null; this.parentElement.innerHTML='<span class=\\'text-[10px] text-slate-400\\'>File</span>'">
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Non-Drive Link
                                html = `
                                    <a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener noreferrer" class="inline-flex flex-col items-center justify-center gap-1 px-2 py-2 bg-indigo-50 border border-indigo-100 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 shadow-sm transition-all" style="width: 100px; height: 100px;">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        <span>เปิดไฟล์</span>
                                    </a>
                                `;
                            }
                            detailsModalAdminAttachmentDisplay.insertAdjacentHTML('beforeend', html);
                         }
                     });
                }
            } else {
                adminAttachmentWrapper.classList.add('hidden');
                detailsModalAdminAttachmentDisplay.innerHTML = '';
            }
        }
        // ===== END NEW THUMBNAIL LOGIC =====

        detailsModalNewComment.value = ''; 
        detailsModalNewComment.removeEventListener('input', validateModalChanges);
        detailsModalNewComment.addEventListener('input', validateModalChanges);
        
        const comments = commentIndex !== -1 ? (record[commentIndex] || '') : 'Error: "Admin Comments" column not found.';
        currentHistoryComments = comments;
        activeHistoryFilter = 'all';

        // ===== START: LATEST NOTE LOGIC (STICKY NOTE) =====
        let latestNoteEntry = null;
        if (comments) {
            const entries = comments.split('\n\n');
            // Loop backwards to find the latest "Note"
            for (let i = entries.length - 1; i >= 0; i--) {
                if (entries[i].includes('📝 [Note]:')) {
                    latestNoteEntry = entries[i];
                    break;
                }
            }
        }
        renderStickyNote(latestNoteEntry);
        // ===== END: LATEST NOTE LOGIC =====
        
        const historyZone = document.getElementById('modal-history-zone');
        if(historyZone) {
            historyZone.classList.add('flex', 'flex-col'); 
            
            const headerFlex = historyZone.querySelector('.flex.items-center.justify-between');
            if(headerFlex) {
                 headerFlex.innerHTML = `
                    <div class="flex items-center gap-3">
                         <span class="p-2 bg-orange-50 text-orange-600 rounded-xl">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         </span>
                         <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">ประวัติการดำเนินการ</h3>
                     </div>
                  `;
            }
            
            let legendFooter = historyZone.querySelector('.legend-footer');
            if (!legendFooter) {
                const footerHtml = `
                    <div id="history-legend-footer" class="legend-footer mt-auto pt-3 border-t border-slate-100 flex flex-wrap gap-2 justify-end items-center">
                        <button onclick="filterHistory('all')" data-filter="all" class="history-filter-btn inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200 gap-1 hover:bg-slate-200 transition-all">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            ทั้งหมด
                        </button>
                        
                        <button onclick="filterHistory('status')" data-filter="status" class="history-filter-btn inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 gap-1 hover:bg-indigo-100 transition-all">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            สถานะ
                        </button>
                        <button onclick="filterHistory('assign')" data-filter="assign" class="history-filter-btn inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-purple-50 text-purple-600 border border-purple-100 gap-1 hover:bg-purple-100 transition-all">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            มอบหมาย
                        </button>
                        <button onclick="filterHistory('public')" data-filter="public" class="history-filter-btn inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-orange-50 text-orange-600 border border-orange-100 gap-1 hover:bg-orange-100 transition-all">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                            แจ้งผู้ใช้
                        </button>
                        <button onclick="filterHistory('admin')" data-filter="admin" class="history-filter-btn inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-slate-50 text-slate-600 border border-slate-200 gap-1 hover:bg-slate-100 transition-all">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                            คอมเมนต์แอดมิน
                        </button>
                    </div>
                `;
                historyZone.insertAdjacentHTML('beforeend', footerHtml);
            } else {
                 updateFilterButtonStyles('all');
            }
        }
        
        const commentsDisplay = document.getElementById('details-modal-comments-display');
        if (commentsDisplay) {
             commentsDisplay.classList.add('p-4'); 
        }
        
        renderLogEntries(currentHistoryComments, commentsDisplay, activeHistoryFilter);

        validateModalChanges();

        detailsModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    // ===== NEW FUNCTION: RENDER STICKY NOTE =====
    function renderStickyNote(entry) {
        // Target specific container created in admin.html
        const container = document.getElementById('admin-sticky-note-container');
        if (!container) return; // Safety check

        if (!entry) {
            container.innerHTML = '';
            container.classList.add('hidden');
            return;
        }

        // Parse Entry
        const regex = /^\[(.*?) - (.*?)\]: (.*)$/s; 
        const match = entry.match(regex);
        let timestamp = '-';
        let actor = 'Unknown';
        let message = entry;

        if (match) {
            timestamp = match[1];
            actor = match[2];
            message = match[3];
        }
        
        // Clean up message tag for display
        message = message.replace('📝 [Note]:', '').trim();

        // Modified HTML: 
        // 1. Removed "ล่าสุดจาก"
        // 2. Added 'whitespace-nowrap' to keeping date/name on one line if possible, or flex behavior
        // 3. Used gap-2 to separate name and timestamp
        const html = `
            <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-xl shadow-sm relative transition-all hover:bg-yellow-100/50">
                <div class="flex justify-between items-center mb-1 gap-3">
                    <span class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider flex items-center gap-1 min-w-0">
                        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="truncate">${escapeHtml(actor)}</span>
                    </span>
                    <span class="text-[10px] text-yellow-500/80 whitespace-nowrap flex-shrink-0">${escapeHtml(timestamp)}</span>
                </div>
                <p class="text-sm text-yellow-800 font-medium leading-relaxed mt-1 break-words">
                    <span class="mr-1">📝</span>${linkify(message)}
                </p>
            </div>
        `;

        container.innerHTML = html;
        container.classList.remove('hidden');
    }
    // ===== END: RENDER STICKY NOTE =====
    
    function filterHistory(filterType) {
        const commentsDisplay = document.getElementById('details-modal-comments-display');
        
        if (filterType === 'all') {
            activeHistoryFilter = 'all';
        } else {
             if (activeHistoryFilter === filterType) {
                activeHistoryFilter = 'all';
            } else {
                activeHistoryFilter = filterType;
            }
        }

        renderLogEntries(currentHistoryComments, commentsDisplay, activeHistoryFilter);
        
        updateFilterButtonStyles(activeHistoryFilter);
    }
    
    function updateFilterButtonStyles(activeFilter) {
        const buttons = document.querySelectorAll('.history-filter-btn');
        buttons.forEach(btn => {
            const btnFilter = btn.dataset.filter;
            
            if (activeFilter === 'all') {
                btn.style.opacity = '1';
                btn.classList.remove('ring-2', 'ring-offset-1', 'ring-indigo-300'); 
                
                if(btnFilter === 'all') {
                     btn.classList.add('ring-2', 'ring-offset-1', 'ring-slate-300');
                } else {
                     btn.classList.remove('ring-2', 'ring-offset-1', 'ring-slate-300');
                }

            } else {
                if (btnFilter === activeFilter) {
                    btn.style.opacity = '1';
                     if(btnFilter === 'all') btn.classList.add('ring-slate-300');
                     else if(btnFilter === 'status') btn.classList.add('ring-indigo-300');
                     else if(btnFilter === 'assign') btn.classList.add('ring-purple-300');
                     else if(btnFilter === 'public') btn.classList.add('ring-orange-300');
                     else if(btnFilter === 'admin') btn.classList.add('ring-slate-300');
                     
                     btn.classList.add('ring-2', 'ring-offset-1');

                } else {
                    btn.style.opacity = '0.4';
                    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-indigo-300', 'ring-purple-300', 'ring-orange-300', 'ring-slate-300');
                }
            }
        });
    }

    function renderLogEntries(commentsString, containerElement, filterType = 'all') {
        containerElement.innerHTML = ''; 

        if (!commentsString || commentsString.trim() === '') {
            containerElement.innerHTML = '<div class="flex flex-col items-center justify-center py-8 text-slate-400 opacity-60"><svg class="w-12 h-12 mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-sm">ยังไม่มีประวัติการดำเนินการ</span></div>';
            return;
        }

        const entries = commentsString.split('\n\n').filter(e => e.trim()); 
        
        const timelineWrapper = document.createElement('div');
        timelineWrapper.className = 'relative space-y-0 ml-2';
        
        let visibleCount = 0;

        entries.forEach((entry, index) => {
            const isLast = index === entries.length - 1;
            
            const regex = /^\[(.*?) - (.*?)\]: (.*)$/s; 
            const match = entry.match(regex);
            
            let timestamp = '';
            let actor = 'System';
            let message = entry;
            
            if (match) {
                timestamp = match[1];
                actor = match[2];
                message = match[3];
            } else {
                timestamp = '-';
            }

            let icon = '';
            let colorClass = '';
            let borderColorClass = '';
            let boxBorderClass = '';
            let entryType = 'admin'; 
            
            if (message.includes('เปลี่ยนสถานะ')) {
                entryType = 'status';
                colorClass = 'text-indigo-500 border-indigo-100 bg-indigo-50';
                borderColorClass = 'border-l-indigo-500';
                boxBorderClass = 'border-indigo-200';
                icon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
            } else if (message.includes('เปลี่ยนผู้รับผิดชอบ') || message.includes('เปลี่ยนหน่วยงานที่รับผิดชอบ')) {
                entryType = 'assign';
                colorClass = 'text-purple-500 border-purple-100 bg-purple-50';
                borderColorClass = 'border-l-purple-500'; 
                boxBorderClass = 'border-purple-200';
                icon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
            } else if (message.includes('คอมเมนต์สรุป') || message.includes('Public Note')) {
                entryType = 'public';
                colorClass = 'text-orange-500 border-orange-100 bg-orange-50';
                borderColorClass = 'border-l-orange-500'; 
                boxBorderClass = 'border-orange-200';
                icon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>';
            
            // ===== NEW LOGIC FOR INTERNAL NOTES (HIGHLIGHTED) =====
            } else if (message.includes('📝 [Note]:')) {
                entryType = 'admin'; // Keep in admin filter
                // Highlighted Style for Notes
                colorClass = 'text-yellow-600 border-yellow-200 bg-yellow-50';
                borderColorClass = 'border-l-yellow-400'; 
                boxBorderClass = 'border-yellow-100 bg-yellow-50/50'; 
                icon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>';
                
                // Optional: Clean up message for display (remove tag)
                // message = message.replace('📝 [Note]:', '').trim();
            } else {
                entryType = 'admin';
                colorClass = 'text-slate-500 border-slate-200 bg-white';
                borderColorClass = 'border-l-slate-400'; 
                boxBorderClass = 'border-slate-200';
                icon = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>';
            }

            if (filterType !== 'all' && entryType !== filterType) {
                return; 
            }
            
            visibleCount++;

            const item = document.createElement('div');
            item.className = `relative pl-8 ${isLast ? '' : 'pb-6'}`;
            item.dataset.type = entryType;
            
            item.innerHTML = `
                ${isLast ? '' : '<div class="absolute top-3 left-3.5 w-0.5 h-full bg-slate-200 -z-10"></div>'}
                
                <div class="absolute top-0 left-0 w-8 h-8 rounded-full border-2 flex items-center justify-center shadow-sm z-10 ${colorClass}">
                    ${icon}
                </div>

                <div class="bg-white rounded-xl border ${boxBorderClass} border-l-4 ${borderColorClass} p-3 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-slate-700">${escapeHtml(actor)}</span>
                        <span class="text-[10px] font-medium text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100">${escapeHtml(timestamp)}</span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap break-words">${linkify(message)}</p>
                </div>
            `;
            
            timelineWrapper.appendChild(item);
        });
        
        if (visibleCount === 0 && filterType !== 'all') {
             containerElement.innerHTML = '<div class="flex flex-col items-center justify-center py-8 text-slate-400 opacity-60 italic text-sm">ไม่พบประวัติประเภทนี้</div>';
        } else {
             containerElement.appendChild(timelineWrapper);
        }
    }

    function validateModalChanges() {
        if (!saveAllDetailsBtn || !detailsModalStatusSelect || !detailsModalNewComment || !detailsModalAssignSelect) return;

        const newStatus = detailsModalStatusSelect.value;
        const newComment = detailsModalNewComment.value.trim();
        const newAssignee = detailsModalAssignSelect.value; 
        
        // NEW: Check if files are selected
        const hasFiles = adminFileObjects.length > 0;

        const hasStatusChanged = (newStatus !== originalStatusOnOpen);
        const hasNewComment = (newComment !== '');
        const hasAssigneeChanged = (newAssignee !== originalAssigneeOnOpen);

        if (hasStatusChanged || hasNewComment || hasAssigneeChanged || hasFiles) { 
            saveAllDetailsBtn.disabled = false;
            saveAllDetailsBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
        } else {
            saveAllDetailsBtn.disabled = true;
            saveAllDetailsBtn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
        }

        updateModalStatusStrips(newStatus);
    }

    function updateModalStatusStrips(status) {
        const strips = [
            document.getElementById('details-modal-strip-info'),
            document.getElementById('details-modal-strip-history'),
            document.getElementById('details-modal-strip-admin')
        ];
        
        let theme = {
            gradient: 'from-slate-400 to-slate-500',
            badgeClass: 'bg-slate-100 text-slate-600 border-slate-200',
            statusLabel: 'ยังไม่ดำเนินการ (New)',
            adminBorder: 'border-slate-200',
            adminShadow: 'shadow-slate-100',
            adminIconBg: 'bg-slate-100',
            adminIconText: 'text-slate-500',
            adminTitleText: 'text-slate-700'
        };
        
        if (status === 'กำลังดำเนินการ') {
            theme = {
                gradient: 'from-yellow-400 to-orange-500',
                badgeClass: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                statusLabel: 'กำลังดำเนินการ (In Progress)',
                adminBorder: 'border-yellow-200',
                adminShadow: 'shadow-yellow-100',
                adminIconBg: 'bg-yellow-100',
                adminIconText: 'text-yellow-600',
                adminTitleText: 'text-yellow-700'
            };
        } else if (status === 'เสร็จสิ้น') {
            theme = {
                gradient: 'from-green-400 to-emerald-600',
                badgeClass: 'bg-green-100 text-green-800 border-green-200',
                statusLabel: 'เสร็จสิ้น (Completed)',
                adminBorder: 'border-green-200',
                adminShadow: 'shadow-green-100',
                adminIconBg: 'bg-green-100',
                adminIconText: 'text-green-600',
                adminTitleText: 'text-green-700'
            };
        } else if (status === 'ยกเลิก') {
            theme = {
                gradient: 'from-red-400 to-rose-600',
                badgeClass: 'bg-red-100 text-red-800 border-red-200',
                statusLabel: 'ยกเลิก (Cancelled)',
                adminBorder: 'border-red-200',
                adminShadow: 'shadow-red-100',
                adminIconBg: 'bg-red-100',
                adminIconText: 'text-red-600',
                adminTitleText: 'text-red-700'
            };
        }

        strips.forEach(strip => {
            if(strip) {
                strip.className = `absolute top-0 left-0 w-full h-2 transition-all duration-500 bg-gradient-to-r ${theme.gradient}`;
            }
        });

        const statusBadge = document.getElementById('details-modal-status-badge');
        if (statusBadge) {
            statusBadge.className = `px-3 py-1 rounded-full text-sm font-bold border shadow-sm transition-all duration-300 ${theme.badgeClass}`;
            statusBadge.textContent = theme.statusLabel;
            statusBadge.classList.remove('hidden');
        }

        const adminZone = document.getElementById('modal-admin-zone');
        if (adminZone) {
            adminZone.className = `bg-white p-6 rounded-3xl shadow-lg sticky top-0 relative overflow-hidden transition-all duration-500 ${theme.adminBorder} ${theme.adminShadow}`;
            
            const iconSpan = adminZone.querySelector('span');
            if (iconSpan) {
                 iconSpan.className = `p-2 rounded-xl transition-all duration-500 ${theme.adminIconBg} ${theme.adminIconText}`;
            }
            
            const titleH3 = adminZone.querySelector('h3');
            if (titleH3) {
                titleH3.className = `text-sm font-bold uppercase tracking-wider transition-all duration-500 ${theme.adminTitleText}`;
            }
        }
    }

    function handleSaveAllDetails() {
        const newStatus = detailsModalStatusSelect.value; 
        const newCommentText = detailsModalNewComment.value; 
        const newAssignee = detailsModalAssignSelect.value; 
        const errorEl = document.getElementById('save-all-error');

        if(errorEl) errorEl.classList.add('hidden');
        saveAllDetailsBtn.disabled = true; 

        const isClosingStatus = (newStatus === 'เสร็จสิ้น' || newStatus === 'ยกเลิก');
        const isStatusChanged = (newStatus !== originalStatusOnOpen);

        if (isClosingStatus && isStatusChanged) {
            publicCommentStatus.textContent = newStatus;
            
            const modalHeader = document.getElementById('public-comment-header');
            if(modalHeader) {
                 if(newStatus === 'เสร็จสิ้น') {
                    document.getElementById('public-comment-title').textContent = "ยืนยันการปิดงาน (เสร็จสิ้น)";
                    publicCommentStatus.className = "font-bold text-green-600";
                    modalHeader.className = "px-8 py-6 bg-gradient-to-r from-emerald-500 to-green-600 flex items-center gap-4";
                } else {
                    document.getElementById('public-comment-title').textContent = "ยืนยันการยกเลิก";
                    publicCommentStatus.className = "font-bold text-red-600";
                     modalHeader.className = "px-8 py-6 bg-gradient-to-r from-red-500 to-rose-600 flex items-center gap-4";
                }
            }
            
            publicCommentTextarea.value = ''; 
            publicCommentError.classList.add('hidden'); 
            publicCommentModal.classList.remove('hidden'); 
            publicCommentTextarea.focus();
            return;
        }

        setSaveLoading('save-all-details-btn', true);
        const ticketId = document.getElementById('details-modal-card').dataset.currentTicketId;

        // SEND ADMIN FILES (adminFileObjects) -> REMOVE THIS, send [] instead
        google.script.run
            .withSuccessHandler(onSaveSuccess) 
            .withFailureHandler(onSaveFailure) 
            .saveStatusAndComment(getSessionToken(), ticketId, newStatus, newCommentText, '', newAssignee, []); 
    }

    function handleSubmitPublicComment(e) {
        e.preventDefault();
        const publicCommentText = publicCommentTextarea.value;
        
        if (!publicCommentText || !publicCommentText.trim()) {
            publicCommentError.textContent = 'กรุณากรอกคอมเมนต์สรุปสำหรับผู้ใช้งาน';
            publicCommentError.classList.remove('hidden');
            return;
        }
        publicCommentError.classList.add('hidden');

        setSaveLoading('public-comment-submit-btn', true);

        const ticketId = document.getElementById('details-modal-card').dataset.currentTicketId;
        const newStatus = detailsModalStatusSelect.value; 
        const newCommentText = detailsModalNewComment.value; 
        const newAssignee = detailsModalAssignSelect.value; 

        // SEND ADMIN FILES (adminFileObjects) -> ADD THIS
        google.script.run
            .withSuccessHandler(onSaveSuccess) 
            .withFailureHandler(onSaveFailure) 
            .saveStatusAndComment(getSessionToken(), ticketId, newStatus, newCommentText, publicCommentText, newAssignee, adminFileObjects); 
    }

    function onSaveSuccess(response) {
        setSaveLoading('save-all-details-btn', false);
        setSaveLoading('public-comment-submit-btn', false);
        if(saveAllDetailsBtn) saveAllDetailsBtn.disabled = false; 

        const errorEl = document.getElementById('save-all-error'); 

        if (checkAuth(response, errorEl)) {
            if (response.success) {
                if(publicCommentModal) publicCommentModal.classList.add('hidden');
                showToast('บันทึกการเปลี่ยนแปลงแล้ว');
                
                if (response.newComments !== undefined) {
                     const commentsDisplay = document.getElementById('details-modal-comments-display');
                     currentHistoryComments = response.newComments;
                     
                     // RERUN: Logic to update Sticky Note & Log
                     // Find latest note again
                     let latestNoteEntry = null;
                     if (currentHistoryComments) {
                        const entries = currentHistoryComments.split('\n\n');
                        for (let i = entries.length - 1; i >= 0; i--) {
                            if (entries[i].includes('📝 [Note]:')) {
                                latestNoteEntry = entries[i];
                                break;
                            }
                        }
                     }
                     renderStickyNote(latestNoteEntry); // Update Sticky Note
                     renderLogEntries(currentHistoryComments, commentsDisplay, activeHistoryFilter); // Update Log
                }
                
                if(detailsModalNewComment) detailsModalNewComment.value = '';
                originalStatusOnOpen = detailsModalStatusSelect.value;
                originalAssigneeOnOpen = detailsModalAssignSelect.value;
                
                // Clear Admin Uploads
                adminFileObjects = [];
                if(detailsModalAdminFileInput) detailsModalAdminFileInput.value = '';
                
                validateModalChanges();
                fetchAdminData(true); 
            }
        }
    }

    function onSaveFailure(error) {
        setSaveLoading('save-all-details-btn', false);
        setSaveLoading('public-comment-submit-btn', false);
        if(saveAllDetailsBtn) saveAllDetailsBtn.disabled = false; 
        
        if (publicCommentModal && !publicCommentModal.classList.contains('hidden')) {
            publicCommentError.textContent = 'Error: ' + error.message;
            publicCommentError.classList.remove('hidden');
        } else {
            const errorEl = document.getElementById('save-all-error');
            if(errorEl) {
                errorEl.textContent = 'Error: ' + error.message;
                errorEl.classList.remove('hidden');
            }
        }
    }
    
    function openDeleteConfirmModal(username) {
        userToDeleteSpan.textContent = username;
        confirmDeleteBtn.dataset.username = username;
        deleteConfirmModal.classList.remove('hidden');
    }

    function confirmDeleteUserAction() {
        const username = confirmDeleteBtn.dataset.username;
        if (username) {
           confirmDeleteBtn.disabled = true;
           cancelDeleteBtn.disabled = true;
           google.script.run
               .withSuccessHandler(onUserDeleteSuccess)
               .withFailureHandler(onUserActionFailure) 
               .deleteUser(getSessionToken(), username);
        } else {
           deleteConfirmModal.classList.add('hidden');
        }
    }

    function onUserDeleteSuccess(response) {
        confirmDeleteBtn.disabled = false;
        cancelDeleteBtn.disabled = false;
        deleteConfirmModal.classList.add('hidden'); 

        if(checkAuth(response, userError)) { 
            displayUsers(response); 
            showToast('ลบผู้ใช้งานสำเร็จแล้ว');
        }
    }

    function onUserAddSuccess(response) {
        if(checkAuth(response, userError)) {
            displayUsers(response); 
            showToast('เพิ่มผู้ใช้งานสำเร็จแล้ว');
        }
    }

   function onUserActionFailure(error) {
         console.error("User action failed:", error);
         userError.textContent = 'เกิดข้อผิดพลาด: ' + (error.message || error);
         userError.classList.remove('hidden');
         confirmDeleteBtn.disabled = false;
         cancelDeleteBtn.disabled = false;
   }

    function displayUsers(usersData) { 
        userListContainer.innerHTML = ''; 
        userError.classList.add('hidden'); 

        if (!usersData || usersData.error) {
            userError.textContent = usersData ? usersData.error : "Failed to load users.";
            userError.classList.remove('hidden');
            userListContainer.innerHTML = '<p class="text-red-500 italic">Could not load user list.</p>';
            return;
        }
        if (!Array.isArray(usersData)) {
            userError.textContent = "Invalid user data received.";
            userError.classList.remove('hidden');
            userListContainer.innerHTML = '<p class="text-red-500 italic">Invalid data format.</p>';
            return;
        }
         if (usersData.length === 0) {
             userListContainer.innerHTML = '<p class="text-slate-500 italic">No users found.</p>';
             return;
         }

        usersData.sort((a, b) => (a.username || '').localeCompare(b.username || ''));

        usersData.forEach(user => {
            if (!user || !user.username) return;

            // Status Indicator Color
            let statusColor = 'bg-green-500';
            let opacityClass = '';
            if (user.status === 'Inactive') {
                statusColor = 'bg-slate-400';
                opacityClass = 'opacity-60';
            }
            
            const userTeam = user.team || '-'; // Get team

            const userDiv = document.createElement('div');
            userDiv.className = `flex items-center justify-between bg-white border border-slate-100 p-3 rounded-xl shadow-sm hover:shadow-md transition-smooth ${opacityClass}`;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex items-center gap-3';
            infoDiv.innerHTML = `
                <div class="relative">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">${user.username.charAt(0).toUpperCase()}</div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white ${statusColor}"></div>
                </div>
                <div>
                    <p class="text-slate-700 font-bold text-sm">${escapeHtml(user.username)}</p>
                    <div class="flex items-center gap-2 flex-wrap">
                        <p class="text-xs text-slate-400">Role: ${escapeHtml(user.role)}</p>
                        <span class="text-[10px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded border border-indigo-100 font-bold">Team: ${escapeHtml(userTeam)}</span>
                        ${user.status === 'Inactive' ? '<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">Inactive</span>' : ''}
                    </div>
                </div>`;

            const actionsDiv = document.createElement('div');
            actionsDiv.innerHTML = `
                <button onclick="openUserEditModal('${escapeHtml(user.username)}', '${user.role}', '${user.status}', '${escapeHtml(user.team || '')}', '${escapeHtml(user.allowedTypes || '')}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition-smooth flex items-center gap-1">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    <span class="text-xs font-bold">จัดการ</span>
                </button>
            `;

            userDiv.appendChild(infoDiv);
            userDiv.appendChild(actionsDiv);
            userListContainer.appendChild(userDiv);
        });
    }

    function openUserEditModal(username, currentRole, currentStatus, currentTeam, currentAllowedTypes) {
        currentUserInEditMode = username;
        userEditUsernameSpan.textContent = username;
        userEditRoleSelect.value = currentRole;
        
        // Status Logic
        if (userEditStatusToggle && userStatusLabel) {
            // Default to Active if undefined or null
            const isActive = (currentStatus === 'Active' || !currentStatus); 
            userEditStatusToggle.checked = isActive;
            updateStatusLabelUI(isActive);
        }
        
        // Set Team Input
        if (userEditTeamInput) userEditTeamInput.value = currentTeam || '';

        // NEW: Data Access Logic (Checkboxes)
        const checkboxes = document.querySelectorAll('.allowed-type-checkbox');
        
        const typesArray = currentAllowedTypes ? currentAllowedTypes.split(',').map(t => t.trim()) : [];
        checkboxes.forEach(cb => {
            cb.checked = typesArray.includes(cb.value);
        });

        userEditNewPass.value = '';
        userEditConfirmPass.value = '';
        if(userEditModal) userEditModal.classList.remove('hidden');
    }
    
    // NEW: Handle Save Data Access
    function handleUserEditSaveAccess() {
        if (!currentUserInEditMode) return;
        
        const checkboxes = document.querySelectorAll('.allowed-type-checkbox');
        const selectedTypes = [];
        checkboxes.forEach(cb => {
            if (cb.checked) selectedTypes.push(cb.value);
        });
        
        const typesString = selectedTypes.join(',');
        
        const btn = document.getElementById('user-edit-save-access-btn');
        const spinner = btn.querySelector('.spinner');
        const span = btn.querySelector('span');
        
        btn.disabled = true;
        span.classList.add('hidden');
        spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');
                
                if (checkAuth(response, userError)) {
                    if (response.success) {
                         showToast(`อัปเดตสิทธิ์การเข้าถึงของ ${currentUserInEditMode} เรียบร้อย`);
                         loadSettingsData();
                    } else {
                         alert('Error: ' + response.error);
                    }
                }
            })
            .withFailureHandler(error => {
                 btn.disabled = false;
                 span.classList.remove('hidden');
                 spinner.classList.add('hidden');
                 onUserActionFailure(error);
            })
            .updateUserAllowedTypes(getSessionToken(), currentUserInEditMode, typesString);
    }

    function updateStatusLabelUI(isActive) {
        if (!userStatusLabel) return;
        if(isActive) {
            userStatusLabel.textContent = 'Active';
            userStatusLabel.className = 'font-bold text-green-600';
        } else {
            userStatusLabel.textContent = 'Inactive';
            userStatusLabel.className = 'font-bold text-slate-400';
        }
    }
    
    // New Function for Save Team
    function handleUserEditSaveTeam() {
        if (!currentUserInEditMode) return;
        const newTeam = userEditTeamInput.value;
        
        const btn = document.getElementById('user-edit-save-team-btn');
        const spinner = btn.querySelector('.spinner');
        const span = btn.querySelector('span');
        
        btn.disabled = true;
        span.classList.add('hidden');
        spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');

                if (checkAuth(response, userError)) {
                    if (response.success) {
                         showToast(`อัปเดตทีมของ ${currentUserInEditMode} เรียบร้อย`);
                         loadSettingsData();
                    } else {
                         console.error('Failed to update team:', response.error);
                         alert('Error: ' + response.error);
                    }
                }
            })
            .withFailureHandler(error => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');
                onUserActionFailure(error);
            })
            .updateUserTeam(getSessionToken(), currentUserInEditMode, newTeam);
    }

    function handleUserEditSaveRole() {
        if (!currentUserInEditMode) return;
        const newRole = userEditRoleSelect.value;
        
        const btn = document.getElementById('user-edit-save-role-btn');
        const spinner = btn.querySelector('.spinner');
        const span = btn.querySelector('span');
        
        btn.disabled = true;
        span.classList.add('hidden');
        spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');

                if (checkAuth(response, userError)) {
                    if (response.success) {
                         showToast(`อัปเดตสิทธิ์ของ ${currentUserInEditMode} เป็น ${newRole} เรียบร้อย`);
                         loadSettingsData();
                    } else {
                         console.error('Failed to update role:', response.error);
                         alert('Error: ' + response.error);
                    }
                }
            })
            .withFailureHandler(error => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');
                onUserActionFailure(error);
            })
            .updateUserRole(getSessionToken(), currentUserInEditMode, newRole);
    }

    function handleUserEditSavePass() {
        if (!currentUserInEditMode) return;
        const newPass = userEditNewPass.value;
        const confirmPass = userEditConfirmPass.value;

        if (newPass !== confirmPass) {
            alert('รหัสผ่านใหม่ไม่ตรงกัน');
            return;
        }
        if (newPass.length < 6) {
            alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
            return;
        }

        const btn = document.getElementById('user-edit-save-pass-btn');
        const spinner = btn.querySelector('.spinner');
        const span = btn.querySelector('span');

        btn.disabled = true;
        span.classList.add('hidden');
        spinner.classList.remove('hidden');

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');

                if (checkAuth(response, userError)) {
                    if (response.success) {
                        showToast('เปลี่ยนรหัสผ่านสำเร็จ');
                        userEditNewPass.value = '';
                        userEditConfirmPass.value = '';
                    } else {
                        alert('Error: ' + (response.message || response.error));
                    }
                }
            })
            .withFailureHandler(error => {
                btn.disabled = false;
                span.classList.remove('hidden');
                spinner.classList.add('hidden');
                onUserActionFailure(error);
            })
            .changePassword(getSessionToken(), currentUserInEditMode, newPass);
    }

    function handleDeleteUserClick() {
        if (currentUserInEditMode) {
            if(userEditModal) userEditModal.classList.add('hidden'); 
            openDeleteConfirmModal(currentUserInEditMode); 
        }
    }

    function openChangePasswordModal(username) {
        changePasswordForm.reset();
        changePassSuccess.classList.add('hidden');
        changePassError.classList.add('hidden');
        document.getElementById('changePassModalUsername').textContent = username;
        document.getElementById('usernameToChange').value = username;
        changePasswordModal.classList.remove('hidden');
    }

    function displayCoreSettings(response) {
        if (checkAuth(response, document.getElementById('core-settings-error'))) {
            if (response.settings) {
                coreEmailInput.value = response.settings.email || '';
            }
        }
    }

    function displayLogoUrl(url) {
         if (typeof url === 'object' && url !== null && url.error) {
           checkAuth(url); 
           logoUrlInput.value = ''; 
         } else if (checkAuth(url)) { 
           logoUrlInput.value = url || '';
         }
        updateLogoPreview();
    }

    function escapeHtmlForTextarea(text) {
         if (text === null || text === undefined) return '';
         return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function displayTranslations(data) {
        translationContainer.innerHTML = ''; 
        if(checkAuth(data)) { 
             if (!data || !Array.isArray(data)) {
                 translationContainer.innerHTML = '<p class="text-red-500 p-4">Error: Invalid data format.</p>'; return;
             }
             if (data.length < 1) {
                 translationContainer.innerHTML = '<p class="text-slate-500 p-4">No translation data found.</p>'; return;
             }
             
             // Extract Headers: [Key, Description, th, en, ...]
             const headers = data.shift();
             translationHeaders = headers; // Store globally for save logic
             
             // Language Headers start from index 2 (0=Key, 1=Desc)
             const langHeaders = headers.slice(2);

             // Grouping Logic
             const groups = {};
             
             data.forEach(row => {
                 const key = row[0];
                 if (!key) return;
                 
                 // Determine Prefix (e.g. 'type', 'status', 'manual')
                 const parts = key.split('_');
                 let prefix = parts.length > 1 ? parts[0] : 'General';
                 // Capitalize
                 prefix = prefix.charAt(0).toUpperCase() + prefix.slice(1);

                 if (!groups[prefix]) groups[prefix] = [];
                 groups[prefix].push(row);
             });

             let html = '';
             let firstGroup = true;
             
             // Iterate groups and build Accordion
             for (const [groupName, rows] of Object.entries(groups)) {
                 const isOpen = firstGroup ? '' : 'hidden'; // Open first group by default
                 const rotateClass = firstGroup ? 'rotate-180' : '';
                 
                 html += `
                    <div class="border border-slate-200 rounded-xl overflow-hidden mb-4 transition-all duration-300">
                        <button type="button" class="w-full px-6 py-4 bg-slate-50 hover:bg-slate-100 flex justify-between items-center text-left focus:outline-none" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180');">
                            <span class="font-bold text-slate-700 text-sm uppercase tracking-wider flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                                ${escapeHtml(groupName)} 
                                <span class="text-slate-400 font-normal text-xs ml-1">(${rows.length} keys)</span>
                            </span>
                            <svg class="w-5 h-5 text-slate-400 transform transition-transform duration-300 ${rotateClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="bg-white p-0 ${isOpen} border-t border-slate-200">
                            <table class="min-w-full divide-y divide-slate-100 text-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase w-1/3 bg-slate-50/80 sticky top-0 z-10">รายการ (Key / Description)</th>
                                        ${langHeaders.map(h => `<th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase bg-slate-50/80 sticky top-0 z-10 min-w-[200px]">${escapeHtml(h)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                 `;

                 rows.forEach(row => {
                     const key = row[0];
                     const desc = row[1]; // Column 1 is Description
                     const langs = row.slice(2);

                     html += `
                        <tr class="hover:bg-slate-50 group transition-colors">
                            <td class="px-4 py-4 align-top">
                                <div class="font-bold text-slate-700 text-sm mb-1">${escapeHtml(desc || key)}</div>
                                <div class="text-[10px] text-slate-400 font-mono bg-slate-100 inline-block px-1.5 py-0.5 rounded border border-slate-200 select-all cursor-text" title="Copy Key">${escapeHtml(key)}</div>
                                <input type="hidden" name="key" value="${escapeHtml(key)}">
                                <input type="hidden" name="desc" value="${escapeHtml(desc || '')}">
                            </td>
                      `;

                     langs.forEach((langVal, idx) => {
                         html += `
                            <td class="px-2 py-2 align-top">
                                <textarea rows="2" class="w-full resize-none px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-slate-600 text-sm transition-shadow focus:shadow-sm placeholder-slate-300" placeholder="${escapeHtml(langHeaders[idx])}...">${escapeHtmlForTextarea(langVal)}</textarea>
                            </td>
                         `;
                     });

                     html += `</tr>`;
                 });

                 html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                 `;
                 firstGroup = false;
             }
             
             translationContainer.innerHTML = html;
        } else { 
             if (data && data.error) translationContainer.innerHTML = '<p class="text-red-500 p-4">Error: ' + escapeHtml(data.error) + '</p>';
        }
    }

    function displayProfanityList(words) {
        profanityListDisplay.innerHTML = ''; 
        profanityError.classList.add('hidden'); 
        if(checkAuth(words, profanityError)) { 
             if (Array.isArray(words)) { 
                 if (words.length === 0) {
                     profanityListDisplay.innerHTML = '<span class="text-slate-400 italic p-2">No words yet.</span>';
                 } else {
                     words.sort((a, b) => a.localeCompare(b));
                     words.forEach(createProfanityTag);
                 }
             }
        }
    }

    function createProfanityTag(word) {
        if (!word || typeof word !== 'string' || !word.trim()) return;
        const wordText = word.trim();
         const existingTags = profanityListDisplay.querySelectorAll('.profanity-tag span');
         for (let span of existingTags) { if (span.textContent.toLowerCase() === wordText.toLowerCase()) return; } 
        const emptyMessage = profanityListDisplay.querySelector('.italic');
        if (emptyMessage) profanityListDisplay.innerHTML = '';
        
        const tag = document.createElement('span');
        tag.className = 'profanity-tag inline-flex items-center bg-rose-50 text-rose-700 px-3 py-1 rounded-full text-sm font-medium m-1 border border-rose-100';
        tag.innerHTML = '<span>' + escapeHtml(wordText) + '</span><button type="button" class="ml-2 text-rose-400 hover:text-rose-600 font-bold">&times;</button>';
        tag.querySelector('button').addEventListener('click', () => {
            tag.remove();
            if (profanityListDisplay.children.length === 0) profanityListDisplay.innerHTML = '<span class="text-slate-400 italic p-2">No words yet.</span>';
        });
        profanityListDisplay.appendChild(tag);
    }

    function addProfanityWordTag() {
        const rawInput = newProfanityWordInput.value;
        if (!rawInput || !rawInput.trim()) {
             profanityError.textContent = 'Please enter a word.';
             profanityError.classList.remove('hidden');
             newProfanityWordInput.focus();
             return;
        }

        // Split by comma or space (including multiple spaces)
        const words = rawInput.split(/[\s,]+/).filter(w => w.trim().length > 0);
        
        if (words.length > 0) {
            words.forEach(word => createProfanityTag(word));
            newProfanityWordInput.value = ''; 
            profanityError.classList.add('hidden');
        }
         newProfanityWordInput.focus();
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe === null || unsafe === undefined ? '' : String(unsafe);
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/`/g, "&#96;");
    }

    function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; 
            return date.toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }

    function updateLogoPreview() {
        const url = logoUrlInput.value;
        if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
            logoPreview.src = url;
            logoPreview.classList.remove('hidden');
            logoPlaceholder.classList.add('hidden');
            logoPreview.onerror = () => { logoPreview.src = ''; logoPreview.classList.add('hidden'); logoPlaceholder.classList.remove('hidden'); };
        } else { logoPreview.src = ''; logoPreview.classList.add('hidden'); logoPlaceholder.classList.remove('hidden'); }
    }

    function showToast(message) {
        clearTimeout(toastTimer); toastMessage.textContent = message;
        toastNotification.classList.remove('opacity-0', 'translate-y-24');
        toastTimer = setTimeout(() => { toastNotification.classList.add('opacity-0', 'translate-y-24'); }, 3000);
    }

    function setLoginLoading(isLoading) {
        const btn = document.getElementById('loginBtn'); const text = document.getElementById('loginBtnText'); const spinner = document.getElementById('loginSpinner');
        if(btn) btn.disabled = isLoading; 
        if(text) text.classList.toggle('hidden', isLoading); 
        if(spinner) spinner.classList.toggle('hidden', !isLoading);
    }

    function setChangePassLoading(isLoading) {
        const btn = document.getElementById('changePassSubmitBtn'); const text = document.getElementById('changePassBtnText'); const spinner = document.getElementById('changePassSpinner');
        if(btn) btn.disabled = isLoading; 
        if(text) text.classList.toggle('hidden', isLoading); 
        if(spinner) spinner.classList.toggle('hidden', !isLoading);
    }

    function onDataSaveSuccess(buttonId, successElement, errorElement) {
        return function(response) {
            setSaveLoading(buttonId, false);
            if (checkAuth(response, errorElement)) { if (response.success) { if (successElement) { successElement.classList.remove('hidden'); setTimeout(() => successElement.classList.add('hidden'), 2000); } if (errorElement) errorElement.classList.add('hidden'); } }
        }
    }
    function onDataSaveFailure(buttonId, errorElement) {
         return function(error) { setSaveLoading(buttonId, false); const errorMsg = 'Error: ' + (error.message || error); if (errorElement) { errorElement.textContent = errorMsg; errorElement.classList.remove('hidden'); } else alert(errorMsg); }
    }
    function setSaveLoading(buttonId, isLoading) {
        const btn = document.getElementById(buttonId); if (!btn) return;
        const content = btn.querySelector('.btn-content'); const spinner = btn.querySelector('.spinner');
        btn.disabled = isLoading; if (content) content.classList.toggle('hidden', isLoading); if (spinner) spinner.classList.toggle('hidden', !isLoading);
    }

    // --- CHARTS (Updated Styles) ---
    function renderStatusChart(counts) {
        const ctx = document.getElementById('statusChart').getContext('2d'); 
        if (statusChartInstance) { statusChartInstance.destroy(); }
        const chartValues = [ counts['ยังไม่ดำเนินการ'] || 0, counts['กำลังดำเนินการ'] || 0, counts['เสร็จสิ้น'] || 0, counts['ยกเลิก'] || 0 ];
        
        const newGradient = ctx.createLinearGradient(0, 0, 0, 400);
        newGradient.addColorStop(0, '#22d3ee'); 
        newGradient.addColorStop(1, '#93c5fd');

        const inProgressGradient = ctx.createLinearGradient(0, 0, 0, 400);
        inProgressGradient.addColorStop(0, '#fb923c');
        inProgressGradient.addColorStop(1, '#fcd34d');

        const completedGradient = ctx.createLinearGradient(0, 0, 0, 400);
        completedGradient.addColorStop(0, '#22c55e');
        completedGradient.addColorStop(1, '#6ee7b7');

        const cancelledGradient = ctx.createLinearGradient(0, 0, 0, 400);
        cancelledGradient.addColorStop(0, '#ef4444');
        cancelledGradient.addColorStop(1, '#fda4af');

        statusChartInstance = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: ['New', 'In Progress', 'Completed', 'Cancelled'], 
                datasets: [{ 
                    data: chartValues, 
                    backgroundColor: [ newGradient, inProgressGradient, completedGradient, cancelledGradient ], 
                    borderWidth: 0,
                    hoverOffset: 4
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { family: "'Sarabun', sans-serif" } } } },
                layout: { padding: 20 } 
            } 
        });
    }

    function renderTypeChart(summary) {
        const ctx = document.getElementById('typeChart').getContext('2d'); 
        if (typeChartInstance) { typeChartInstance.destroy(); }
        // NEW: Include 'Report Issue' in chart
        const chartValues = [ summary.complaints || 0, summary.suggestions || 0, summary.reportIssues || 0 ];

        const complaintGradient = ctx.createLinearGradient(0, 0, 0, 400);
        complaintGradient.addColorStop(0, '#ef4444');
        complaintGradient.addColorStop(1, '#f97316'); // Red to Orange

        const suggestionGradient = ctx.createLinearGradient(0, 0, 0, 400);
        suggestionGradient.addColorStop(0, '#3b82f6');
        suggestionGradient.addColorStop(1, '#2dd4bf'); // Blue to Teal
        
        // NEW: Amber Gradient for Report Issue
        const reportGradient = ctx.createLinearGradient(0, 0, 0, 400);
        reportGradient.addColorStop(0, '#f59e0b');
        reportGradient.addColorStop(1, '#d97706'); // Amber to Orange

        typeChartInstance = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: ['คำร้องเรียน', 'ข้อเสนอแนะ', 'แจ้งปัญหา'], 
                datasets: [{ 
                    data: chartValues, 
                    backgroundColor: [ complaintGradient, suggestionGradient, reportGradient ],
                    borderWidth: 0,
                    hoverOffset: 4
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { family: "'Sarabun', sans-serif" } } } },
                layout: { padding: 20 } 
            } 
        });
    }


    function renderPagination(pagination) {
        const containers = document.querySelectorAll('.pagination-controls');
        if (!containers || containers.length === 0) return;

        const { currentPage, totalPages, totalFilteredItems } = pagination || {}; 

        containers.forEach(container => {
            container.innerHTML = '';
            if (!pagination || totalPages <= 1) return;

            let html = '<div class="flex items-center gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">';
            const prevDisabled = currentPage <= 1 ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-slate-50 text-slate-600';
            html += `<button onclick="changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''} class="p-2 rounded-lg transition-smooth ${prevDisabled}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>`;
            
            html += `<span class="text-sm font-bold text-slate-600 px-2">Page ${currentPage} / ${totalPages}</span>`;

            const nextDisabled = currentPage >= totalPages ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-slate-50 text-slate-600';
            html += `<button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} class="p-2 rounded-lg transition-smooth ${nextDisabled}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>`;
            html += '</div>';
            
            container.innerHTML = html;
        });
    }

    function changePage(newPage) {
        if (newPage < 1) return;
        currentPage = newPage;
        fetchAdminData(); 
    }
    
    function handleOpenAuditLog() {
        if (!auditLogModal || !auditLogLoading || !auditLogTable || !auditLogTableBody) return;
        auditLogModal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); 
        auditLogLoading.classList.remove('hidden');
        auditLogTable.classList.add('hidden');
        auditLogTableBody.innerHTML = ''; 

        google.script.run
            .withSuccessHandler(onAuditLogSuccess)
            .withFailureHandler(onAuditLogFailure)
            .getAuditLog(getSessionToken());
    }

    function onAuditLogSuccess(response) {
        auditLogLoading.classList.add('hidden');
        
        if (!checkAuth(response, null)) { 
            auditLogTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${response.error || 'Failed to load logs.'}</td></tr>`;
            auditLogTable.classList.remove('hidden');
            return;
        }

        const data = response.data || [];
        
        if (data.length === 0) {
            auditLogTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">No audit log entries found.</td></tr>`;
        } else {
            data.forEach(row => {
                const tr = auditLogTableBody.insertRow();
                tr.className = 'bg-white hover:bg-slate-50 text-sm text-slate-700 transition-smooth';

                const actionText = row[2] || 'Unknown'; 
                let actionColorClass = 'text-slate-700'; 

                if (actionText.includes('User') || actionText.includes('Password')) {
                    actionColorClass = 'text-red-600 font-bold'; 
                } else if (actionText.includes('Profanity')) {
                    actionColorClass = 'text-rose-600 font-bold'; 
                } else if (actionText.includes('Logo') || actionText.includes('Translations') || actionText.includes('Core Settings')) { 
                    actionColorClass = 'text-blue-600 font-bold'; 
                }
                
                const cellTimestamp = tr.insertCell();
                cellTimestamp.className = 'px-6 py-4 whitespace-nowrap text-slate-500';
                cellTimestamp.textContent = row[0] || '...'; 

                const cellUsername = tr.insertCell();
                cellUsername.className = 'px-6 py-4 font-bold text-slate-900';
                cellUsername.textContent = row[1] || '...'; 

                const cellAction = tr.insertCell();
                cellAction.className = `px-6 py-4 ${actionColorClass}`;
                cellAction.textContent = actionText; 

                const cellDetails = tr.insertCell();
                cellDetails.className = 'px-6 py-4 whitespace-pre-wrap break-words text-slate-600';
                cellDetails.textContent = row[3] || '-'; 
            });
        }
        auditLogTable.classList.remove('hidden');
    }

    function onAuditLogFailure(error) {
        auditLogLoading.classList.add('hidden');
        auditLogTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
        auditLogTable.classList.remove('hidden');
    }

    // ===== START: NEW PRINT BUTTON LISTENER =====
    function handlePrintTicket() {
        const ticketId = document.getElementById('details-modal-card').dataset.currentTicketId;
        if (!ticketId) return;

        const btn = document.getElementById('print-details-btn');
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = '<div class="spinner w-6 h-6 border-white border-t-transparent rounded-full animate-spin"></div>';
        btn.disabled = true;

        google.script.run
            .withSuccessHandler((htmlContent) => {
                btn.innerHTML = originalContent;
                btn.disabled = false;

                if (htmlContent.startsWith('<h1>Error')) {
                    alert("เกิดข้อผิดพลาดในการสร้างหน้าพิมพ์: " + htmlContent.replace(/<[^>]*>?/gm, '')); 
                    return;
                }

                const printWindow = window.open('', '_blank', 'width=900,height=800');
                if (printWindow) {
                    printWindow.document.open();
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();
                } else {
                    alert("Pop-up ถูกบล็อก กรุณาอนุญาต Pop-up สำหรับเว็บไซต์นี้");
                }
            })
            .withFailureHandler((err) => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                alert("Error generating print view: " + err.message);
            })
            .generatePrintView(getSessionToken(), ticketId);
    }
    // ===== END: NEW PRINT BUTTON LISTENER =====

    // ===== START: NEW EXPORT BUTTON LISTENER =====
    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', handleExportCSV);
    }
    // ===== END: NEW EXPORT BUTTON LISTENER =====

    // ===== START: EXPORT CSV LOGIC =====
    function handleExportCSV() {
        exportCsvBtn.disabled = true;
        exportIcon.classList.add('hidden');
        exportCsvSpinner.classList.remove('hidden');

        const typeFilter = document.getElementById('typeFilter');
        const statusFilter = document.getElementById('statusFilter');
        // REMOVED: assignFilter constant declaration
        const teamFilter = document.getElementById('teamFilter'); // New Team Filter (technically redundant with assignFilter if 'Assigned To' holds team, but good for UX)
        const searchInput = document.getElementById('searchInput');
        const dateRangeFilter = document.getElementById('dateRangeFilter');
        const dateStartInput = document.getElementById('dateStartInput');
        const dateEndInput = document.getElementById('dateEndInput');

        const dateRangeKey = dateRangeFilter ? dateRangeFilter.value : 'all';
        let dateStart = null;
        let dateEnd = null;

        if (dateRangeKey === 'custom') {
            dateStart = dateStartInput ? dateStartInput.value : null;
            dateEnd = dateEndInput ? dateEndInput.value : null;
        }

        // Logic: If 'teamFilter' is used, we treat it same as 'assignee' for now, 
        // assuming 'Assigned To' holds the Team Name.
        let assigneeValue = teamFilter && teamFilter.value !== 'ทั้งหมด' ? teamFilter.value : 'ทั้งหมด';

        const options = {
            page: currentPage,
            filters: {
                type: typeFilter ? typeFilter.value : 'ทั้งหมด',
                status: statusFilter ? statusFilter.value : 'ทั้งหมด',
                assignee: assigneeValue, 
                dateRangeKey: dateRangeKey,
                dateStart: dateStart,                 
                dateEnd: dateEnd                  
            },
            searchTerm: searchInput ? searchInput.value : '',
            forceRefresh: true // FIXED: isRefresh variable was undefined, use boolean true
        };

        const token = getSessionToken();
        if (!token) {
            onDataLoadSuccess({ error: "Authentication failed. Please log in again." });
            return;
        }

        google.script.run
            .withSuccessHandler(onExportSuccess) 
            .withFailureHandler(onExportFailure) 
            .getExportData(token, options); // Call specific export function
    }

    function onExportSuccess(response) {
        exportCsvBtn.disabled = false;
        exportIcon.classList.remove('hidden');
        exportCsvSpinner.classList.add('hidden');

        if (checkAuth(response)) {
            if (response.success && response.data) {
                downloadCSV(response.data);
            } else {
                alert('Export failed: ' + (response.error || 'Unknown error'));
            }
        }
    }

    function onExportFailure(error) {
        exportCsvBtn.disabled = false;
        exportIcon.classList.remove('hidden');
        exportCsvSpinner.classList.add('hidden');
        alert('Export failed: ' + error.message);
    }

    function downloadCSV(data) {
        if (!data || data.length === 0) {
            alert("No data to export.");
            return;
        }

        let csvContent = "\uFEFF"; 
        
        data.forEach(row => {
            const rowStr = row.map(val => escapeCsvValue(val)).join(",");
            csvContent += rowStr + "\r\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-").slice(0, 19);
        link.setAttribute("href", url);
        link.setAttribute("download", `ticket_export_${timestamp}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function escapeCsvValue(val) {
        if (val === null || val === undefined) return "";
        let str = String(val);
        if (str.includes(",") || str.includes("\"") || str.includes("\n") || str.includes("\r")) {
            str = '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    }
    // ===== END: EXPORT CSV LOGIC =====

</script>