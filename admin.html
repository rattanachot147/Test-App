<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Theme Settings --- */
        :root {
            --sidebar-width: 280px;
            --primary-color: #6366f1; /* Indigo 500 */
        }
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
        }
        
        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- Animations --- */
        .transition-smooth { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* --- Glass & Pastel Cards --- */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid #e2e8f0; 
        }

        /* --- Concept A: Semantic Headers (Modal) - SOLID COLORS UPDATED --- */
        .header-default { background-color: #4f46e5; } /* Indigo 600 - Standard/Professional */
        .header-complaint { background-color: #e11d48; } /* Rose 600 - Urgent but modern */
        .header-suggestion { background-color: #0284c7; } /* Sky 600 - Friendly/Open */
        .header-report { background-color: #d97706; } /* Amber 600 - Cautionary */

        /* --- Status Badges --- */
        .badge-new { background-color: #e2e8f0; color: #475569; }
        .badge-progress { background-color: #fef3c7; color: #d97706; }
        .badge-completed { background-color: #dcfce7; color: #166534; }
        .badge-cancelled { background-color: #fee2e2; color: #b91c1c; }

        /* --- Loading Spinner --- */
        .spinner { 
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top-color: #fff; 
            width: 1.25rem; 
            height: 1.25rem; 
            animation: spin 1s linear infinite; 
        }
        .page-spinner { 
            border: 4px solid rgba(99, 102, 241, 0.2); 
            border-top-color: #6366f1; 
            border-radius: 50%; 
            width: 3rem; 
            height: 3rem; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Layout Utilities --- */
        .sidebar-item.active { 
            background-color: #eff6ff; 
            color: #4f46e5; 
            border-right: 3px solid #4f46e5; 
        }

        /* --- Avatars (RESTORED) --- */
        .avatar-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid white;
        }
        .avatar-indigo { background: #6366f1; }
        .avatar-pink { background: #ec4899; }
        .avatar-teal { background: #14b8a6; }
        .avatar-orange { background: #f97316; }
        .avatar-gray { background: #94a3b8; }
        
        /* Glass Shine Effect for Cards (Kept for Dashboard Stats) */
        .glass-shine {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 60%);
            pointer-events: none;
        }

        /* --- New Card Styles (Glass Glow) --- */
        .card-glow {
            transition: all 0.3s ease;
        }
        .card-glow:hover {
            transform: translateY(-4px);
        }
        
        /* FIX: Dropdown Color Issue (Force White Background) */
        select option {
            background-color: #ffffff !important;
            color: #1e293b !important; /* slate-800 */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- ==================== SIDEBAR (LEFT) ==================== -->
    <aside class="w-[280px] bg-white border-r border-slate-100 flex-col hidden md:flex z-30 shadow-sm">
        <!-- Logo Area -->
        <div class="h-20 flex items-center px-8 border-b border-slate-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">Admin Panel</h1>
                    <p class="text-xs text-slate-400">System Management</p>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">เมนูหลัก</p>
            
            <button id="menu-dashboard-btn" class="sidebar-item active w-full flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-smooth group">
                <svg class="w-5 h-5 group-hover:scale-110 transition-smooth" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                ภาพรวมระบบ (Dashboard)
            </button>

            <button id="menu-tickets-btn" class="sidebar-item w-full flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-smooth group">
                <svg class="w-5 h-5 group-hover:scale-110 transition-smooth" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                รายการคำร้อง
            </button>

            <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mt-6 mb-2">จัดการระบบ</p>

            <button id="auditLogBtn" class="sidebar-item w-full flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-smooth group hidden">
                <svg class="w-5 h-5 group-hover:scale-110 transition-smooth" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                ประวัติระบบ (Audit Log)
            </button>

            <button id="settingsBtn" class="sidebar-item w-full flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-smooth group">
                <svg class="w-5 h-5 group-hover:scale-110 transition-smooth" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ตั้งค่า (Settings)
            </button>
            
            <a href="<?= webAppUrl ?>" target="_blank" class="sidebar-item w-full flex items-center gap-4 px-4 py-3 text-sm font-medium rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-smooth group">
                <svg class="w-5 h-5 group-hover:scale-110 transition-smooth" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                เปิดหน้าฟอร์ม
            </a>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-slate-50 mt-auto"> <!-- Added mt-auto to push to bottom if flex-col -->
             <!-- Profile Card -->
            <div class="bg-gradient-to-br from-slate-50 to-white rounded-2xl p-4 border border-slate-100 shadow-sm relative overflow-hidden mb-3">
                <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-full blur-xl -mr-8 -mt-8 opacity-50"></div>
                
                <div class="flex items-center gap-3 relative z-10">
                    <div class="relative">
                        <!-- MODIFIED: Added ID 'sidebar-user-avatar' and removed static SVG content -->
                        <div id="sidebar-user-avatar" class="w-10 h-10 rounded-full bg-white border-2 border-indigo-50 flex items-center justify-center text-indigo-600 font-bold shadow-sm text-sm transition-transform hover:scale-110 duration-200">
                             <!-- Default Icon (Fallback) -->
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="logged-in-username" class="text-sm font-bold text-slate-700 truncate leading-tight">Admin</p>
                        <!-- MODIFIED: Added ID 'logged-in-role' -->
                        <p id="logged-in-role" class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mt-0.5">Administrator</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Grid -->
            <div class="grid grid-cols-2 gap-3">
                <button id="changeSelfPassBtn" class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-indigo-100 bg-indigo-50 hover:bg-indigo-100 hover:border-indigo-200 text-indigo-600 transition-all duration-200 group shadow-sm">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                    <span class="text-xs font-bold">รหัสผ่าน</span>
                </button>
                <button id="logoutBtn" class="flex items-center justify-center gap-2 p-2.5 rounded-xl border border-rose-100 bg-rose-50 hover:bg-rose-100 hover:border-rose-200 text-rose-600 transition-all duration-200 group shadow-sm">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="text-xs font-bold">ออกระบบ</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- ==================== MAIN CONTENT (RIGHT) ==================== -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
        
        <!-- Mobile Header (Visible only on small screens) -->
        <div class="md:hidden h-16 bg-white shadow-sm flex items-center justify-between px-4 z-20 relative">
             <span class="text-lg font-bold text-slate-800">Admin Panel</span>
             <button class="text-slate-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        </div>

        <!-- Top Bar (Search & Filter) -->
        <header id="top-filter-bar" class="bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 py-3 z-10 flex items-center justify-between gap-4 sticky top-0">
            <div class="flex items-center gap-4 flex-1">
                <!-- Search Box -->
                <div class="relative w-full max-w-md">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input id="searchInput" type="text" placeholder="ค้นหา Ticket, หัวข้อ..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 text-slate-600 placeholder-slate-400 transition-smooth">
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Filter Buttons -->
                <div class="flex items-center bg-slate-50 rounded-xl p-1 border border-slate-100">
                    
                    <!-- Type Filter (ADDED Report Issue) -->
                    <select id="typeFilter" class="bg-transparent text-sm text-slate-600 font-medium py-1.5 px-3 rounded-lg focus:outline-none cursor-pointer">
                        <option value="ทั้งหมด">ทุกประเภท</option>
                        <option value="คำร้องเรียน">คำร้องเรียน</option>
                        <option value="ข้อเสนอแนะ">ข้อเสนอแนะ</option>
                        <option value="แจ้งปัญหา">แจ้งปัญหา</option> <!-- NEW -->
                    </select>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                    <!-- Status Filter -->
                    <select id="statusFilter" class="bg-transparent text-sm text-slate-600 font-medium py-1.5 px-3 rounded-lg focus:outline-none cursor-pointer">
                        <option value="ทั้งหมด">ทุกสถานะ</option>
                        <option value="ยังไม่ดำเนินการ">New</option>
                        <option value="กำลังดำเนินการ">In Progress</option>
                        <option value="เสร็จสิ้น">Completed</option>
                        <option value="ยกเลิก">Cancelled</option>
                    </select>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                      <!-- NEW: Team Filter (Replaces Assignee Filter) -->
                      <select id="teamFilter" class="bg-transparent text-sm text-slate-600 font-medium py-1.5 px-3 rounded-lg focus:outline-none cursor-pointer">
                        <option value="ทั้งหมด">ทุกแผนก (All Teams)</option>
                    </select>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>

                    <!-- Date Filter -->
                    <select id="dateRangeFilter" class="bg-transparent text-sm text-slate-600 font-medium py-1.5 px-3 rounded-lg focus:outline-none cursor-pointer">
                        <option value="all">ทุกช่วงเวลา</option>
                        <option value="today">วันนี้</option>
                        <option value="this_week">สัปดาห์นี้</option>
                        <option value="this_month">เดือนนี้</option>
                        <option value="custom">กำหนดเอง...</option>
                    </select>
                </div>
                
                <div id="date-range-display" class="hidden text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg"></div>
                
                <button id="clearDateFilterBtn" class="p-2 text-slate-400 hover:text-red-500 transition-smooth" title="ล้างตัวกรองวันที่">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <!-- Export CSV Button -->
                <button id="exportCsvBtn" class="p-2.5 bg-white border border-slate-200 rounded-xl text-emerald-600 hover:bg-emerald-50 hover:border-emerald-200 transition-smooth shadow-sm group relative" title="Export CSV">
                    <svg id="export-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <div id="export-csv-spinner" class="spinner hidden w-5 h-5 border-emerald-500 border-t-transparent absolute top-2.5 left-2.5 bg-white rounded-full"></div>
                </button>

                <button id="refreshBtn" class="p-2.5 bg-white border border-slate-200 rounded-xl text-indigo-600 hover:bg-indigo-50 hover:border-indigo-200 transition-smooth shadow-sm group">
                    <svg id="refresh-icon" class="w-5 h-5 group-hover:rotate-180 transition-smooth duration-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <div id="refresh-spinner" class="spinner hidden w-5 h-5 border-indigo-500 border-t-transparent"></div>
                </button>

                <button id="toggleChartBtn" class="hidden">Toggle Chart</button>
            </div>
        </header>

        <!-- Content Scroll Area -->
        <div id="main-scroll-area" class="flex-1 overflow-y-auto px-6 lg:px-8 pb-6 lg:pb-8 pt-4">
            
            <!-- ===== 1. DASHBOARD SECTION (Stats & Charts) ===== -->
            <div id="view-dashboard" class="space-y-6 pt-0">
                
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-800">ภาพรวม (Overview)</h2>
                    <span class="text-sm text-slate-400">ข้อมูลสรุปสถานะปัจจุบัน</span>
                </div>

                <!-- Stats Cards (STYLE: MODERN GLASS & GLOW - UPDATED BORDERS) -->
                <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-6 mb-8">
                    
                    <!-- 1. Total Card -->
                    <div id="total-card" class="bg-white rounded-2xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(99,102,241,0.2)] border border-indigo-200 hover:border-indigo-400 transition-all duration-300 cursor-pointer group hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition-transform duration-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">เรื่องทั้งหมด</p>
                                <h3 id="total-count" class="text-3xl font-extrabold text-slate-800 group-hover:text-indigo-600 transition-colors">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- 2. New Request Card -->
                    <div id="new-card" class="bg-white rounded-2xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(14,165,233,0.2)] border border-sky-200 hover:border-sky-400 transition-all duration-300 cursor-pointer group hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-sky-50 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition-transform duration-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">รอดำเนินการ</p>
                                <h3 id="pending-count" class="text-3xl font-extrabold text-slate-800 group-hover:text-sky-500 transition-colors">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-sky-400 to-blue-500 text-white flex items-center justify-center shadow-lg shadow-sky-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- 3. In Progress Card -->
                    <div id="inprogress-card" class="bg-white rounded-2xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(245,158,11,0.2)] border border-amber-200 hover:border-amber-400 transition-all duration-300 cursor-pointer group hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-amber-50 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition-transform duration-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">กำลังดำเนินการ</p>
                                <h3 id="inprogress-count" class="text-3xl font-extrabold text-slate-800 group-hover:text-amber-500 transition-colors">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-amber-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Completed Card -->
                    <div id="completed-card" class="bg-white rounded-2xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(16,185,129,0.2)] border border-emerald-200 hover:border-emerald-400 transition-all duration-300 cursor-pointer group hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-emerald-50 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition-transform duration-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">เสร็จสิ้น</p>
                                <h3 id="completed-count" class="text-3xl font-extrabold text-slate-800 group-hover:text-emerald-500 transition-colors">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-600 text-white flex items-center justify-center shadow-lg shadow-emerald-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Cancelled Card -->
                    <div id="cancelled-card" class="bg-white rounded-2xl p-6 shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgba(244,63,94,0.2)] border border-rose-200 hover:border-rose-400 transition-all duration-300 cursor-pointer group hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition-transform duration-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">ยกเลิก</p>
                                <h3 id="cancelled-count" class="text-3xl font-extrabold text-slate-800 group-hover:text-rose-500 transition-colors">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-rose-400 to-red-500 text-white flex items-center justify-center shadow-lg shadow-rose-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hidden">
                    <div id="complaint-card"><span id="complaint-count">0</span></div>
                    <div id="suggestion-card"><span id="suggestion-count">0</span></div>
                    <!-- Added ID for consistency, though JS uses chart data -->
                    <div id="report-issue-card"><span id="report-issue-count">0</span></div>
                </div>

                <!-- Charts Section -->
                <div id="summarySection" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2">
                            <span class="w-2 h-6 bg-indigo-500 rounded-full"></span> สัดส่วนประเภท
                        </h4>
                        <div class="h-64 relative"><canvas id="typeChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h4 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2">
                            <span class="w-2 h-6 bg-teal-500 rounded-full"></span> สัดส่วนสถานะ
                        </h4>
                        <div class="h-64 relative"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>

                <!-- Recent Activity Feed (MOVED UP HERE) -->
                <div class="mt-6 mb-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        รายการล่าสุด (Recent Activity)
                    </h3>
                    
                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gradient-to-r from-indigo-50 to-purple-50 text-slate-600 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">ประเภท</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">ID</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">วันที่</th>
                                    <th class="px-4 py-4 text-left w-[24%]">หัวข้อ</th>                                                                <!-- เพิ่มจาก 22% เป็น 24% -->
                                    <th class="px-4 py-4 text-left w-[34%]">รายละเอียด</th>                                                                 <!-- เพิ่มจาก 33% เป็น 34% -->
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">สถานะ</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">หน่วยงาน</th> <!-- MODIFIED: Changed from ผู้รับผิดชอบ to หน่วยงาน -->
                                </tr>
                            </thead>
                            <tbody id="recent-activity-tbody" class="divide-y divide-slate-100 bg-white">
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center justify-center gap-3">
                                            <div class="spinner border-slate-200 border-t-indigo-500 w-8 h-8"></div>
                                            <span>กำลังโหลดข้อมูลล่าสุด...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- === 1.2 NEW: Assignee Workload & Unassigned Queue (MOVED DOWN HERE) === -->
                <div id="assignee-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    
                    <!-- Left Column: Workload Table (Span 2) -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-full">
                         <div class="flex justify-between items-center mb-6">
                            <h4 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <span class="p-1.5 bg-indigo-50 text-indigo-500 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                                </span>
                                ภาระงานทีม (Team Workload)
                            </h4>
                         </div>
                         
                         <div class="overflow-hidden rounded-xl border border-slate-200 flex-1">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 font-semibold uppercase text-xs">
                                    <tr>
                                        <th class="px-6 py-4">ผู้รับผิดชอบ (User)</th>
                                        <!-- MODIFIED: Changed Headers Order -->
                                        <th class="px-6 py-4 text-center w-24">งานทั้งหมด</th>
                                        <th class="px-6 py-4 text-center w-24 text-indigo-600">งานค้าง</th>
                                        <th class="px-6 py-4 text-center w-24 text-green-600">เสร็จ</th>
                                        <!-- ADDING CANCELLED HERE -->
                                        <th class="px-6 py-4 text-center w-24 text-red-500">ยกเลิก</th> 
                                    </tr>
                                </thead>
                                <tbody id="assignee-table-body" class="divide-y divide-slate-100 bg-white">
                                    <tr><td colspan="5" class="text-center py-6 text-slate-400 italic">กำลังโหลดข้อมูล...</td></tr> <!-- Updated colspan to 5 -->
                                </tbody>
                            </table>
                         </div>
                    </div>

                    <!-- Right Column: Unassigned Tickets Queue (Span 1) -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <span class="p-1.5 bg-rose-50 text-rose-500 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                </span>
                                งานรอมอบหมาย (Unassigned)
                            </h4>
                            <span id="unassigned-count-badge" class="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-full">0</span>
                        </div>

                        <div id="unassigned-list-container" class="space-y-3 overflow-y-auto max-h-[300px] custom-scrollbar pr-2 flex-1">
                            <!-- Items will be injected here -->
                            <div class="text-center py-8 text-slate-400 italic text-sm">ไม่มีงานค้างจ่าย</div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-50 text-center">
                            <button onclick="document.getElementById('teamFilter').value=''; applyFilters(); setActiveView('tickets');" class="text-xs font-bold text-indigo-500 hover:text-indigo-700 transition-colors">
                                ดูทั้งหมด &rarr;
                            </button>
                        </div>
                    </div>

                </div>
                <!-- === END: Assignee Workload Table === -->

            </div>

            <!-- ===== 2. TICKET LIST SECTION ===== -->
            <div id="view-tickets" class="hidden space-y-4 pt-1"> 
                <div class="flex items-center justify-between mb-4"> 
                    <!-- Updated Title to match context -->
                    <h2 class="text-xl font-bold text-slate-800">รายการทั้งหมด</h2> 
                    <div id="pagination-container-top" class="pagination-controls"></div>
                </div>
                
                <!-- Ticket Table Container (Replaces Card Container) -->
                <div id="ticket-table-container" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left table-fixed"> <!-- Fixed layout for responsive truncation -->
                            <thead class="bg-gradient-to-r from-indigo-50 to-purple-50 text-slate-600 font-bold uppercase text-xs">
                                <tr>
                                    <!-- ปรับ Padding เป็น px-4 และปรับสัดส่วนความกว้างใหม่ -->
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">ประเภท</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">ID</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[9%]">วันที่</th>
                                    <th class="px-4 py-4 text-left w-[24%]">หัวข้อ</th>                                                                <!-- เพิ่มจาก 22% เป็น 24% -->
                                    <th class="px-4 py-4 text-left w-[34%]">รายละเอียด</th>                                                                 <!-- เพิ่มจาก 33% เป็น 34% -->
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">สถานะ</th>
                                    <th class="px-4 py-4 text-center whitespace-nowrap w-[8%]">หน่วยงาน</th> <!-- MODIFIED: Changed from ผู้รับผิดชอบ to หน่วยงาน -->
                                </tr>
                            </thead>
                            <tbody id="ticket-table-body" class="divide-y divide-slate-100 bg-white">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center justify-center gap-3">
                                            <div class="spinner border-slate-200 border-t-indigo-500 w-8 h-8"></div>
                                            <span>กำลังโหลดข้อมูลล่าสุด...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="pagination-container-bottom" class="pagination-controls mt-6 flex justify-center"></div>
            </div>
            
            <!-- ===== 3. SETTINGS SECTION (Integrated View) ===== -->
            <div id="settings-modal" class="hidden pt-6">
                 <div class="flex items-center justify-between mb-6"> 
                    <h2 class="text-xl font-bold text-slate-800">ตั้งค่าระบบ (Settings)</h2>
                 </div>
                 
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[500px] p-6 md:p-8">
                    <!-- Menu Grid -->
                    <div id="settings-menu-view" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                         <div class="col-span-1 md:col-span-2 xl:col-span-3 mb-2"><h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">General Settings</h3></div>

                         <!-- User Management (UPDATED NAME) -->
                         <button id="menu-user-management-btn" class="hidden group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-indigo-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-indigo-500 to-purple-500"></div>
                            <div class="w-14 h-14 rounded-2xl bg-indigo-50 text-indigo-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-bold text-slate-700 group-hover:text-indigo-600 transition-colors">Users & Teams</h3>
                                <p class="text-sm text-slate-400 mt-1 font-medium">จัดการผู้ใช้และหน่วยงาน</p>
                            </div>
                            <div class="text-slate-300 group-hover:text-indigo-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                        
                         <button id="menu-user-management-btn-inner" class="hidden" onclick="document.getElementById('menu-user-management-btn').click()"></button>

                        <!-- Notifications -->
                        <button id="menu-core-settings-btn" class="hidden group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-blue-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-blue-400 to-blue-600"></div>
                             <div class="w-14 h-14 rounded-2xl bg-blue-50 text-blue-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-blue-600 transition-colors">Notifications</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">ตั้งค่าอีเมลแจ้งเตือน</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                        
                        <!-- NEW: Templates Settings Button -->
                        <button id="menu-template-settings-btn" class="group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-pink-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-pink-400 to-rose-500"></div>
                             <div class="w-14 h-14 rounded-2xl bg-pink-50 text-pink-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-pink-600 transition-colors">Templates</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">ข้อความตอบกลับสำเร็จรูป</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-pink-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>
                        
                        <!-- NEW: Form Config Button -->
                        <button id="menu-form-config-btn" class="group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-emerald-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-emerald-400 to-green-500"></div>
                             <div class="w-14 h-14 rounded-2xl bg-emerald-50 text-emerald-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-emerald-600 transition-colors">Form Config</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">เปิด-ปิดการรับเรื่อง</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-emerald-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>

                        <!-- Logo -->
                        <button id="menu-logo-settings-btn" class="group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-amber-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-amber-400 to-orange-500"></div>
                             <div class="w-14 h-14 rounded-2xl bg-amber-50 text-amber-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-amber-600 transition-colors">Logo</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">ปรับแต่งโลโก้ระบบ</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-amber-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>

                        <!-- Translations -->
                        <button id="menu-translation-settings-btn" class="group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-teal-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-teal-400 to-emerald-500"></div>
                             <div class="w-14 h-14 rounded-2xl bg-teal-50 text-teal-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-teal-600 transition-colors">Translations</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">ข้อความและภาษา</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-teal-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>

                        <!-- Profanity -->
                        <button id="menu-profanity-settings-btn" class="group relative flex items-center gap-5 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:shadow-rose-100/50 hover:-translate-y-1 transition-all duration-300 overflow-hidden w-full text-left">
                             <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-rose-400 to-red-500"></div>
                             <div class="w-14 h-14 rounded-2xl bg-rose-50 text-rose-600 flex flex-shrink-0 items-center justify-center shadow-inner group-hover:scale-110 group-hover:rotate-3 transition-all duration-300">
                                 <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                             </div>
                             <div class="flex-1 min-w-0">
                                 <h3 class="text-lg font-bold text-slate-700 group-hover:text-rose-600 transition-colors">Profanity</h3>
                                 <p class="text-sm text-slate-400 mt-1 font-medium">จัดการคำหยาบ</p>
                             </div>
                             <div class="text-slate-300 group-hover:text-rose-500 group-hover:translate-x-1 transition-all duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </div>
                        </button>

                    </div>

                    <!-- Settings Sub-Pages -->
                    <!-- MODIFIED: User Management View now includes Tabs -->
                    <div id="user-management-view" class="hidden h-full flex flex-col">
                        <!-- Back Button -->
                        <div class="mb-6"><button class="back-to-menu text-indigo-500 hover:text-indigo-700 font-bold flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Back</button></div>
                        
                        <div class="w-full max-w-4xl flex-1 flex flex-col min-h-0">
                            
                            <!-- Header & Tabs Container -->
                            <div class="bg-white p-6 rounded-t-xl border border-slate-200 border-b-0 shadow-sm z-10">
                                <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span> 
                                    Users & Teams Organization
                                </h2>
                                
                                <!-- Tabs -->
                                <div class="flex gap-2 border-b border-slate-100">
                                    <button id="tab-btn-users" class="px-6 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-all hover:bg-indigo-50/50 rounded-t-lg">
                                        ผู้ใช้งาน (Users)
                                    </button>
                                    <button id="tab-btn-teams" class="px-6 py-3 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-indigo-500 hover:bg-slate-50 transition-all rounded-t-lg">
                                        หน่วยงาน (Teams)
                                    </button>
                                </div>
                            </div>

                            <!-- Content Area (Gray Background) -->
                            <div class="bg-slate-50 p-6 rounded-b-xl border border-slate-200 border-t-0 flex-1 overflow-hidden relative">
                                
                                <!-- Tab: Users (Existing Content) -->
                                <div id="tab-content-users" class="h-full flex flex-col">
                                    <form id="addUserForm" class="flex flex-col md:flex-row gap-3 mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                        <input type="text" id="newUsername" placeholder="Username" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm" required>
                                        <input type="password" id="newPassword" placeholder="Password" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm" required>
                                        <select id="newRole" class="border border-slate-200 p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none text-sm" required>
                                            <option value="" disabled selected>Select Role</option>
                                            <option value="Admin">Admin</option>
                                            <option value="User">User</option>
                                        </select>
                                        <input type="text" id="newTeam" list="teamList" autocomplete="off" placeholder="Team (e.g. IT)" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                                        <button type="submit" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-smooth text-sm whitespace-nowrap">Add User</button>
                                    </form>
                                    <p id="user-error" class="hidden text-red-500 mb-4 bg-red-50 p-3 rounded-lg text-center text-sm"></p>
                                    <div id="user-list-container" class="space-y-3 overflow-y-auto custom-scrollbar flex-1 pr-2">Loading...</div>
                                </div>

                                <!-- Tab: Teams (New Content) -->
                                <div id="tab-content-teams" class="hidden h-full flex flex-col">
                                    <form id="addTeamForm" class="flex gap-3 mb-6 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                        <input type="text" id="newTeamName" placeholder="ระบุชื่อหน่วยงาน (เช่น ฝ่ายไอที)" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm" required>
                                        <button type="submit" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-smooth text-sm whitespace-nowrap">
                                            เพิ่มหน่วยงาน
                                        </button>
                                    </form>
                                    
                                    <div id="team-list-display" class="space-y-2 overflow-y-auto custom-scrollbar flex-1 pr-2">
                                        <div class="text-center text-slate-400 py-10 italic">กำลังโหลดข้อมูล...</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div id="core-settings-view" class="hidden h-full flex flex-col">
                         <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                         <div class="bg-slate-50 p-8 rounded-xl border border-slate-100 max-w-2xl">
                             <h2 class="text-lg font-bold mb-6 text-slate-800">Email Notifications</h2>
                             <form id="coreSettingsForm" class="space-y-5">
                                 <div><label class="block text-sm font-bold text-slate-500 mb-1">Recipient Email(s)</label><input type="text" id="coreEmailInput" class="w-full border border-slate-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white"></div>
                                 <button type="submit" id="coreSettingsSaveBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm"><div class="btn-content">Save</div><div class="spinner hidden"></div></button>
                                 <p id="core-settings-success" class="hidden text-green-600 font-bold text-sm mt-2">Saved!</p>
                             </form>
                         </div>
                    </div>
                    
                    <!-- NEW: Form Config View -->
                    <div id="form-config-view" class="hidden h-full flex flex-col">
                        <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                        <div class="bg-slate-50 p-8 rounded-xl border border-slate-100 max-w-2xl">
                            <h2 class="text-lg font-bold mb-6 text-slate-800">Form Configuration (ตั้งค่าฟอร์ม)</h2>
                            
                            <div class="space-y-4">
                                <!-- Complaint Toggle -->
                                <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div>
                                        <h4 class="font-bold text-slate-700">คำร้องเรียน (Complaints)</h4>
                                        <p class="text-xs text-slate-400">เปิดให้ผู้ใช้ส่งแบบฟอร์มคำร้องเรียน</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-complaint" class="sr-only peer" disabled>
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                                    </label>
                                </div>
                                
                                <!-- Suggestion Toggle -->
                                <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div>
                                        <h4 class="font-bold text-slate-700">ข้อเสนอแนะ (Suggestions)</h4>
                                        <p class="text-xs text-slate-400">เปิดให้ผู้ใช้ส่งแบบฟอร์มข้อเสนอแนะ</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-suggestion" class="sr-only peer" disabled>
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                                    </label>
                                </div>
                                
                                <!-- Report Issue Toggle -->
                                <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <div>
                                        <h4 class="font-bold text-slate-700">แจ้งปัญหา (Report Issues)</h4>
                                        <p class="text-xs text-slate-400">เปิดให้ผู้ใช้ส่งแบบฟอร์มแจ้งปัญหา</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-report" class="sr-only peer" disabled>
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-slate-200 flex items-center justify-between">
                                <p id="form-config-success" class="hidden text-emerald-600 font-bold text-sm bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100">บันทึกการตั้งค่าเรียบร้อยแล้ว!</p>
                                <button type="button" id="saveFormConfigBtn" class="bg-emerald-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-emerald-700 flex items-center gap-2 text-sm ml-auto transition-smooth">
                                    <div class="btn-content">บันทึกการเปลี่ยนแปลง</div>
                                    <div class="spinner hidden w-4 h-4 border-white"></div>
                                </button>
                            </div>
                        </div>
                    </div>


                    <div id="logo-settings-view" class="hidden h-full flex flex-col">
                         <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                         <div class="bg-slate-50 p-8 rounded-xl border border-slate-100 max-w-2xl">
                             <h2 class="text-lg font-bold mb-6 text-slate-800">Logo Settings</h2>
                             <form id="logoForm" class="space-y-5">
                                 <input type="url" id="logoUrl" placeholder="https://..." class="w-full border border-slate-200 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                 <div class="border-2 border-dashed border-slate-200 p-6 text-center rounded-xl bg-white"><img id="logo-preview" src="" class="hidden max-h-24 mx-auto"><span id="logo-placeholder" class="text-slate-400 font-medium text-sm">Preview Area</span></div>
                                 <button type="submit" id="logoSaveBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm"><div class="btn-content">Save</div><div class="spinner hidden"></div></button>
                                 <p id="logo-success" class="hidden text-green-600 font-bold text-sm mt-2">Saved!</p>
                             </form>
                         </div>
                    </div>

                    <div id="translation-settings-view" class="hidden h-full flex flex-col">
                         <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                         <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 flex-1 flex flex-col min-h-0">
                             <h2 class="text-lg font-bold mb-4 text-slate-800">Translations</h2>
                             <form id="translationForm" class="flex-1 flex flex-col min-h-0">
                                <div id="translation-table-container" class="flex-1 overflow-y-auto border border-slate-200 rounded-xl bg-white"></div>
                                <div class="pt-5 mt-2 border-t border-slate-200"><button type="submit" id="translationSaveBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm"><div class="btn-content">Save All</div><div class="spinner hidden"></div></button><p id="translation-success" class="hidden text-green-600 font-bold inline ml-3 text-sm">Saved!</p></div>
                             </form>
                         </div>
                    </div>

                    <div id="profanity-settings-view" class="hidden h-full flex flex-col">
                         <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                         <div class="bg-slate-50 p-8 rounded-xl border border-slate-100 flex-1 flex flex-col min-h-0">
                             <h2 class="text-lg font-bold mb-6 text-slate-800">Profanity Filter</h2>
                             <form id="profanityForm" class="flex-1 flex flex-col min-h-0">
                                 <div class="flex gap-3 mb-4"><input type="text" id="newProfanityWord" placeholder="Add word..." class="border border-slate-200 p-3 rounded-lg flex-1 focus:ring-2 focus:ring-indigo-500 outline-none bg-white"><button type="button" id="addProfanityWordBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-indigo-700 shadow-md text-sm">Add</button></div>
                                 <div id="profanity-list-display" class="flex-1 border border-slate-200 rounded-xl p-4 bg-white overflow-y-auto flex flex-wrap gap-2 content-start"></div>
                                 <div class="pt-5 mt-2 border-t border-slate-200"><button type="submit" id="profanitySaveBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2 text-sm"><div class="btn-content">Save Changes</div><div class="spinner hidden"></div></button><p id="profanity-success" class="hidden text-green-600 font-bold inline ml-3 text-sm">Saved!</p><p id="profanity-error" class="hidden text-red-500 font-bold inline ml-3 text-sm"></p></div>
                             </form>
                         </div>
                    </div>
                    
                    <!-- NEW: Template Settings View -->
                    <div id="template-settings-view" class="hidden h-full flex flex-col">
                        <div class="mb-6"><button class="back-to-menu text-indigo-500 font-bold flex items-center gap-2">&larr; Back</button></div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 flex-1 flex flex-col min-h-0">
                            <h2 class="text-lg font-bold mb-4 text-slate-800">Canned Responses (Templates)</h2>
                            
                            <!-- Add New Template Form -->
                            <form id="addTemplateForm" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col gap-3">
                                <div class="flex flex-col md:flex-row gap-3 items-center">
                                    <input type="text" id="newTemplateTitle" placeholder="ชื่อเรียก (เช่น 'รับเรื่อง')" class="border border-slate-200 p-2.5 rounded-lg flex-1 focus:ring-2 focus:ring-pink-500 outline-none text-sm font-bold w-full" required>
                                    
                                    <!-- MODIFIED: Submit Button with Spinner Structure -->
                                    <button type="submit" id="templateSaveBtn" class="bg-pink-500 text-white px-5 py-2.5 rounded-lg hover:bg-pink-600 font-bold shadow-md transition-smooth text-sm whitespace-nowrap flex items-center justify-center gap-2 min-w-[100px]">
                                        <span class="btn-content">เพิ่มรายการ</span>
                                        <div class="spinner hidden w-4 h-4 border-white"></div>
                                    </button>

                                    <!-- NEW: Cancel Edit Button (Hidden by default) - Moved to right -->
                                    <button type="button" id="cancelTemplateEditBtn" class="hidden bg-slate-100 text-slate-600 px-5 py-2.5 rounded-lg hover:bg-slate-200 font-bold shadow-sm transition-smooth text-sm whitespace-nowrap">
                                        ยกเลิก
                                    </button>
                                </div>
                                <textarea id="newTemplateMessage" rows="2" placeholder="ข้อความที่จะพิมพ์..." class="w-full border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm resize-none" required></textarea>
                            </form>

                            <!-- Templates List -->
                            <div id="template-list-display" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                                <!-- Items will be injected here via JS -->
                            </div>
                        </div>
                    </div>

                 </div>
                 
                 <button id="close-settings-modal-btn" class="hidden"></button>
            </div>

        </div>
    </main>


    <!-- ==================== MODALS ==================== -->
    
    <!-- NEW: Template Picker Modal -->
    <div id="template-picker-modal" class="hidden fixed inset-0 z-[70] bg-slate-900/40 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <!-- Changed max-w-sm to max-w-2xl for wider view -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[60vh] border border-white/20 transform transition-all scale-100">
            <!-- Header -->
            <div class="px-5 py-4 bg-indigo-600 border-b border-indigo-500 flex justify-between items-center shadow-md z-10">
                <h3 class="font-bold text-white text-lg flex items-center gap-2"> <!-- Increased text size slightly -->
                    <svg class="w-6 h-6 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    เลือกข้อความตอบกลับ (Templates)
                </h3>
                <button id="closeTemplatePickerBtn" class="text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-1.5 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- List -->
            <div id="template-picker-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar bg-slate-50">
                <!-- List items injected here -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-100 backdrop-blur-md transition-opacity">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-white/50 backdrop-blur-xl transform scale-100 transition-transform">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Admin Login</h2>
                <p class="text-slate-500 text-sm mt-1">เข้าสู่ระบบเพื่อจัดการข้อมูล</p>
            </div>
            <form id="loginForm" autocomplete="off" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 pr-12 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" required>
                        <button type="button" id="togglePasswordBtn" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-indigo-500 transition-colors focus:outline-none" tabindex="-1">
                            <!-- Eye Open (Show) -->
                            <svg id="eyeOpenIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            <!-- Eye Closed (Hide) - Hidden by default -->
                            <svg id="eyeClosedIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                        </button>
                    </div>
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-200 flex justify-center items-center gap-2">
                    <span id="loginBtnText">เข้าสู่ระบบ</span>
                    <div id="loginSpinner" class="spinner hidden"></div>
                </button>
                <p id="login-error" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-xl border border-red-100 font-medium"></p>
            </form>
        </div>
    </div>

    <!-- Page Loader -->
    <div id="page-loader" class="hidden fixed inset-0 bg-white/90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="page-spinner mb-4"></div>
            <p class="text-indigo-600 font-bold animate-pulse">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
        <!-- MODIFIED: Changed max-w-5xl to max-w-5xl -->
        <div id="details-modal-card" class="bg-white w-full max-w-5xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden flex flex-col max-h-[90vh]">
            
            <div id="details-modal-header" class="px-8 py-5 flex justify-between items-center z-10 header-default shadow-md transition-all duration-500 flex-shrink-0">
                <div class="flex items-center gap-5">
                    <div id="details-modal-icon" class="p-3 rounded-2xl bg-white shadow-sm text-white shadow-inner"></div>
                    <div class="text-white">
                        <div class="flex items-center gap-3 mb-1">
                            <span id="details-modal-type-header" class="px-2.5 py-0.5 rounded-lg bg-white/20 backdrop-blur-sm text-xs font-bold uppercase tracking-wider text-white/90 shadow-sm"></span>
                            <span id="details-modal-date" class="text-xs font-medium text-indigo-100"></span>
                        </div>
                        <div class="flex items-center gap-4">
                            <h2 id="details-modal-ticket-id" class="text-3xl font-bold tracking-tight text-white drop-shadow-sm"></h2>
                            <span id="details-modal-status-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-white/20 backdrop-blur-md text-white border border-white/30 shadow-sm hidden"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="print-details-btn" class="p-2 text-white/70 hover:text-white hover:bg-white/20 rounded-full transition-smooth" title="พิมพ์เอกสาร">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7,10a1,1,0,1,0,1,1A1,1,0,0,0,7,10ZM19,6H18V3a1,1,0,0,0-1-1H7A1,1,0,0,0,6,3V6H5A3,3,0,0,0,2,9v6a3,3,0,0,0,3,3H6v3a1,1,0,0,0,1-1H17a1,1,0,0,0,1-1V18h1a3,3,0,0,0,3-3V9A3,3,0,0,0,19,6ZM8,4h8V6H8Zm8,16H8V16h8Zm4-5a1,1,0,0,1-1,1H18V15a1,1,0,0,0-1-1H7a1,1,0,0,0-1,1v1H5a1,1,0,0,1-1-1V9A1,1,0,0,1,5,8H19a1,1,0,0,1,1,1Z"/></svg>
                    </button>
                    <button id="close-details-modal" class="p-2 text-white/70 hover:text-white hover:bg-white/20 rounded-full transition-smooth">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div id="modal-content-scroller" class="flex-1 overflow-y-auto bg-slate-50 p-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden group">
                            <div id="details-modal-strip-info" class="absolute top-0 left-0 w-full h-2 bg-slate-200 transition-colors duration-300"></div>
                            <div class="flex items-center gap-3 mb-6">
                                <span class="p-2 bg-blue-50 text-blue-600 rounded-xl">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                </span>
                                <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">รายละเอียด (Details)</h3>
                            </div>
                            
                            <!-- UPDATED LAYOUT: Option 1 (Vertical Flow) -->
                            <div class="space-y-6">
                                
                                <!-- 1. Topic -->
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">หัวข้อเรื่อง</label>
                                    <p id="details-modal-topic" class="text-xl font-bold text-slate-800"></p>
                                </div>
                                
                                <!-- 2. Location (Moved out of grid) -->
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">สถานที่</label>
                                    <p id="details-modal-location" class="text-slate-700 font-medium"></p>
                                </div>

                                <!-- 3. Details Box -->
                                <div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                                    <div id="details-modal-details" class="text-slate-600 text-sm leading-relaxed whitespace-pre-line break-words max-h-[250px] overflow-y-auto custom-scrollbar pr-2"></div>
                                </div>

                                <!-- 4. Attachment (User) -->
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">ไฟล์แนบจากผู้แจ้ง (User Attachments)</label>
                                    <div id="details-modal-attachment" class="flex flex-wrap gap-4"></div>
                                </div>

                                <!-- 5. Admin Attachment (New) -->
                                <div id="admin-attachment-wrapper" class="hidden"> <!-- Hidden by default, script will show if data exists -->
                                    <label class="text-xs font-bold text-slate-400 uppercase mb-1 block mt-6">รูปภาพการดำเนินงาน (Admin Attachments)</label>
                                    <div id="details-modal-admin-attachment" class="flex flex-wrap gap-4"></div>
                                </div>

                            </div>
                        </div>

                        <div id="modal-history-zone" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
                             <div id="details-modal-strip-history" class="absolute top-0 left-0 w-full h-2 bg-slate-200 transition-colors duration-300"></div>
                             <div class="flex items-center justify-between mb-6 pb-2">
                                <div class="flex items-center gap-3">
                                     <span class="p-2 bg-orange-50 text-orange-600 rounded-xl">
                                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                     </span>
                                     <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">ประวัติการดำเนินการ</h3>
                                 </div>
                                 <div class="flex gap-2">
                                     <span class="w-2 h-2 rounded-full bg-blue-400"></span><span class="text-[10px] text-slate-400">System</span>
                                     <span class="w-2 h-2 rounded-full bg-green-400 ml-2"></span><span class="text-[10px] text-slate-400">Admin</span>
                                     <span class="w-2 h-2 rounded-full bg-yellow-400 ml-2"></span><span class="text-[10px] text-slate-400">Public</span>
                                 </div>
                             </div>
                             <div id="details-modal-comments-display" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        <div id="modal-admin-zone" class="bg-white p-6 rounded-3xl shadow-lg shadow-purple-100 border border-purple-50 sticky top-0 relative overflow-hidden">
                            <div id="details-modal-strip-admin" class="absolute top-0 left-0 w-full h-2 bg-slate-200 transition-colors duration-300"></div>
                            
                            <!-- Header Section -->
                            <div class="flex items-center gap-2 mb-4 mt-2"> <!-- Reduced mb-6 to mb-4 -->
                                <span class="p-2 bg-purple-100 text-purple-600 rounded-xl">
                                    <svg width="20px" height="20px" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                                      <path fill-rule="evenodd" clip-rule="evenodd" d="M7.07095 0.650238C6.67391 0.650238 6.32977 0.925096 6.24198 1.31231L6.0039 2.36247C5.6249 2.47269 5.26335 2.62363 4.92436 2.81013L4.01335 2.23585C3.67748 2.02413 3.23978 2.07312 2.95903 2.35386L2.35294 2.95996C2.0722 3.2407 2.0232 3.6784 2.23493 4.01427L2.80942 4.92561C2.62307 5.2645 2.47227 5.62594 2.36216 6.00481L1.31209 6.24287C0.924883 6.33065 0.650024 6.6748 0.650024 7.07183V7.92897C0.650024 8.32601 0.924883 8.67015 1.31209 8.75794L2.36228 8.99603C2.47246 9.375 2.62335 9.73652 2.80979 10.0755L2.2354 10.9867C2.02367 11.3225 2.07267 11.7602 2.35341 12.041L2.95951 12.6471C3.24025 12.9278 3.67795 12.9768 4.01382 12.7651L4.92506 12.1907C5.26384 12.377 5.62516 12.5278 6.0039 12.6379L6.24198 13.6881C6.32977 14.0753 6.67391 14.3502 7.07095 14.3502H7.92809C8.32512 14.3502 8.66927 14.0753 8.75705 13.6881L8.99505 12.6383C9.37411 12.5282 9.73573 12.3773 10.0748 12.1909L10.986 12.7653C11.3218 12.977 11.7595 12.928 12.0403 12.6473L12.6464 12.0412C12.9271 11.7604 12.9761 11.3227 12.7644 10.9869L12.1902 10.076C12.3768 9.73688 12.5278 9.37515 12.638 8.99596L13.6879 8.75794C14.0751 8.67015 14.35 8.32601 14.35 7.92897V7.07183C14.35 6.6748 14.0751 6.33065 13.6879 6.24287L12.6381 6.00488C12.528 5.62578 12.3771 5.26414 12.1906 4.92507L12.7648 4.01407C12.9766 3.6782 12.9276 3.2405 12.6468 2.95975L12.0407 2.35366C11.76 2.07292 11.3223 2.02392 10.9864 2.23565L10.0755 2.80989C9.73622 2.62328 9.37437 2.47229 8.99505 2.36209L8.75705 1.31231C8.66927 0.925096 8.32512 0.650238 7.92809 0.650238H7.07095ZM4.92053 3.81251C5.44724 3.44339 6.05665 3.18424 6.71543 3.06839L7.07095 1.50024H7.92809L8.28355 3.06816C8.94267 3.18387 9.5524 3.44302 10.0794 3.81224L11.4397 2.9547L12.0458 3.56079L11.1882 4.92117C11.5573 5.44798 11.8164 6.0575 11.9321 6.71638L13.5 7.07183V7.92897L11.932 8.28444C11.8162 8.94342 11.557 9.55301 11.1878 10.0798L12.0453 11.4402L11.4392 12.0462L10.0787 11.1886C9.55192 11.5576 8.94241 11.8166 8.28355 11.9323L7.92809 13.5002H7.07095L6.71543 11.932C6.0569 11.8162 5.44772 11.5572 4.92116 11.1883L3.56055 12.046L2.95445 11.4399L3.81213 10.0794C3.4431 9.55266 3.18403 8.94326 3.06825 8.2845L1.50002 7.92897V7.07183L3.06818 6.71632C3.18388 6.05765 3.44283 5.44833 3.81171 4.92165L2.95398 3.561L3.56008 2.95491L4.92053 3.81251ZM9.02496 7.50008C9.02496 8.34226 8.34223 9.02499 7.50005 9.02499C6.65786 9.02499 5.97513 8.34226 5.97513 7.50008C5.97513 6.65789 6.65786 5.97516 7.50005 5.97516C8.34223 5.97516 9.02496 6.65789 9.02496 7.50008ZM9.92496 7.50008C9.92496 8.83932 8.83929 9.92499 7.50005 9.92499C6.1608 9.92499 5.07513 8.83932 5.07513 7.50008C5.07513 6.16084 6.1608 5.07516 7.50005 5.07516C8.83929 5.07516 9.92496 6.16084 9.92496 7.50008Z" fill="currentColor"/>
                                    </svg>
                                </span>
                                <h3 class="text-sm font-bold text-purple-700 uppercase tracking-wider">Admin Control</h3>
                            </div>

                            <!-- MOVED HERE: Admin Sticky Note Container (Under Header) -->
                            <div id="admin-sticky-note-container" class="mb-5 hidden"></div>
                            
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">สถานะ (Status)</label>
                                    <select id="details-modal-status-select" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-purple-400 block p-3 font-medium transition-smooth cursor-pointer hover:bg-white"></select>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">หน่วยงานที่รับผิดชอบ (Responsible Team)</label>
                                    <select id="details-modal-assign-select" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-purple-400 block p-3 transition-smooth cursor-pointer hover:bg-white"></select>
                                </div>

                                <div>
                                    <div class="flex justify-between items-center mb-2 ml-1">
                                        <label class="block text-xs font-bold text-slate-500">Admin Note</label>
                                        <!-- NEW: Quick Insert Button (Admin) -->
                                        <button type="button" id="btn-insert-template-admin" class="text-xs font-bold text-pink-500 hover:text-pink-600 flex items-center gap-1 bg-pink-50 px-2 py-0.5 rounded-lg border border-pink-100 hover:bg-pink-100 transition-colors" title="ข้อความสำเร็จรูป">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                            Quick Text
                                        </button>
                                    </div>
                                    <textarea id="details-modal-new-comment" rows="3" class="block p-3 w-full text-sm text-slate-700 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 transition-smooth" placeholder="บันทึกช่วยจำภายใน..."></textarea>
                                </div>

                                <button type="button" id="save-all-details-btn" class="w-full text-white bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 focus:ring-4 focus:ring-purple-200 font-bold rounded-xl text-sm px-5 py-3.5 mr-2 mb-2 focus:outline-none flex justify-center items-center gap-2 transition-smooth shadow-lg shadow-purple-200 mt-4 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <div class="btn-content">บันทึกการเปลี่ยนแปลง</div>
                                    <div class="spinner hidden"></div>
                                </button>
                                <p id="save-all-error" class="hidden text-xs text-red-500 mt-2 bg-red-50 p-2 rounded-lg border border-red-100 text-center"></p>
                                <p id="save-all-success" class="hidden text-xs text-green-600 mt-2 text-center font-bold bg-green-50 p-2 rounded-lg border border-green-100">บันทึกเรียบร้อย!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Drawer -->
    <div id="audit-log-modal" class="hidden fixed inset-0 z-[60] flex justify-end bg-slate-900/20 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-2xl h-full shadow-2xl flex flex-col border-l border-slate-100 transform transition-transform duration-300 ease-in-out">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-100 rounded-lg text-slate-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">System Audit Log</h3>
                        <p class="text-xs text-slate-400">ประวัติการทำงานของระบบ</p>
                    </div>
                </div>
                <button id="close-audit-log-modal-btn" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-smooth">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="audit-log-display-container" class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
                <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
                    <p id="audit-log-loading" class="text-center p-10 text-slate-500">Loading logs...</p>
                    <table id="audit-log-table" class="w-full text-left text-sm hidden">
                        <thead class="bg-slate-100 text-slate-500 sticky top-0 font-semibold uppercase text-xs tracking-wider border-b border-slate-200">
                            <tr><th class="px-6 py-4">Time</th><th class="px-6 py-4">User</th><th class="px-6 py-4">Action</th><th class="px-6 py-4">Details</th></tr>
                        </thead>
                        <tbody id="audit-log-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Modal -->
    <div id="date-range-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
            <div class="flex justify-between mb-6"><h3 class="font-bold text-lg text-slate-800">Custom Date Range</h3><button id="date-range-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button></div>
            <div class="space-y-4 mb-6">
                <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Start Date</label><input type="date" id="dateStartInput" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">End Date</label><input type="date" id="dateEndInput" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700"></div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="date-range-cancel-btn" class="px-5 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition-smooth">Cancel</button>
                <button id="date-range-apply-btn" class="px-5 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-smooth">Apply</button>
            </div>
        </div>
    </div>

    <!-- Public Comment Modal (With File Upload) -->
    <div id="public-comment-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/75 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
            <!-- Header with Gradient (NOW MODIFIED TO SOLID FOR CONSISTENCY) -->
            <div id="public-comment-header" class="px-8 py-6 bg-indigo-600 flex items-center gap-4">
                <div class="p-3 bg-white/20 backdrop-blur-sm rounded-xl text-white shadow-inner">
                     <svg id="public-comment-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                     <h3 id="public-comment-title" class="text-xl font-bold text-white">ยืนยันการปิดงาน</h3>
                     <p class="text-indigo-100 text-sm opacity-90">Verification Required</p>
                </div>
            </div>

            <!-- Body -->
            <div class="p-8 pt-6">
                <p class="text-slate-600 mb-6 leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-100">
                    คุณกำลังเปลี่ยนสถานะเป็น <span id="public-comment-status" class="font-bold text-indigo-600">...</span><br>
                    <span class="text-sm text-slate-500">กรุณากรอกข้อความถึงผู้แจ้ง (Public Note) เพื่อแจ้งผลการดำเนินการ:</span>
                </p>
                
                <!-- ADDED: Quick Insert Button (Public) -->
                <div class="flex justify-end mb-2">
                     <button type="button" id="btn-insert-template-public" class="text-xs font-bold text-pink-500 hover:text-pink-600 flex items-center gap-1 bg-pink-50 px-2 py-0.5 rounded-lg border border-pink-100 hover:bg-pink-100 transition-colors" title="ข้อความสำเร็จรูป">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Quick Text
                    </button>
                </div>
                
                <form id="publicCommentForm">
                    <div class="mb-4">
                        <textarea id="public-comment-textarea" rows="4" class="w-full p-4 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 mb-2 outline-none resize-none text-slate-700 bg-white shadow-inner" placeholder="เช่น ดำเนินการแก้ไขเรียบร้อยแล้ว..." required></textarea>
                    </div>

                    <!-- NEW FILE INPUT (Admin Upload) MOVED HERE -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 mb-2 ml-1">แนบรูปผลการดำเนินงาน (Attachments)</label>
                        <input type="file" id="details-modal-admin-file-input" multiple accept="image/*,application/pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-smooth">
                        <p class="text-[10px] text-slate-400 mt-1 ml-1">รองรับรูปภาพและ PDF (Max 5MB)</p>
                    </div>
                    
                    <p id="public-comment-error" class="hidden text-red-500 text-sm mb-4 font-bold bg-red-50 p-2 rounded-lg text-center"></p>
                    
                    <div class="flex justify-end gap-3 mt-2">
                        <button type="button" id="public-comment-cancel-btn" class="px-6 py-3 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-bold transition-smooth">ยกเลิก</button>
                        <button type="submit" id="public-comment-submit-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-200 transition-smooth flex items-center gap-2">
                            <span>ยืนยัน</span> <div class="spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
             <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-red-100 mb-6">
                <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันลบผู้ใช้?</h3>
            <p class="text-slate-500 mb-8">คุณต้องการลบ <span id="user-to-delete" class="font-bold text-slate-800"></span> ใช่หรือไม่?</p>
            <div class="flex justify-center gap-3">
                <button id="cancel-delete-btn" class="px-6 py-2.5 bg-slate-100 rounded-xl hover:bg-slate-200 font-bold text-slate-600">ยกเลิก</button>
                <button id="confirm-delete-btn" class="px-6 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 font-bold shadow-lg shadow-red-200">ลบ</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-6 text-slate-800">เปลี่ยนรหัสผ่าน: <span id="changePassModalUsername" class="text-indigo-600"></span></h3>
            <form id="changePasswordForm" class="space-y-4">
                <input type="hidden" id="usernameToChange">
                <input type="password" id="changePassNewPassword" placeholder="รหัสผ่านใหม่" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <input type="password" id="changePassConfirmPassword" placeholder="ยืนยันรหัสผ่าน" class="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="closeChangePassModal" class="px-5 py-2.5 bg-slate-100 rounded-xl hover:bg-slate-200 font-bold text-slate-600">ยกเลิก</button>
                    <button type="submit" id="changePassSubmitBtn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-200 flex items-center gap-2"><span id="changePassBtnText">ยืนยัน</span><div id="changePassSpinner" class="spinner hidden"></div></button>
                </div>
                <p id="change-pass-error" class="hidden text-red-500 text-sm text-center font-bold mt-2"></p>
                <p id="change-pass-success" class="hidden text-green-600 text-sm text-center font-bold mt-2"></p>
            </form>
        </div>
    </div>
    
    <!-- Session Expired Modal -->
    <div id="session-expired-modal" class="hidden fixed inset-0 z-[70] bg-slate-100 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white p-8 rounded-3xl text-center shadow-2xl max-w-sm w-full">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-amber-100 mb-6">
                <svg class="h-8 w-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Session หมดอายุ</h3>
            <p class="mb-8 text-slate-500">กรุณาเข้าสู่ระบบใหม่อีกครั้ง</p>
            <button id="session-expired-ok-btn" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 w-full">ตกลง</button>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-edit-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-5 border-b border-indigo-500 flex justify-between items-center bg-indigo-600 shadow-md flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        จัดการผู้ใช้งาน
                    </h3>
                    <p class="text-sm text-indigo-100 mt-1">User: <span id="user-edit-username" class="font-bold text-white underline decoration-indigo-400 underline-offset-2">...</span></p>
                </div>
                <button id="close-user-edit-modal" class="text-white/70 hover:text-white hover:bg-white/20 rounded-full p-1 transition-smooth">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="p-8 space-y-8 overflow-y-auto custom-scrollbar">
                <!-- User Status Toggle -->
                <div>
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        สถานะบัญชี (Account Status)
                    </h4>
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <div>
                            <span id="user-status-label" class="font-bold text-green-600">Active</span>
                            <p class="text-xs text-slate-400">อนุญาตให้เข้าใช้งานระบบ</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="user-edit-status-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                </div>

                <!-- Role Management -->
                <div>
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                        กำหนดสิทธิ์ (Role)
                    </h4>
                    <div class="flex gap-3">
                        <select id="user-edit-role-select" class="flex-1 border border-slate-200 bg-slate-50 p-2.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700 font-medium">
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                        <button id="user-edit-save-role-btn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md shadow-indigo-100 transition-smooth flex items-center gap-2 text-sm">
                            <span>บันทึก</span>
                            <div class="spinner hidden w-4 h-4 border-white"></div>
                        </button>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Team Management (New) -->
                <div>
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        สังกัดแผนก (Team)
                    </h4>
                    <div class="flex gap-3">
                        <input type="text" id="user-edit-team-input" list="teamList" autocomplete="off" placeholder="ระบุชื่อทีม" class="flex-1 border border-slate-200 bg-slate-50 p-2.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-slate-700 font-medium">
                        <button id="user-edit-save-team-btn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md shadow-indigo-100 transition-smooth flex items-center gap-2 text-sm">
                            <span>บันทึก</span>
                            <div class="spinner hidden w-4 h-4 border-white"></div>
                        </button>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Data Access (Allowed Types) - NEW SECTION -->
                <div>
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        สิทธิ์การเข้าถึงข้อมูล (Data Access)
                    </h4>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="flex items-center justify-between mb-3">
                             <p class="text-xs text-slate-500">เลือกประเภทข้อมูลที่อนุญาตให้มองเห็น (ปล่อยว่าง = เห็นทั้งหมด)</p>
                             <button id="user-edit-save-access-btn" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-sm text-xs transition-smooth flex items-center gap-1">
                                <span>บันทึก</span>
                                <div class="spinner hidden w-3 h-3 border-white"></div>
                            </button>
                        </div>
                        
                        <div class="flex flex-wrap gap-4" id="user-edit-allowed-types-container">
                            <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" value="คำร้องเรียน" class="allowed-type-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <span class="text-sm text-slate-700">คำร้องเรียน</span>
                            </label>
                            <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" value="ข้อเสนอแนะ" class="allowed-type-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <span class="text-sm text-slate-700">ข้อเสนอแนะ</span>
                            </label>
                            <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" value="แจ้งปัญหา" class="allowed-type-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <span class="text-sm text-slate-700">แจ้งปัญหา</span>
                            </label>
                        </div>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Dummy inputs to prevent browser autocomplete aggression -->
                <div style="height: 0; overflow: hidden; position: absolute; opacity: 0; pointer-events: none;">
                    <input type="text" name="fakeusernameremembered" tabindex="-1">
                    <input type="password" name="fakepasswordremembered" tabindex="-1">
                </div>

                <!-- Password Management -->
                <div>
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                        เปลี่ยนรหัสผ่าน (Change Password)
                    </h4>
                    <div class="space-y-3">
                        <input type="password" id="user-edit-new-pass" placeholder="รหัสผ่านใหม่" class="w-full border border-slate-200 p-2.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                        <div class="flex gap-3">
                            <input type="password" id="user-edit-confirm-pass" placeholder="ยืนยันรหัสผ่าน" class="flex-1 border border-slate-200 p-2.5 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                            <button id="user-edit-save-pass-btn" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 hover:text-indigo-600 transition-smooth flex items-center gap-2 text-sm whitespace-nowrap">
                                <span>เปลี่ยนรหัส</span>
                                <div class="spinner hidden w-4 h-4 border-indigo-600"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Danger Zone -->
                <div>
                      <h4 class="text-sm font-bold text-red-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        Danger Zone
                    </h4>
                    <div class="bg-red-50 border border-red-100 p-4 rounded-xl flex items-center justify-between">
                        <span class="text-sm text-red-600 font-medium">ลบผู้ใช้งานนี้ถาวร</span>
                        <button id="user-edit-delete-btn" class="px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg font-bold text-sm hover:bg-red-600 hover:text-white transition-smooth shadow-sm">
                            ลบผู้ใช้
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-8 right-8 bg-slate-800 text-white px-6 py-4 rounded-2xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 z-[100] flex items-center gap-4">
        <div class="bg-green-500 rounded-full p-1.5 shadow-lg shadow-green-900/50"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
        <span id="toast-message" class="font-bold tracking-wide">Success</span>
    </div>

    <!-- Global Datalist for Teams -->
    <datalist id="teamList"></datalist>

    <!-- NEW: Template Picker Modal -->
    <div id="template-picker-modal" class="hidden fixed inset-0 z-[70] bg-slate-900/40 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <!-- Changed max-w-sm to max-w-2xl for wider view -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[60vh] border border-white/20 transform transition-all scale-100">
            <!-- Header -->
            <div class="px-5 py-4 bg-indigo-600 border-b border-indigo-500 flex justify-between items-center shadow-md z-10">
                <h3 class="font-bold text-white text-lg flex items-center gap-2"> <!-- Increased text size slightly -->
                    <svg class="w-6 h-6 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    เลือกข้อความตอบกลับ (Templates)
                </h3>
                <button id="closeTemplatePickerBtn" class="text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-1.5 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- List -->
            <div id="template-picker-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar bg-slate-50">
                <!-- List items injected here -->
            </div>
        </div>
    </div>

    <?!= HtmlService.createHtmlOutputFromFile('admin_script.html').getContent(); ?>
</body>
</html>